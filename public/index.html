<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Business Observability Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Fallback CSS in case Tailwind CDN fails
    if (!window.tailwind) {
      const fallbackCSS = `
        body { background: #181A20; color: white; font-family: Arial, sans-serif; margin: 0; padding: 20px; }
        .bg-dtdark { background: #181A20; }
        .text-white { color: white; }
        .min-h-screen { min-height: 100vh; }
        .fixed { position: fixed; }
        .p-4 { padding: 1rem; }
        .bg-dtcard { background: #22242A; }
        .border { border: 1px solid #2D2D2D; }
        .rounded { border-radius: 0.25rem; }
        .text-dtcyan { color: #00D4FF; }
        .bg-dtgreen { background: #73BE28; }
        .hover\\:bg-green-700:hover { background: #15803d; }
        .transition-all { transition: all 0.3s; }
        .grid { display: grid; }
        .gap-4 { gap: 1rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-6 { padding: 1.5rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: bold; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .cursor-pointer { cursor: pointer; }
        .disabled\\:opacity-50:disabled { opacity: 0.5; }
      `;
      const style = document.createElement('style');
      style.textContent = fallbackCSS;
      document.head.appendChild(style);
    }
    
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dtpurple: '#6C2C9C', dtblue: '#00A1C9', dtcyan: '#00D4FF', dtgreen: '#73BE28', dtorange: '#FFA86B', dtyellow: '#FFD23F', dtdark: '#181A20', dtgray: '#23272F', dtcard: '#22242A', dtaccent: '#FFD23F', dtborder: '#2D2D2D'
          },
          boxShadow: {
            glow: '0 0 20px rgba(0, 212, 255, 0.5)',
            card: '0 4px 24px rgba(0,0,0,0.12), 0 1.5px 4px rgba(0,212,255,0.08)'
          },
          fontFamily: {
            sans: ['Inter', 'Roboto', 'Arial', 'sans-serif']
          }
        }
      }
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    .node { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .node:hover { transform: scale(1.03); box-shadow: 0 0 30px rgba(0,212,255,0.6); }
    .connector { position:absolute; width:2px; background: linear-gradient(180deg, #00D4FF, transparent); animation: pulse 2s infinite; }
    @keyframes pulse { 0%{opacity:.5} 50%{opacity:1} 100%{opacity:.5} }
    
    /* Sidebar Animations */
    #mainContent { margin-left: 0 !important; }
    #mainContent.sidebar-open { margin-left: 320px !important; }
    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 45; }
    
    /* Prompt Cache Styles */
    .prompt-cache-indicator { 
      background: linear-gradient(45deg, #6C2C9C, #00A1C9); 
      animation: shimmer 2s infinite; 
    }
    @keyframes shimmer { 0%{background-position: -200px 0;} 100%{background-position: 200px 0;} }
    @keyframes fade-in { 
      0% { opacity: 0; transform: scale(0.9) translateY(-20px); } 
      100% { opacity: 1; transform: scale(1) translateY(0); } 
    }
    .animate-fade-in { animation: fade-in 0.3s ease-out; }
    
    /* Tab System Styles */
    .tab-button {
      background: transparent;
      color: #9CA3AF;
      border: none;
      cursor: pointer;
    }
    .tab-button:hover {
      color: #00D4FF;
      background: rgba(0, 212, 255, 0.1);
    }
    .tab-button.active {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      color: black;
      font-weight: bold;
      border-color: #4ECDC4 !important;
      box-shadow: 0 8px 32px rgba(78, 205, 196, 0.3);
    }

    .tab-button.active .w-8 {
      background: linear-gradient(135deg, #000, #333) !important;
      color: white !important;
    }

    .tab-button.completed .w-8 {
      background: linear-gradient(135deg, #4ECDC4, #44A08D) !important;
      color: black !important;
    }

    .tab-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 20px rgba(78, 205, 196, 0.2);
    }

    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }

    /* Enhanced form styling */
    .form-input-enhanced {
      background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
      border: 2px solid #4ECDC4;
      border-radius: 12px;
      color: white;
      padding: 16px 20px;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
    }

    .form-input-enhanced:focus {
      border-color: #7B68EE;
      box-shadow: 0 0 0 3px rgba(123, 104, 238, 0.2), inset 0 2px 10px rgba(0,0,0,0.3);
      transform: translateY(-1px);
    }

    .btn-enhanced {
      background: linear-gradient(135deg, #4ECDC4, #44A08D);
      border: none;
      border-radius: 12px;
      color: black;
      font-weight: bold;
      padding: 16px 32px;
      font-size: 18px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(78, 205, 196, 0.3);
      cursor: pointer;
    }

    .btn-enhanced:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(78, 205, 196, 0.4);
      background: linear-gradient(135deg, #7B68EE, #6A5ACD);
      color: white;
    }

    /* Enhanced animations */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }

    @keyframes slideInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .tab-pane.active {
      animation: slideInUp 0.5s ease-out;
    }

    /* Card hover effects */
    .group:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }

    /* Progress line gradient animation */
    #progress-line {
      background: linear-gradient(90deg, #4ECDC4, #7B68EE, #4ECDC4);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
    }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    /* Data Mode Button Styles */
    .data-mode-btn {
      background: transparent;
      color: #9CA3AF;
      border: none;
      cursor: pointer;
    }
    .data-mode-btn:hover {
      color: #00D4FF;
      background: rgba(0, 212, 255, 0.1);
    }
    .data-mode-btn.active {
      background: #00D4FF;
      color: #000;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      #mainContent.sidebar-open { margin-left: 0 !important; }
      #savedPromptsSidebar { width: 100vw !important; }
      .tab-button {
        font-size: 12px;
        padding: 8px 12px !important;
      }
    }
  </style>
</head>
<body class="bg-dtdark text-white min-h-screen">
  <!-- Saved Prompts Sidebar -->
  <div id="savedPromptsSidebar" class="fixed left-0 top-0 h-full w-80 bg-dtcard border-r border-dtborder shadow-xl z-50 transform -translate-x-full transition-transform duration-300">
    <div class="flex items-center justify-between p-4 border-b border-dtborder">
      <h2 class="text-lg font-bold text-dtcyan">ğŸ’¾ Saved Prompts</h2>
      <button id="closeSidebar" class="text-gray-400 hover:text-dtcyan hover:bg-dtgray rounded-lg p-2 transition-all duration-200 transform hover:scale-110" title="Close saved prompts panel">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>
    
    <div class="p-4">
      <!-- Save Current Prompt Section -->
      <div class="mb-6 p-3 bg-dtgray bg-opacity-40 rounded-lg border border-dtcyan">
        <h3 class="text-base font-bold text-dtcyan mb-2">ğŸ’¾ Save Current Configuration</h3>
        <input id="savePromptName" placeholder="Give this prompt a name..." class="w-full p-3 mb-2 rounded-lg bg-dtgray text-white border border-dtcyan focus:ring-2 focus:ring-dtcyan text-sm" />
        <button id="saveCurrentPrompt" onclick="window.saveCurrentConfiguration()" class="w-full bg-dtgreen text-black px-4 py-3 rounded-lg font-bold hover:bg-dtcyan transition-all text-sm">ğŸ’¾ Save Current State</button>
        <div id="saveStatus" class="mt-2 text-xs text-center hidden">
          <span class="text-dtcyan">â˜ï¸ Saving to server...</span>
        </div>
      </div>
      
      <!-- Saved Prompts List -->
      <div class="mb-4">
        <h3 class="text-sm font-semibold text-dtcyan mb-2">ğŸ“‹ Your Saved Prompts</h3>
        <div id="savedPromptsList" class="space-y-2 max-h-96 overflow-y-auto">
          <!-- Saved prompts will be populated here -->
        </div>
      </div>
      
      <!-- Management Buttons -->
      <div class="grid grid-cols-2 gap-2 mb-2">
        <button id="exportPrompts" class="bg-dtpurple text-white px-4 py-3 rounded-lg font-bold hover:bg-dtcyan transition-all text-sm">ğŸ“¤ Export</button>
        <button id="importPrompts" class="bg-dtgreen text-black px-4 py-3 rounded-lg font-bold hover:bg-green-600 transition-all text-sm">ğŸ“¥ Import</button>
      </div>
      <div class="mb-4">
        <button id="clearAllPrompts" class="w-full bg-red-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-red-700 transition-all text-sm">ğŸ—‘ï¸ Clear All</button>
      </div>
      
      <!-- Quick Help -->
      <div class="text-sm text-gray-400 bg-dtgray bg-opacity-30 rounded p-3 border border-gray-600">
        <p class="font-bold text-gray-300 mb-2">ğŸ’¡ Quick Tips:</p>
        <p>â€¢ <span class="text-dtcyan">Ctrl+S</span>: Quick Save</p>
        <p>â€¢ <span class="text-dtcyan">Ctrl+Shift+S</span>: Named Save</p>
        <p>â€¢ Click any saved prompt to load it</p>
        <p>â€¢ <span class="text-dtcyan">ğŸ“„</span> button: Duplicate prompt</p>
        <p>â€¢ Auto-saves: Limited to last 5</p>
        <p>â€¢ Export/Import: Share prompts</p>
      </div>
    </div>
  </div>

  <!-- Sidebar Toggle Button -->
  <button id="toggleSidebar" class="fixed left-4 top-4 z-40 bg-dtcard border border-dtcyan rounded-lg p-3 shadow-lg hover:bg-dtgray transition-all">
    <svg class="w-6 h-6 text-dtcyan" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
    </svg>
  </button>

  <!-- Main Content -->
  <div id="mainContent" class="transition-all duration-300">
    <div class="max-w-[2000px] mx-auto px-6 py-4 font-sans">
      <header class="flex items-center justify-between mb-6 p-4 rounded-xl bg-gradient-to-r from-dtpurple/10 to-dtcyan/10 border border-dtcyan/20">
        <div class="flex items-center space-x-4">
          <div class="p-2 rounded-lg bg-dtcyan/20 border border-dtcyan">
            <span class="text-2xl">ğŸ¢</span>
          </div>
          <div>
            <h1 class="text-3xl font-extrabold text-dtcyan tracking-tight drop-shadow">Business Observability Generator</h1>
            <p class="text-sm text-gray-300 mt-1">AI-powered customer journey simulation & performance testing</p>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <div class="px-3 py-1 rounded-full bg-dtgreen/20 border border-dtgreen text-dtgreen text-xs font-medium">
            âœ… READY
          </div>
          <span id="host-label" class="text-sm text-dtaccent font-medium px-3 py-1 rounded-full bg-dtpurple/20 border border-dtpurple">Smartscape UI Â· Real-time overlays</span>
        </div>
      </header>

      <!-- Service Status Dropdown - Top Right Corner -->
      <div class="fixed top-4 right-4 z-50">
        <div class="relative">
          <button id="services-dropdown-btn" onclick="toggleServicesDropdown()" class="bg-dtcard hover:bg-dtgray border border-dtborder rounded-lg px-3 py-2 text-sm font-medium text-white shadow-lg transition-all flex items-center gap-2">
            <span class="text-dtcyan">âš™ï¸</span>
            <span id="services-count">Services</span>
            <span class="text-xs">â–¼</span>
          </button>
          
          <div id="services-dropdown" class="absolute right-0 top-12 bg-dtcard border border-dtborder rounded-lg shadow-xl w-96 max-w-screen-sm hidden z-50">
            <div class="p-4 border-b border-dtborder flex items-center justify-between">
              <h3 class="text-sm font-semibold text-dtcyan flex items-center">
                <span class="w-2 h-2 bg-dtcyan rounded-full mr-2 animate-pulse"></span>
                Running Services
              </h3>
              <button onclick="updateServiceStatus()" class="bg-dtgray hover:bg-dtcyan text-white hover:text-black rounded-lg px-3 py-1.5 text-xs font-medium transition-all duration-200 flex items-center" title="Refresh service status">
                <span class="mr-1">ğŸ”„</span>
                Refresh
              </button>
            </div>
            
            <div class="p-4 max-h-96 overflow-y-auto">
              <div id="service-status-loading-dropdown" class="text-center text-gray-400 text-sm py-8">
                <div class="animate-spin w-6 h-6 border-2 border-dtcyan border-t-transparent rounded-full mx-auto mb-2"></div>
                Loading services...
              </div>
              <div id="service-status-list-dropdown" class="hidden space-y-3"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="mb-8">
        <div class="relative">
          <!-- Progress Line -->
          <div class="absolute top-6 left-0 right-0 h-0.5 bg-dtgray z-0"></div>
          <div id="progress-line" class="absolute top-6 left-0 h-0.5 bg-gradient-to-r from-dtcyan to-dtpurple z-0 transition-all duration-500" style="width: 20%;"></div>
          
          <nav class="relative flex justify-between z-10">
            <button class="tab-button active flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border-2 border-dtcyan shadow-lg" data-tab="welcome">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtcyan text-black font-bold text-sm">ğŸ </div>
              <span class="text-xs font-medium text-center">Welcome</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step1">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">1</div>
              <span class="text-xs font-medium text-center">Customer<br>Details</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step2">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">2</div>
              <span class="text-xs font-medium text-center">Generate<br>Prompts</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step3">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">3</div>
              <span class="text-xs font-medium text-center">Process<br>Check</span>
            </button>
            <button class="tab-button flex flex-col items-center space-y-2 px-4 py-3 rounded-xl transition-all duration-200 bg-dtcard border border-dtgray hover:border-dtcyan" data-tab="step4">
              <div class="flex items-center justify-center w-8 h-8 rounded-full bg-dtgray text-white font-bold text-sm">4</div>
              <span class="text-xs font-medium text-center">Generate<br>Data</span>
            </button>
          </nav>
        </div>
      </div>

      <!-- Tab Content Container -->
      <div id="tabContent" class="min-h-[600px]">
        
        <!-- Welcome Tab -->
        <div class="tab-pane active" id="welcome-tab">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: App Overview -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ¯ Application Overview</h2>
              <div class="space-y-4 text-gray-300">
                <p class="text-lg"><strong class="text-dtcyan">Business Observability Generator</strong> creates realistic customer journey scenarios for performance testing and business intelligence demonstrations.</p>
                
                <div class="bg-dtpurple bg-opacity-20 rounded-lg p-4 border border-dtpurple">
                  <h3 class="text-dtcyan font-semibold mb-2">ğŸ”§ Core Functionality</h3>
                  <ul class="space-y-2 text-sm">
                    <li>â€¢ <strong>AI-Generated Journeys:</strong> Create realistic customer paths using Copilot prompts</li>
                    <li>â€¢ <strong>Business Intelligence:</strong> Generate revenue metrics, KPIs, and competitive insights</li>
                    <li>â€¢ <strong>Performance Testing:</strong> LoadRunner integration with customizable load profiles</li>
                    <li>â€¢ <strong>Real-time Simulation:</strong> Execute customer journeys with Dynatrace correlation</li>
                    <li>â€¢ <strong>Error Simulation:</strong> Toggle realistic errors for comprehensive testing scenarios</li>
                  </ul>
                </div>
              </div>
            </div>

            <!-- Right Column: Business Use Cases -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ’¼ Business Use Cases</h2>
              <div class="space-y-4">
                
                <div class="bg-dtgreen bg-opacity-20 rounded-lg p-4 border border-dtgreen">
                  <h3 class="text-dtgreen font-semibold mb-2">ğŸ›ï¸ E-Commerce Scenarios</h3>
                  <p class="text-sm text-gray-300">Simulate customer shopping experiences, cart abandonment, payment processing, and seasonal traffic patterns with realistic revenue data.</p>
                </div>

                <div class="bg-dtblue bg-opacity-20 rounded-lg p-4 border border-dtblue">
                  <h3 class="text-dtblue font-semibold mb-2">ğŸ¢ Enterprise Applications</h3>
                  <p class="text-sm text-gray-300">Test B2B workflows, employee onboarding systems, CRM interactions, and resource management platforms under load.</p>
                </div>

                <div class="bg-dtyellow bg-opacity-20 rounded-lg p-4 border border-dtyellow">
                  <h3 class="text-dtyellow font-semibold mb-2">ğŸ“± Digital Services</h3>
                  <p class="text-sm text-gray-300">Validate SaaS platforms, mobile app backends, API performance, and multi-tenant architectures with business metrics.</p>
                </div>

                <div class="bg-dtpurple bg-opacity-20 rounded-lg p-4 border border-dtpurple">
                  <h3 class="text-dtpurple font-semibold mb-2">ğŸ¯ Demo Environments</h3>
                  <p class="text-sm text-gray-300">Create compelling demonstrations with realistic business data, competitive analysis, and industry-specific KPIs for stakeholder presentations.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Getting Started Section -->
          <div class="mt-6 p-6 rounded-2xl bg-gradient-to-r from-dtcyan/10 to-dtpurple/10 border border-dtcyan">
            <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸš€ Getting Started</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ¤–</div>
                <h3 class="font-semibold text-dtcyan mb-2">1. Generate AI Prompts</h3>
                <p class="text-sm text-gray-300">Start with company details to create intelligent Copilot prompts</p>
              </div>
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ¯</div>
                <h3 class="font-semibold text-dtcyan mb-2">2. Build Customer Journey</h3> 
                <p class="text-sm text-gray-300">Use AI-generated prompts to create realistic business workflows</p>
              </div>
              <div class="text-center">
                <div class="text-3xl mb-2">ğŸ“Š</div>
                <h3 class="font-semibold text-dtcyan mb-2">3. Test & Simulate</h3>
                <p class="text-sm text-gray-300">Execute load tests and customer simulations with business intelligence</p>
              </div>
            </div>
            <div class="mt-6 text-center">
              <button onclick="switchTab('step1')" class="bg-dtcyan hover:bg-dtpurple text-black hover:text-white font-bold px-6 py-3 rounded-lg transition-all duration-200">
                Start Building Your Journey â†’
              </button>
            </div>
          </div>
        </div>

        <!-- Step 1 Tab -->
        <div class="tab-pane" id="step1-tab">
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
            <!-- Left Column: Journey Generator -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ‘¤ Step 1 - Customer Details</h2>
              
              <form id="journey-form" class="space-y-6">
                <div class="space-y-2">
                  <label for="companyName" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtcyan text-black rounded-full mr-3 text-sm font-bold">ğŸ¢</span>
                    Company Name
                  </label>
                  <input id="companyName" class="form-input-enhanced w-full" name="customer" placeholder="e.g., ShopMart, TechCorp, HealthPlus" />
                  <p class="text-sm text-gray-400 mt-2 ml-11">Enter the company name for your business scenario</p>
                </div>
                
                <div class="space-y-2">
                  <label for="domain" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtpurple text-white rounded-full mr-3 text-sm font-bold">ğŸŒ</span>
                    Website Domain
                  </label>
                  <input id="domain" class="form-input-enhanced w-full" name="website" placeholder="e.g., shopmart.com, techcorp.io" />
                  <p class="text-sm text-gray-400 mt-2 ml-11">Website domain for the customer journey simulation</p>
                </div>

                <div class="space-y-2">
                  <label for="journeyRequirements" class="block text-lg font-bold text-dtcyan mb-3 flex items-center">
                    <span class="flex items-center justify-center w-8 h-8 bg-dtgreen text-black rounded-full mr-3 text-sm font-bold">ğŸ¯</span>
                    Journey Requirements
                  </label>
                  <textarea id="journeyRequirements" class="form-input-enhanced w-full h-24 resize-y" name="requirements" placeholder="e.g., Order journey from website to delivery, Banking loan application process, Healthcare appointment booking flow"></textarea>
                  <p class="text-sm text-gray-400 mt-2 ml-11">Describe the specific customer journey scenario you want to simulate</p>
                </div>
            
                
                <div class="pt-6">
                  <button type="button" onclick="validateAndProceed()" class="btn-enhanced w-full">
                    <span class="flex items-center justify-center">
                      Next: Generate Prompts 
                      <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                      </svg>
                    </span>
                  </button>
                </div>
              </form>
            </div>
            
            <!-- Right Column: Instructions -->
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h3 class="text-xl mb-3 text-dtcyan font-bold">ğŸ“‹ What We'll Create</h3>
              <div class="space-y-4">
                <div class="p-4 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
                  <h4 class="text-dtblue font-semibold mb-2">ğŸ¤– AI-Generated Journey</h4>
                  <ul class="text-sm text-gray-300 space-y-1">
                    <li>â€¢ Realistic customer interaction patterns</li>
                    <li>â€¢ Business intelligence and revenue metrics</li>
                    <li>â€¢ Industry-specific journey steps</li>
                    <li>â€¢ Performance testing configurations</li>
                  </ul>
                </div>
                
                <div class="p-4 bg-dtyellow bg-opacity-20 rounded-lg border border-dtyellow">
                  <h4 class="text-dtyellow font-semibold mb-2">ğŸš€ Next Steps</h4>
                  <p class="text-sm text-gray-300">We'll generate tailored Copilot prompts that you can use to create realistic business scenarios.</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 2 Tab - Generate Prompts -->
        <div class="tab-pane" id="step2-tab">
          <div class="max-w-6xl mx-auto">
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">ğŸ¤– Step 2 - Generate Prompts</h2>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Generated Prompts -->
                <div class="space-y-4">
                  <div class="p-3 bg-dtpurple bg-opacity-20 rounded-lg border border-dtpurple mb-4">
                    <p class="text-sm text-gray-300">
                      <strong>ğŸ“‹ Instructions:</strong> Copy each prompt below to Copilot Chat, then return to paste the JSON response.
                    </p>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Copilot Prompt 1 - C-suite Analysis</h4>
                      <div class="flex gap-2"><button onclick="copyToClipboard('promptText1')" class="text-xs bg-dtpurple text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all">ğŸ“‹ Copy</button><button onclick="openCopilotEditor('promptText1-step2')" class="text-xs bg-dtblue text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                    </div>
                    <textarea id="promptText1-step2" readonly class="w-full h-32 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono resize-y"></textarea>
                  </div>
                  
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Copilot Prompt 2 - Customer Journey</h4>
                      <div class="flex gap-2"><button onclick="copyToClipboard('promptText2')" class="text-xs bg-dtpurple text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all">ğŸ“‹ Copy</button><button onclick="openCopilotEditor('promptText2-step2')" class="text-xs bg-dtblue text-white px-2 py-1 rounded hover:bg-dtcyan hover:text-black transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                    </div>
                    <textarea id="promptText2-step2" readonly class="w-full h-32 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono resize-y"></textarea>
                  </div>
                  
                  <div class="p-3 bg-dtgreen bg-opacity-20 rounded-lg border border-dtgreen">
                    <p class="text-sm text-dtgreen font-semibold mb-1">âœ… Ready to Copy</p>
                    <p class="text-xs text-gray-300">Both prompts have been generated and are ready to use with Copilot Chat.</p>
                  </div>
                </div>
                
                <!-- Right Column: Response Input -->
                <div class="space-y-4">
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <h4 class="text-base font-bold text-white">Paste Copilot's Response</h4>
                      <button onclick="loadTestJSON()" class="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 transition-all">ğŸ“ Load Test Data</button>
                    </div>
                    <div class="relative"><textarea id="copilotResponse-step2" placeholder="After running the prompts in Copilot Chat, paste the JSON response here..." class="w-full h-64 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono pr-20" onchange="checkResponseInput()"></textarea><button onclick="openCopilotEditor('copilotResponse-step2')" class="absolute top-2 right-2 bg-dtblue hover:bg-dtcyan text-white hover:text-black px-3 py-1 rounded text-xs font-medium transition-all" title="Open in larger editor window">ğŸ“ Edit</button></div>
                  </div>
                  
                  <div class="space-y-2">
                    <button id="processJourneyResponse" onclick="processJourneyResponse(); switchTab('step3');" class="bg-dtgreen text-black px-6 py-3 rounded-lg text-base font-bold shadow-card hover:bg-dtcyan transition-all w-full" disabled>
                      âš¡ Process Response & Continue â†’
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <button onclick="switchTab('step1')" class="bg-dtgray text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtpurple transition-all">
                        â† Back to Details
                      </button>
                      <button onclick="switchTab('step3')" class="bg-dtpurple text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtcyan hover:text-black transition-all">
                        Skip to Process â†’
                      </button>
                    </div>
                  </div>
                  
                  <div class="p-3 bg-dtyellow bg-opacity-20 rounded-lg border border-dtyellow">
                    <p class="text-sm text-dtyellow font-semibold mb-1">ğŸ’¡ Tip</p>
                    <p class="text-xs text-gray-300">Use both prompts in sequence for best results. The C-suite analysis provides context for the customer journey generation.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3 Tab - Process Check -->
        <div class="tab-pane" id="step3-tab">
          <div class="max-w-6xl mx-auto">
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <h2 class="text-2xl mb-4 text-dtcyan font-bold tracking-tight">âš¡ Step 3 - Process Check</h2>
              
              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Left Column: Journey Data -->
                <div class="space-y-4">
                  <div>
                    <h4 class="text-base font-bold text-white mb-2">Processed Journey Data</h4>
                    <pre id="journey-output-step3" class="w-full h-64 p-3 border border-dtcyan rounded-lg bg-black text-white text-sm font-mono overflow-auto">Processed journey data will appear here after Step 2...</pre>
                  </div>
                  
                  <div class="grid grid-cols-2 gap-4">
                    <div class="p-3 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
                      <h5 class="text-dtblue font-semibold text-sm mb-1">Journey Steps</h5>
                      <p id="step-count" class="text-lg font-bold text-white">0</p>
                      <p class="text-xs text-gray-400">Customer touchpoints</p>
                    </div>
                    <div class="p-3 bg-dtgreen bg-opacity-20 rounded-lg border border-dtgreen">
                      <h5 class="text-dtgreen font-semibold text-sm mb-1">Business Fields</h5>
                      <p id="field-count" class="text-lg font-bold text-white">0</p>
                      <p class="text-xs text-gray-400">Revenue & KPI metrics</p>
                    </div>
                  </div>
                </div>
                
                <!-- Right Column: Configuration & Fields -->
                <div class="space-y-4">
                  <div>
                    <h4 class="text-base font-bold text-white mb-2">Configuration Options</h4>
                    
                    <!-- Error Simulation Toggle -->
                    <div class="flex items-center justify-between p-3 bg-dtgray rounded-lg mb-3">
                      <div class="flex-1">
                        <div class="flex items-center gap-2">
                          <span class="text-white font-medium">Error Simulation</span>
                          <span id="errorToggleStatus" class="px-2 py-1 rounded bg-dtgreen text-black font-semibold text-xs">ON</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1">Toggle realistic errors in journey steps based on errorHint data</p>
                      </div>
                      <label class="relative inline-flex items-center cursor-pointer ml-3">
                        <input type="checkbox" id="errorSimulationToggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-dtcyan rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-dtcyan"></div>
                      </label>
                    </div>
                  </div>
                  
                  <div>
                    <h4 class="text-base font-bold text-white mb-2">Generated Fields Preview</h4>
                    <div id="generated-fields-preview" class="max-h-40 overflow-y-auto p-3 bg-dtgray rounded-lg text-sm">
                      <p class="text-gray-400 text-center">Field data will appear after processing journey response</p>
                    </div>
                  </div>
                  
                  <div class="space-y-2">
                    <button onclick="switchTab('step4')" class="bg-dtgreen text-black px-6 py-3 rounded-lg text-base font-bold shadow-card hover:bg-dtcyan transition-all w-full">
                      ğŸ“Š Continue to Generate Data â†’
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <button onclick="switchTab('step2')" class="bg-dtgray text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtpurple transition-all">
                        â† Back to Prompts
                      </button>
                      <button onclick="validateProcessing()" class="bg-dtblue text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-dtcyan hover:text-black transition-all">
                        ğŸ” Validate Data
                      </button>
                    </div>
                  </div>
                  
                  <div class="p-3 bg-dtyellow bg-opacity-20 rounded-lg border border-dtyellow">
                    <h5 class="text-dtyellow font-semibold mb-2">ğŸ¯ Business Intelligence</h5>
                    <p class="text-xs text-gray-400">Generated journey includes revenue metrics, KPIs, and competitive insights for realistic demos.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 4 Tab - Generate Data -->
        <div class="tab-pane" id="step4-tab">
          <div class="max-w-6xl mx-auto">
            <div class="p-6 rounded-2xl bg-dtcard border border-dtborder shadow-card">
              <div class="flex items-center justify-between mb-4"><h2 class="text-2xl text-dtcyan font-bold tracking-tight">ğŸ“Š Step 4 - Generate Data</h2><button onclick="startNewCustomerJourney()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold shadow-card transition-all" title="Reset everything and start a new customer journey">ğŸ”„ New Customer Journey</button></div>
              
              <div class="mb-6">
                <div class="flex rounded-lg bg-dtgray p-1">
                  <button onclick="showDataMode('single')" class="data-mode-btn active flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all duration-200" data-mode="single">
                    ğŸ¯ Single Simulation
                  </button>
                  <button onclick="showDataMode('loadrunner')" class="data-mode-btn flex-1 px-4 py-2 text-sm font-medium rounded-md transition-all duration-200" data-mode="loadrunner">
                    ğŸï¸ LoadRunner Testing
                  </button>
                </div>
              </div>
              
              <!-- Single Simulation Mode -->
              <div id="single-mode" class="data-mode-content">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸš€ Journey Simulation</h4>
                    
                    <div class="p-3 bg-dtblue bg-opacity-20 rounded-lg border border-dtblue">
                      <h5 class="text-dtblue font-semibold mb-2">Real Customer Journey</h5>
                      <p class="text-xs text-gray-400">Executes realistic customer interactions with Dynatrace correlation headers and business metrics.</p>
                    </div>
                    
                    <button id="run-journey-simulation-step4" onclick="runJourneySimulation(); updateSimulationStatus('Running customer journey simulation...');" class="w-full bg-dtgreen hover:bg-dtcyan text-black font-bold rounded-lg p-4 shadow-card transition-all text-lg">
                      ğŸš€ Run Single Journey Simulation
                    </button>
                    
                    <div id="simulation-status-step4" class="p-3 bg-dtgray rounded-lg text-sm">
                      Ready to run simulation with current journey configuration
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸ“ˆ Live Results</h4>
                    <div id="simulation-results-step4" class="p-3 bg-dtgray rounded-lg text-sm h-64 overflow-auto">
                      <div class="text-center text-gray-400 mt-8">
                        <div class="text-2xl mb-2">ğŸ“Š</div>
                        <p>Simulation results will appear here</p>
                        <p class="text-xs mt-2">Including: Response times, business metrics, Dynatrace traces, and error scenarios</p>
                      </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2">
                      <button onclick="clearSimulationResults()" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded px-3 py-2 text-sm transition-all">
                        ğŸ—‘ï¸ Clear Results
                      </button>
                      <button onclick="exportSimulationResults()" class="bg-dtpurple hover:bg-dtcyan text-white hover:text-black font-bold rounded px-3 py-2 text-sm transition-all">
                        ğŸ“ Export Results
                      </button>
                    </div>
                  </div>
                  

                </div>
              </div>
              
              <!-- LoadRunner Testing Mode -->
              <div id="loadrunner-mode" class="data-mode-content" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸï¸ LoadRunner Configuration</h4>
                    
                    <div>
                      <label class="block text-sm font-semibold text-dtcyan mb-2">Load Profile</label>
                      <select id="loadrunner-profile" class="w-full p-3 rounded-lg bg-dtgray text-white border border-dtcyan focus:ring-2 focus:ring-dtcyan">
                        <option value="light">Light Load (10 users, 2 min)</option>
                        <option value="moderate">Moderate Load (25 users, 5 min)</option>
                        <option value="heavy">Heavy Load (50 users, 10 min)</option>
                      </select>
                    </div>
                    
                    <div>
                      <label class="block text-sm font-semibold text-dtcyan mb-2">Duration (minutes)</label>
                      <input id="loadrunner-duration" class="w-full p-3 rounded-lg bg-dtgray text-white border border-dtcyan" type="number" min="1" max="60" value="5">
                    </div>
                    
                    <button id="start-loadrunner-test" onclick="startLoadRunnerTest()" class="w-full bg-dtpurple hover:bg-dtcyan text-white hover:text-black font-bold rounded-lg p-4 shadow-card transition-all text-lg">
                      ğŸš€ Start LoadRunner Test
                    </button>
                    
                    <div class="p-3 bg-dtpurple bg-opacity-20 rounded-lg border border-dtpurple">
                      <h5 class="text-dtpurple font-semibold mb-2">Performance Testing</h5>
                      <p class="text-xs text-gray-400">Execute high-scale load testing with realistic user behavior patterns and business scenarios.</p>
                    </div>
                  </div>
                  
                  <div class="space-y-4">
                    <h4 class="text-lg font-bold text-white mb-2">ğŸ“Š Test Status & Results</h4>
                    <div id="loadrunner-status" class="p-3 bg-dtgray rounded-lg text-sm">
                      Ready to start load test
                    </div>
                    
                    <div id="loadrunner-results" class="hidden">
                      <div class="p-3 bg-dtcard rounded-lg border border-dtcyan">
                        <h5 class="text-dtcyan font-semibold mb-2">Test Summary</h5>
                        <div id="loadrunner-summary" class="text-sm space-y-1"></div>
                        
                        <div class="mt-3 flex gap-2">
                          <button id="view-loadrunner-results" onclick="viewLoadRunnerResults()" class="bg-dtgreen hover:bg-dtcyan text-black font-bold rounded px-3 py-2 text-sm transition-all">
                            ğŸ“Š View Detailed Results
                          </button>
                          <button id="stop-loadrunner-test" onclick="stopLoadRunnerTest()" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded px-3 py-2 text-sm transition-all">
                            â¹ï¸ Stop Test
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Navigation -->
              <div class="mt-6 flex justify-between">
                <button onclick="switchTab('step3')" class="bg-dtgray text-white px-6 py-3 rounded-lg text-base font-medium hover:bg-dtpurple transition-all">
                  â† Back to Process Check
                </button>
                <div class="text-center">
                  <p class="text-sm text-gray-400 mb-2">ğŸ‰ Journey Complete!</p>
                  <p class="text-xs text-gray-400">You can now generate realistic customer data and business scenarios</p>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    </div>
  </div>
    </section>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const ioClient = io();
    const journeyForm = document.getElementById('journey-form');
    const journeyOutput = document.getElementById('journey-output');
    const journeySources = document.getElementById('journey-sources');
    const journeyProvider = document.getElementById('journey-provider');
    const simulateForm = document.getElementById('simulate-form');
    
    console.log('ğŸ” DOM elements found:');
    console.log('- journeyForm:', !!journeyForm);
    console.log('- journeyOutput:', !!journeyOutput, journeyOutput);
    console.log('- journeySources:', !!journeySources);
    console.log('- journeyProvider:', !!journeyProvider);
    console.log('- simulateForm:', !!simulateForm);

    // Helper function for safe element access
    function safeGetElementValue(id, defaultValue = '') {
      const element = document.getElementById(id);
      return element ? (element.value || defaultValue) : defaultValue;
    }
    
    function safeSetElementValue(id, value) {
      const element = document.getElementById(id);
      if (element) {
        element.value = value;
        return true;
      }
      console.warn(`Element with id '${id}' not found`);
      return false;
    }

    // Services dropdown functionality
    window.toggleServicesDropdown = function() {
      const dropdown = document.getElementById('services-dropdown');
      const isHidden = dropdown.classList.contains('hidden');
      
      if (isHidden) {
        dropdown.classList.remove('hidden');
        updateServiceStatus(); // Refresh when opening
      } else {
        dropdown.classList.add('hidden');
      }
    };

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
      const dropdown = document.getElementById('services-dropdown');
      const button = document.getElementById('services-dropdown-btn');
      
      if (dropdown && button && !dropdown.contains(event.target) && !button.contains(event.target)) {
        dropdown.classList.add('hidden');
      }
    });

    let lastJourney = null;
    let currentJourneyData = null;

    // Error simulation state
    let errorSimulationEnabled = true;

    // Tab System Functions
    window.switchTab = function(tabName) {
      console.log('ğŸ”„ Switching to tab:', tabName);
      
      // Remove active class from all tabs and panes
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
      
      // Add active class to selected tab and pane
      const tabButton = document.querySelector(`[data-tab="${tabName}"]`);
      const tabPane = document.getElementById(`${tabName}-tab`);
      
      if (tabButton) tabButton.classList.add('active');
      if (tabPane) tabPane.classList.add('active');
      
      // Update progress line
      updateProgressLine(tabName);
      
      // Save current tab state
      localStorage.setItem('bizobs-current-tab', tabName);
    };

    // Progress tracking function
    function updateProgressLine(tabName) {
      const progressLine = document.getElementById('progress-line');
      if (!progressLine) return;
      
      const progressMap = {
        'welcome': '20%',
        'step1': '40%',
        'step2': '60%',
        'step3': '80%',
        'step4': '100%'
      };
      
      progressLine.style.width = progressMap[tabName] || '20%';
      
      // Add completion state for previous tabs
      const tabOrder = ['welcome', 'step1', 'step2', 'step3', 'step4'];
      const currentIndex = tabOrder.indexOf(tabName);
      
      tabOrder.forEach((tab, index) => {
        const button = document.querySelector(`[data-tab="${tab}"]`);
        if (button) {
          if (index < currentIndex) {
            button.classList.add('completed');
          } else {
            button.classList.remove('completed');
          }
        }
      });
    }

    // Add smooth animations for enhanced UI
    function addUIEnhancements() {
      // Add floating animation to cards on hover
      document.querySelectorAll('.shadow-card, .shadow-xl').forEach(card => {
        card.addEventListener('mouseenter', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.transition = 'all 0.3s ease';
        });
        
        card.addEventListener('mouseleave', function() {
          this.style.transform = 'translateY(0)';
        });
      });
      
      // Add pulse effect to active buttons
      const buttons = document.querySelectorAll('.btn-enhanced');
      buttons.forEach(btn => {
        if (!btn.disabled) {
          btn.addEventListener('mouseenter', function() {
            this.style.animation = 'pulse 2s infinite';
          });
          
          btn.addEventListener('mouseleave', function() {
            this.style.animation = 'none';
          });
        }
      });
    }
    
    // Initialize tab system on page load
    document.addEventListener('DOMContentLoaded', function() {
      // Set up tab click handlers
      document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab');
          switchTab(tabName);
        });
      });
      
      // Sync data between tabs
      syncTabData();
      
      // Restore last active tab
      const savedTab = localStorage.getItem('bizobs-current-tab') || 'welcome';
      switchTab(savedTab);
      
      // Add UI enhancements
      setTimeout(addUIEnhancements, 100);
    });

    // Helper functions for tabs
    window.copyToClipboard = function(elementId) {
      const element = document.getElementById(elementId) || 
                     document.getElementById(elementId + '-step2') || 
                     document.getElementById(elementId + '-step1');
      
      if (element) {
        const textToCopy = element.value || element.textContent;
        
        // Use modern clipboard API
        if (navigator.clipboard && window.isSecureContext) {
          navigator.clipboard.writeText(textToCopy).then(() => {
            showCopyFeedback();
          }).catch(err => {
            // Fallback to legacy method
            fallbackCopy(element);
          });
        } else {
          // Fallback for older browsers or non-secure contexts
          fallbackCopy(element);
        }
      }
      
      function fallbackCopy(el) {
        try {
          el.select();
          el.setSelectionRange(0, 99999); // For mobile devices
          document.execCommand('copy');
          showCopyFeedback();
        } catch (err) {
          console.error('Copy failed:', err);
          alert('Copy failed. Please manually select and copy the text.');
        }
      }
      
      function showCopyFeedback() {
        const button = event?.target;
        if (button) {
          const originalText = button.textContent;
          button.textContent = 'âœ… Copied!';
          button.classList.add('bg-dtgreen', 'text-black');
          button.classList.remove('bg-dtpurple', 'text-white');
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-dtgreen', 'text-black');
            button.classList.add('bg-dtpurple', 'text-white');
          }, 2000);
        }
      }
    };

    window.loadTestJSON = function() {
      const testJSON = {
        'journey': {
          'companyName': 'TestCorp',
          'domain': 'testcorp.com',
          'steps': [{'stepIndex': 1, 'stepName': 'Test', 'serviceName': 'TestService'}]
        },
        'customerProfile': {'userId': 'test_001'},
        'traceMetadata': {'correlationId': 'test_trace'},
        'additionalFields': {'deviceType': 'Desktop'}
      };
      const responseEl = document.getElementById('copilotResponse-step2') || document.getElementById('copilotResponse');
      if (responseEl) {
        responseEl.value = JSON.stringify(testJSON, null, 2);
      }
    };

    window.processJourneyResponse = function() {
      console.log('ğŸš€ processJourneyResponse called');
      const responseText = (document.getElementById('copilotResponse-step2') || document.getElementById('copilotResponse')).value.trim();
      console.log('Response text length:', responseText.length);
      
      if (!responseText) {
        alert('Please paste your Copilot response first');
        return;
      }

      try {
        const parsedResponse = JSON.parse(responseText);
        if (parsedResponse.journey && parsedResponse.journey.steps) {
          // Sync to original element if it exists
          const originalResponse = document.getElementById('copilotResponse');
          if (originalResponse) originalResponse.value = responseText;

          // ğŸ”§ ARCHITECTURAL IMPROVEMENT: Integrate error simulation into journey data processing
          // Get error simulation toggle state from UI
          const errorToggle = document.getElementById('errorToggle') || document.getElementById('errorToggle-step3');
          const errorSimulationEnabled = errorToggle ? errorToggle.checked : false;
          
          console.log(`ğŸ¯ Error Simulation Architecture: ${errorSimulationEnabled ? 'ENABLED' : 'DISABLED'} - Processing journey steps with error configuration`);
          
          // Process journey steps and add error configuration based on toggle state
          if (errorSimulationEnabled && parsedResponse.journey.steps) {
            // Add error hints to journey steps for transparent error simulation
            parsedResponse.journey.steps = parsedResponse.journey.steps.map((step, index) => {
              // Apply error simulation logic at data processing level
              const shouldHaveError = Math.random() < 0.3; // 30% chance per step
              const errorStep = {
                ...step,
                hasError: shouldHaveError,
                errorHint: shouldHaveError ? 'Simulated error condition for testing purposes' : undefined
              };
              
              console.log(`ğŸ“ Step ${index + 1} (${step.action}): ${shouldHaveError ? 'ğŸ”´ ERROR CONFIGURED' : 'âœ… No Error'}`);
              return errorStep;
            });
            
            console.log('âœ… Error simulation configuration integrated into journey data structure');
          } else {
            // Ensure all steps have explicit "no error" configuration for consistency
            parsedResponse.journey.steps = parsedResponse.journey.steps.map(step => ({
              ...step,
              hasError: false,
              errorHint: undefined
            }));
            
            console.log('âœ… All steps configured with no errors (error simulation disabled)');
          }

          // Set the global variables for journey simulation with complete data including error configuration
          window.lastJourney = {
            ...parsedResponse.journey,
            additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
            customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
            traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
          };
          window.currentJourneyData = parsedResponse;
          console.log('âœ… Global variables set with complete data including error configuration:', {lastJourney: window.lastJourney, currentJourneyData: window.currentJourneyData});

          // Display journey with additional fields info
          const displayData = {
            journey: parsedResponse.journey,
            customerProfile: parsedResponse.customerProfile,
            traceMetadata: parsedResponse.traceMetadata,
            additionalFields: parsedResponse.additionalFields
          };

          // Update journey output in multiple places
          const journeyOutputElements = [
            document.getElementById('journey-output'),
            document.getElementById('journey-output-step3')
          ];
          
          journeyOutputElements.forEach(el => {
            if (el) {
              el.textContent = JSON.stringify(displayData, null, 2);
              console.log('âœ… Journey output updated for element:', el.id);
            }
          });
          
          // Update provider and sources info
          const journeyProviderEl = document.getElementById('journey-provider');
          if (journeyProviderEl) {
            journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
          }
          
          const journeySourcesEl = document.getElementById('journey-sources');
          if (journeySourcesEl) {
            journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
          }

          // Update step and field counts
          const stepCount = parsedResponse.journey.steps ? parsedResponse.journey.steps.length : 0;
          const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
          
          const stepCountEl = document.getElementById('step-count');
          const fieldCountEl = document.getElementById('field-count');
          
          if (stepCountEl) stepCountEl.textContent = stepCount;
          if (fieldCountEl) fieldCountEl.textContent = fieldsCount;

          // Sync tab data
          syncTabData();

          alert(`Journey processed successfully! Includes ${stepCount} steps and ${fieldsCount} additional tracking fields. Ready for simulation!`);
        } else {
          alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
        }
      } catch (error) {
        console.error('JSON Parse Error:', error);
        alert('Invalid JSON format. Error: ' + error.message);
      }
    };

    // Sync data between original elements and tab elements
    function syncTabData() {
      const syncData = () => {
        // Sync prompts from original to step2 tab
        const prompt1 = document.getElementById('promptText1');
        const prompt2 = document.getElementById('promptText2');
        const prompt1Step2 = document.getElementById('promptText1-step2');
        const prompt2Step2 = document.getElementById('promptText2-step2');
        
        if (prompt1 && prompt1Step2) prompt1Step2.value = prompt1.value;
        if (prompt2 && prompt2Step2) prompt2Step2.value = prompt2.value;
        
        // Also sync to the original hidden elements
        const origPrompt1 = document.querySelector('#promptText1');
        const origPrompt2 = document.querySelector('#promptText2');  
        if (prompt1 && origPrompt1) origPrompt1.value = prompt1.value;
        if (prompt2 && origPrompt2) origPrompt2.value = prompt2.value;
        
        // Sync journey output to step3 tab
        const journeyOutput = document.getElementById('journey-output');
        const journeyOutputStep3 = document.getElementById('journey-output-step3');
        
        if (journeyOutput && journeyOutputStep3 && journeyOutput.textContent.trim()) {
          journeyOutputStep3.textContent = journeyOutput.textContent;
        }
        
        // Sync error toggle states
        const errorToggle = document.getElementById('errorToggle');
        const errorToggleStep3 = document.getElementById('errorToggle-step3');
        
        if (errorToggle && errorToggleStep3) {
          errorToggleStep3.checked = errorToggle.checked;
        }
        
        // Sync simulation results to step5 tab
        const simulationResults = document.getElementById('simulation-results');
        const simulationResultsStep5 = document.getElementById('simulation-results-step5');
        
        if (simulationResults && simulationResultsStep5 && simulationResults.textContent.trim()) {
          simulationResultsStep5.innerHTML = simulationResults.innerHTML;
        }
      };
      
      // Run sync every 1000ms to keep data updated
      setInterval(syncData, 1000);
      syncData(); // Initial sync
    }

    // Step 5 helper functions
    window.updateSimulationStatus = function(message) {
      const statusEl = document.getElementById('simulation-status-step5');
      if (statusEl) statusEl.textContent = message;
    };

    window.clearSimulationResults = function() {
      const resultsEl = document.getElementById('simulation-results-step4');
      if (resultsEl) {
        resultsEl.innerHTML = `
          <div class="text-center text-gray-400 mt-8" style="background: #1a1a1a; padding: 20px; border-radius: 8px;">
            <div class="text-2xl mb-2">ğŸ“Š</div>
            <p style="color: #ffffff;">Simulation results cleared</p>
            <p class="text-xs mt-2" style="color: #cccccc;">Ready for next simulation run</p>
          </div>
        `;
      }
    };

    // Enhanced Copilot Editor Modal
    window.openCopilotEditor = function(textareaId = 'copilotResponse') {
      const textarea = document.getElementById(textareaId);
      if (!textarea) return;
      
      // Create modal overlay with improved backdrop
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 p-4';
      overlay.id = 'copilot-editor-overlay';
      overlay.onclick = (e) => { 
        if (e.target === overlay) {
          console.log('ğŸ”˜ Closing editor by clicking overlay');
          closeCopilotEditor();
        }
      };
      
      // Add ESC key support
      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          console.log('âŒ¨ï¸ Closing editor with ESC key');
          closeCopilotEditor();
        }
      };
      window.copilotEditorEscHandler = handleEsc;
      document.addEventListener('keydown', handleEsc);
      
      // Create modal content with enhanced styling
      const modal = document.createElement('div');
      modal.className = 'bg-gradient-to-br from-dtcard to-dtgray border-2 border-dtcyan rounded-2xl shadow-2xl w-full max-w-6xl h-5/6 flex flex-col transform animate-fade-in';
      modal.innerHTML = `
        <div class="flex items-center justify-between p-6 border-b-2 border-dtcyan bg-gradient-to-r from-dtcard to-dtgray">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-dtcyan rounded-full animate-pulse"></div>
            <h2 class="text-2xl font-bold text-dtcyan drop-shadow-lg">ğŸ“ Enhanced Copilot Editor</h2>
          </div>
          <div class="flex gap-3">
            <button onclick="formatCopilotJSON()" class="bg-gradient-to-r from-dtblue to-dtpurple hover:from-dtcyan hover:to-dtgreen text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              ğŸ¨ Format JSON
            </button>
            <button onclick="validateCopilotJSON()" class="bg-gradient-to-r from-dtpurple to-dtcyan hover:from-dtgreen hover:to-dtcyan text-white hover:text-black px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              âœ… Validate
            </button>
            <button onclick="closeCopilotEditor()" class="bg-gradient-to-r from-dtgray to-red-500 hover:from-red-600 hover:to-red-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition-all transform hover:scale-105 shadow-lg">
              âœ• Close
            </button>
          </div>
        </div>
        <div class="flex-1 p-6 bg-gradient-to-br from-black to-dtgray">
          <textarea id="copilotEditorTextarea" class="w-full h-full p-4 border-2 border-dtcyan rounded-xl bg-black text-white text-sm font-mono resize-none focus:ring-4 focus:ring-dtcyan focus:ring-opacity-50 transition-all shadow-inner" placeholder="Enter or paste your Copilot JSON response here..." style="box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);"></textarea>
        </div>
        <div class="flex items-center justify-between p-6 border-t-2 border-dtcyan bg-gradient-to-r from-dtcard to-dtgray">
          <div id="copilotEditorStatus" class="text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full">Ready to edit</div>
          <div class="flex gap-3">
            <button onclick="saveCopilotEditor()" class="bg-gradient-to-r from-dtgreen to-dtcyan hover:from-dtcyan hover:to-dtgreen text-black font-bold px-8 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
              ğŸ’¾ Save & Close
            </button>
            <button onclick="closeCopilotEditor()" class="bg-gradient-to-r from-dtgray to-dtpurple hover:from-dtpurple hover:to-dtgray text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
              Cancel
            </button>
          </div>
        </div>
      `;
      
      overlay.appendChild(modal);
      document.body.appendChild(overlay);
      
      // Copy current content and focus with smooth animation
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      editorTextarea.value = textarea.value;
      setTimeout(() => {
        editorTextarea.focus();
        editorTextarea.setSelectionRange(editorTextarea.value.length, editorTextarea.value.length);
      }, 200);
      
      // Store reference to original textarea
      window.copilotEditorOriginal = textarea;
    };

    window.closeCopilotEditor = function() {
      console.log('ğŸ”„ Attempting to close Copilot editor...');
      
      // Find overlay by ID first, then fallback to class selectors
      let overlay = document.getElementById('copilot-editor-overlay');
      
      if (!overlay) {
        overlay = document.querySelector('.fixed.inset-0.bg-black.bg-opacity-80') || 
                 document.querySelector('.fixed.inset-0.bg-black.bg-opacity-75') ||
                 document.querySelector('[class*="fixed"][class*="inset-0"][class*="bg-black"]');
      }
      
      if (overlay) {
        // Add fade out animation before removal
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.2s ease-out';
        
        setTimeout(() => {
          try {
            overlay.remove();
            console.log('âœ… Copilot editor closed successfully');
          } catch (e) {
            console.warn('âš ï¸ Error removing overlay:', e);
          }
        }, 200);
      } else {
        console.warn('âš ï¸ Could not find overlay to close');
      }
      
      // Clean up
      window.copilotEditorOriginal = null;
      
      // Remove any ESC key listeners
      document.removeEventListener('keydown', window.copilotEditorEscHandler);
    };

    window.saveCopilotEditor = function() {
      console.log('ğŸ’¾ Saving Copilot editor content...');
      
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const originalTextarea = window.copilotEditorOriginal;
      
      if (editorTextarea && originalTextarea) {
        const content = editorTextarea.value;
        originalTextarea.value = content;
        
        // Trigger change events to update UI
        originalTextarea.dispatchEvent(new Event('change', { bubbles: true }));
        originalTextarea.dispatchEvent(new Event('input', { bubbles: true }));
        
        console.log('âœ… Content saved successfully:', content.substring(0, 100) + '...');
      } else {
        console.warn('âš ï¸ Could not save - missing textarea references');
        console.log('Editor textarea:', !!editorTextarea);
        console.log('Original textarea:', !!originalTextarea);
      }
      
      closeCopilotEditor();
    };

    window.formatCopilotJSON = function() {
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const statusEl = document.getElementById('copilotEditorStatus');
      
      try {
        const parsed = JSON.parse(editorTextarea.value);
        editorTextarea.value = JSON.stringify(parsed, null, 2);
        statusEl.textContent = 'âœ… JSON formatted successfully';
        statusEl.className = 'text-sm text-dtgreen font-medium bg-green-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtgreen animate-pulse';
        setTimeout(() => {
          statusEl.className = 'text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full';
          statusEl.textContent = 'Ready to edit';
        }, 3000);
      } catch (e) {
        statusEl.textContent = 'âŒ Invalid JSON: ' + e.message.substring(0, 50) + '...';
        statusEl.className = 'text-sm text-red-400 font-medium bg-red-900 bg-opacity-30 px-3 py-1 rounded-full border border-red-400 animate-pulse';
      }
    };

    window.validateCopilotJSON = function() {
      const editorTextarea = document.getElementById('copilotEditorTextarea');
      const statusEl = document.getElementById('copilotEditorStatus');
      
      try {
        const parsed = JSON.parse(editorTextarea.value);
        const hasJourney = parsed.journey || parsed.aiJourney;
        const hasSteps = hasJourney && hasJourney.steps && Array.isArray(hasJourney.steps);
        
        const hasCompany = parsed.company && parsed.company.name;
        
        if (hasSteps && hasCompany) {
          statusEl.textContent = `âœ… Perfect! ${parsed.company.name} journey with ${hasJourney.steps.length} steps`;
          statusEl.className = 'text-sm text-dtgreen font-medium bg-green-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtgreen animate-pulse';
        } else if (hasSteps) {
          statusEl.textContent = `âš ï¸ Valid journey (${hasJourney.steps.length} steps) but missing company info`;
          statusEl.className = 'text-sm text-dtyellow font-medium bg-yellow-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtyellow';
        } else {
          statusEl.textContent = 'âš ï¸ Valid JSON but missing journey structure';
          statusEl.className = 'text-sm text-dtyellow font-medium bg-yellow-900 bg-opacity-30 px-3 py-1 rounded-full border border-dtyellow';
        }
        
        setTimeout(() => {
          if (statusEl.textContent.includes('Perfect!')) {
            statusEl.className = 'text-sm text-dtcyan font-medium bg-black bg-opacity-30 px-3 py-1 rounded-full';
            statusEl.textContent = 'Ready to edit';
          }
        }, 4000);
      } catch (e) {
        statusEl.textContent = 'âŒ Invalid JSON: ' + e.message.substring(0, 50) + '...';
        statusEl.className = 'text-sm text-red-400 font-medium bg-red-900 bg-opacity-30 px-3 py-1 rounded-full border border-red-400 animate-pulse';
      }
    };



    window.exportSimulationResults = function() {
      const resultsEl = document.getElementById('simulation-results-step4');
      if (resultsEl && resultsEl.textContent.trim()) {
        const data = resultsEl.textContent;
        const blob = new Blob([data], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bizobs-simulation-results-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } else {
        alert('No simulation results to export. Please run a simulation first.');
      }
    };

    // Missing validation and UI functions
    window.validateAndProceed = function() {
      const companyName = safeGetElementValue('companyName').trim();
      const domain = safeGetElementValue('domain').trim();
      const journeyRequirements = safeGetElementValue('journeyRequirements').trim();
      
      if (!companyName) {
        alert('Please enter a company name');
        return;
      }
      if (!domain) {
        alert('Please enter a website domain');  
        return;
      }
      if (!journeyRequirements) {
        alert('Please describe your journey requirements');  
        return;
      }
      
      // Generate prompts and advance to step 2
      generateCopilotPrompt();
      setTimeout(() => switchTab('step2'), 500);
    };

    window.showDataMode = function(mode) {
      // Remove active class from all mode buttons
      document.querySelectorAll('.data-mode-btn').forEach(btn => btn.classList.remove('active'));
      
      // Hide all mode content
      document.querySelectorAll('.data-mode-content').forEach(content => content.style.display = 'none');
      
      // Show selected mode
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      document.getElementById(`${mode}-mode`).style.display = 'block';
    };

    window.checkResponseInput = function() {
      const responseText = document.getElementById('copilotResponse-step2').value.trim();
      const processBtn = document.getElementById('processJourneyResponse');
      
      console.log('checkResponseInput called, text length:', responseText.length);
      console.log('Process button found:', !!processBtn);
      
      if (processBtn) {
        if (responseText.length > 0) {
          processBtn.disabled = false;
          processBtn.classList.remove('opacity-50');
          console.log('âœ… Button enabled');
        } else {
          processBtn.disabled = true;
          processBtn.classList.add('opacity-50');
          console.log('âŒ Button disabled');
        }
      }
    };

    // Add additional event listeners for better responsiveness
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('copilotResponse-step2');
      if (textarea) {
        // Add multiple event listeners to catch all input changes
        textarea.addEventListener('input', checkResponseInput);
        textarea.addEventListener('paste', function() {
          setTimeout(checkResponseInput, 100); // Small delay to let paste complete
        });
        textarea.addEventListener('keyup', checkResponseInput);
      }
    });

    window.validateProcessing = function() {
      const journeyOutput = document.getElementById('journey-output-step3');
      if (journeyOutput && journeyOutput.textContent.trim()) {
        alert('âœ… Journey data validated successfully!');
      } else {
        alert('âš ï¸ No journey data found. Please complete Step 2 first.');
      }
    };

    // Console logging for debugging
    console.log('BizObs App initializing...');

    // Error Simulation Toggle Functionality
    function initializeErrorToggle() {
      const toggle = document.getElementById('errorSimulationToggle');
      const status = document.getElementById('errorToggleStatus');
      
      if (toggle && status) {
        // Initialize toggle state
        toggle.checked = errorSimulationEnabled;
        updateToggleStatus();
        
        // Add change event listener
        toggle.addEventListener('change', function() {
          errorSimulationEnabled = this.checked;
          updateToggleStatus();
          console.log('ğŸ”„ Error simulation toggle changed:', errorSimulationEnabled ? 'ENABLED' : 'DISABLED');
        });
        
        function updateToggleStatus() {
          if (errorSimulationEnabled) {
            status.textContent = 'ON';
            status.className = 'px-2 py-1 rounded bg-dtgreen text-black font-semibold';
          } else {
            status.textContent = 'OFF';
            status.className = 'px-2 py-1 rounded bg-red-600 text-white font-semibold';
          }
        }
        
        console.log('âœ… Error simulation toggle initialized');
      } else {
        console.warn('âš ï¸ Error toggle elements not found');
      }
    }

    // Initialize error toggle when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeErrorToggle);
    // Also try to initialize immediately in case DOM is already ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeErrorToggle);
    } else {
      initializeErrorToggle();
    }

    // Prompt Cache Management
    class PromptCache {
      constructor() {
        console.log('PromptCache constructor called');
        this.storageKey = 'bizobs-saved-prompts';
        console.log('Calling initializeSidebar...');
        this.initializeSidebar();
        console.log('Calling loadSavedPrompts...');
        this.loadSavedPrompts();
        console.log('PromptCache constructor completed');
      }

      initializeSidebar() {
        console.log('initializeSidebar method called');
        const toggleBtn = document.getElementById('toggleSidebar');
        const closeBtn = document.getElementById('closeSidebar');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        const saveBtn = document.getElementById('saveCurrentPrompt');
        const quickSaveBtn = document.getElementById('quickSavePrompt');
        const clearBtn = document.getElementById('clearAllPrompts');
        const exportBtn = document.getElementById('exportPrompts');
        const importBtn = document.getElementById('importPrompts');

        console.log('Element check:');
        console.log('- toggleBtn:', !!toggleBtn);
        console.log('- closeBtn:', !!closeBtn);
        console.log('- sidebar:', !!sidebar);
        console.log('- mainContent:', !!mainContent);

        if (toggleBtn) {
          console.log('Toggle button found, adding event listener...');
          toggleBtn.addEventListener('click', () => {
            console.log('Toggle button clicked!');
            this.toggleSidebar();
          });
        } else {
          console.error('Toggle button NOT found!');
        }
        
        if (closeBtn) {
          console.log('Close button found, adding event listener...');
          closeBtn.addEventListener('click', () => {
            console.log('Close button clicked!');
            this.closeSidebar();
          });
        } else {
          console.error('Close button NOT found!');
        }
        if (saveBtn) {
          console.log('âœ… Save button found, adding event listener');
          saveBtn.addEventListener('click', () => {
            console.log('ğŸ’¾ Save button clicked!');
            console.log('Current form data:', {
              companyName: document.getElementById('companyName')?.value,
              domain: document.getElementById('domain')?.value,
              promptText1: document.getElementById('promptText1-step2')?.value?.substring(0, 100) + '...',
              promptText2: document.getElementById('promptText2-step2')?.value?.substring(0, 100) + '...'
            });
            this.saveCurrentPrompt();
          });
        } else {
          console.error('âŒ Save button NOT found!');
        }
        if (quickSaveBtn) quickSaveBtn.addEventListener('click', () => this.quickSavePrompt());
        if (clearBtn) clearBtn.addEventListener('click', () => this.clearAllPrompts());
        if (exportBtn) exportBtn.addEventListener('click', () => this.exportPrompts());
        if (importBtn) importBtn.addEventListener('click', () => this.importPrompts());

        // Close sidebar when clicking outside
        document.addEventListener('click', (e) => {
          if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target) && sidebar.classList.contains('translate-x-0')) {
            this.closeSidebar();
          }
        });

        // Update counter on page load
        this.updatePromptsCounter();

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          // Ctrl+S or Cmd+S for quick save
          if ((e.ctrlKey || e.metaKey) && e.key === 's' && !e.shiftKey) {
            e.preventDefault();
            this.quickSavePrompt();
          }
          // Ctrl+Shift+S for named save
          if ((e.ctrlKey || e.metaKey) && e.key === 'S' && e.shiftKey) {
            e.preventDefault();
            this.toggleSidebar();
            setTimeout(() => {
              document.getElementById('savePromptName').focus();
            }, 300);
          }
          // Escape to close sidebar
          if (e.key === 'Escape') {
            this.closeSidebar();
          }
        });
      }

      toggleSidebar() {
        console.log('toggleSidebar method called');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        console.log('Sidebar element:', sidebar);
        console.log('Main content element:', mainContent);
        
        if (!sidebar) {
          console.error('Sidebar element not found!');
          return;
        }
        
        const isOpen = sidebar.classList.contains('translate-x-0');
        console.log('Sidebar is currently open:', isOpen);
        
        if (isOpen) {
          console.log('Closing sidebar...');
          this.closeSidebar();
        } else {
          console.log('Opening sidebar...');
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
          if (mainContent) mainContent.classList.add('sidebar-open');
        }
      }

      closeSidebar() {
        console.log('ğŸ”’ closeSidebar method called');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        
        if (!sidebar) {
          console.error('âŒ Sidebar element not found in closeSidebar!');
          return;
        }
        
        console.log('ğŸ”„ Closing sidebar - removing translate-x-0, adding -translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebar.classList.add('-translate-x-full');
        if (mainContent) {
          mainContent.classList.remove('sidebar-open');
          console.log('âœ… Main content updated');
        }
        console.log('âœ… Sidebar closed successfully');
      }

      getCurrentPromptState() {
        const getElementValue = (id, defaultValue = '') => {
          const element = document.getElementById(id);
          return element ? element.value : defaultValue;
        };
        
        const getCheckboxValue = (id, defaultValue = false) => {
          const element = document.getElementById(id);
          return element ? element.checked : defaultValue;
        };
        
        return {
          timestamp: new Date().toISOString(),
          formData: {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: 'determined-by-ai',
            journeyRequirements: getElementValue('journeyRequirements'),
            customSteps: getElementValue('customSteps'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            generationMethod: getElementValue('generationMethod', 'copilot'),
            customerCount: getElementValue('customerCount', '1')
          },
          // ğŸ”§ COMPREHENSIVE FIELD CAPTURE: Save ALL input fields across all steps
          step1Fields: {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: getElementValue('industryType'),
            journeyRequirements: getElementValue('journeyRequirements'),
            customSteps: getElementValue('customSteps'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            generationMethod: getElementValue('generationMethod', 'copilot')
          },
          step2Fields: {
            promptText1: getElementValue('promptText1'),
            promptText2: getElementValue('promptText2'),
            promptText1Step2: getElementValue('promptText1-step2'),
            promptText2Step2: getElementValue('promptText2-step2'),
            copilotResponse: getElementValue('copilotResponse'),
            copilotResponseStep2: getElementValue('copilotResponse-step2')
          },
          step3Fields: {
            journeyOutput: getElementValue('journey-output') || document.getElementById('journey-output')?.textContent || '',
            journeyOutputStep3: getElementValue('journey-output-step3') || document.getElementById('journey-output-step3')?.textContent || '',
            errorToggle: getCheckboxValue('errorToggle'),
            errorToggleStep3: getCheckboxValue('errorToggle-step3')
          },
          step4Fields: {
            customerCount: getElementValue('customerCount', '1'),
            thinkTimeMs: getElementValue('thinkTimeMs', '1000'),
            executionType: getElementValue('executionType', 'chained')
          },
          step5Fields: {
            simulationResults: document.getElementById('simulation-results')?.innerHTML || '',
            simulationResultsStep5: document.getElementById('simulation-results-step5')?.innerHTML || ''
          },
          // Legacy fields for backward compatibility
          additionalFields: typeof additionalFields !== 'undefined' ? [...additionalFields] : [],
          generatedPrompt: getElementValue('promptText'),
          promptText1: getElementValue('promptText1-step2'),
          promptText2: getElementValue('promptText2-step2'),
          copilotResponse: getElementValue('copilotResponse-step2'),
          lastJourney: typeof window.lastJourney !== 'undefined' && window.lastJourney ? { ...window.lastJourney } : null,
          currentJourneyData: typeof window.currentJourneyData !== 'undefined' && window.currentJourneyData ? { ...window.currentJourneyData } : null
        };
      }

      saveCurrentPrompt() {
        const nameInput = document.getElementById('savePromptName');
        let name = nameInput ? nameInput.value.trim() : '';
        
        // If no name provided, generate one based on company and timestamp
        if (!name) {
          const companyName = document.getElementById('companyName')?.value.trim() || 'Unknown';
          const timestamp = new Date().toLocaleString();
          name = `${companyName} - ${timestamp}`;
        }

        const promptState = this.getCurrentPromptState();
        promptState.name = name;
        promptState.id = Date.now().toString();

        const savedPrompts = this.getSavedPrompts();
        savedPrompts.push(promptState);
        
        localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));
        if (nameInput) nameInput.value = '';
        
        this.renderSavedPrompts();
        this.updatePromptsCounter();
        
        // Show success message
        const saveButton = document.getElementById('saveCurrentPrompt');
        if (saveButton) {
          const originalText = saveButton.textContent;
          saveButton.textContent = 'âœ… Saved!';
          setTimeout(() => {
            saveButton.textContent = originalText;
          }, 2000);
        }

        this.showNotification(`Saved "${name}" successfully!`);
      }

      getSavedPrompts() {
        try {
          return JSON.parse(localStorage.getItem(this.storageKey) || '[]');
        } catch (error) {
          console.error('Error loading saved prompts:', error);
          return [];
        }
      }

      loadSavedPrompts() {
        this.renderSavedPrompts();
        this.updatePromptsCounter();
      }

      quickSavePrompt() {
        const companyName = document.getElementById('companyName').value.trim();
        const domain = document.getElementById('domain').value.trim();
        
        // Generate an automatic name based on form content
        const autoName = companyName 
          ? `${companyName} - ${domain || 'General'} (${new Date().toLocaleDateString()})`
          : `Quick Save - ${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

        const promptState = this.getCurrentPromptState();
        promptState.name = autoName;
        promptState.id = Date.now().toString();
        promptState.isQuickSave = true;

        const savedPrompts = this.getSavedPrompts();
        savedPrompts.push(promptState);
        localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));

        this.renderSavedPrompts();
        this.updatePromptsCounter();

        // Show success animation - fix undefined btn variable
        const quickSaveBtn = document.getElementById('quickSavePrompt');
        if (quickSaveBtn) {
          const originalText = quickSaveBtn.textContent;
          quickSaveBtn.textContent = 'âœ… Saved!';
          quickSaveBtn.classList.add('bg-green-600');
          quickSaveBtn.classList.remove('bg-dtpurple');
          setTimeout(() => {
            quickSaveBtn.textContent = originalText;
            quickSaveBtn.classList.remove('bg-green-600');
            quickSaveBtn.classList.add('bg-dtpurple');
            quickSaveBtn.disabled = false;
          }, 1200);
        }

        this.showNotification(`Quick saved "${autoName}"!`);
      }

      updatePromptsCounter() {
        const count = this.getSavedPrompts().length;
        const counter = document.getElementById('savedPromptsCount');
        if (counter) {
          counter.textContent = `ğŸ“‹ ${count} saved prompt${count !== 1 ? 's' : ''}`;
        }
      }

      showNotification(message, type = 'success') {
        const toast = document.getElementById('notificationToast');
        const content = document.getElementById('notificationContent');
        
        const icons = {
          success: 'âœ…',
          error: 'âŒ',
          info: 'â„¹ï¸',
          warning: 'âš ï¸'
        };
        
        content.innerHTML = `${icons[type]} ${message}`;
        toast.classList.remove('translate-x-full');
        
        setTimeout(() => {
          toast.classList.add('translate-x-full');
        }, 3000);
      }

      loadPromptState(promptState) {
        console.log('ğŸ”„ Loading comprehensive prompt state:', promptState);
        
        const setElementValue = (id, value, defaultValue = '') => {
          const element = document.getElementById(id);
          if (element) {
            element.value = value || defaultValue;
            console.log(`âœ… Restored ${id}: ${value}`);
          } else {
            console.warn(`âš ï¸ Element ${id} not found when loading prompt state`);
          }
        };
        
        const setElementContent = (id, content) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = content;
            console.log(`âœ… Restored content for ${id}`);
          }
        };
        
        const setElementHTML = (id, html) => {
          const element = document.getElementById(id);
          if (element) {
            element.innerHTML = html;
            console.log(`âœ… Restored HTML for ${id}`);
          }
        };
        
        const setCheckboxValue = (id, value, defaultValue = false) => {
          const element = document.getElementById(id);
          if (element) {
            element.checked = value !== undefined ? value : defaultValue;
            console.log(`âœ… Restored checkbox ${id}: ${value}`);
          }
        };

        // ğŸ”§ COMPREHENSIVE FIELD RESTORATION: Restore ALL fields across all steps
        console.log('ğŸ¯ Restoring Step 1 fields...');
        if (promptState.step1Fields) {
          setElementValue('companyName', promptState.step1Fields.companyName);
          setElementValue('domain', promptState.step1Fields.domain);
          setElementValue('industryType', promptState.step1Fields.industryType);
          setElementValue('journeyRequirements', promptState.step1Fields.journeyRequirements);
          setElementValue('customSteps', promptState.step1Fields.customSteps);
          setElementValue('journeyType', promptState.step1Fields.journeyType);
          setElementValue('details', promptState.step1Fields.details);
          setElementValue('generationMethod', promptState.step1Fields.generationMethod, 'copilot');
        }
        
        console.log('ğŸ¯ Restoring Step 2 fields...');
        if (promptState.step2Fields) {
          setElementValue('promptText1', promptState.step2Fields.promptText1);
          setElementValue('promptText2', promptState.step2Fields.promptText2);
          setElementValue('promptText1-step2', promptState.step2Fields.promptText1Step2);
          setElementValue('promptText2-step2', promptState.step2Fields.promptText2Step2);
          setElementValue('copilotResponse', promptState.step2Fields.copilotResponse);
          setElementValue('copilotResponse-step2', promptState.step2Fields.copilotResponseStep2);
        }
        
        console.log('ğŸ¯ Restoring Step 3 fields...');
        if (promptState.step3Fields) {
          if (promptState.step3Fields.journeyOutput) {
            setElementContent('journey-output', promptState.step3Fields.journeyOutput);
          }
          if (promptState.step3Fields.journeyOutputStep3) {
            setElementContent('journey-output-step3', promptState.step3Fields.journeyOutputStep3);
          }
          setCheckboxValue('errorToggle', promptState.step3Fields.errorToggle);
          setCheckboxValue('errorToggle-step3', promptState.step3Fields.errorToggleStep3);
        }
        
        console.log('ğŸ¯ Restoring Step 4 fields...');
        if (promptState.step4Fields) {
          setElementValue('customerCount', promptState.step4Fields.customerCount, '1');
          setElementValue('thinkTimeMs', promptState.step4Fields.thinkTimeMs, '1000');
          setElementValue('executionType', promptState.step4Fields.executionType, 'chained');
        }
        
        console.log('ğŸ¯ Restoring Step 5 fields...');
        if (promptState.step5Fields) {
          if (promptState.step5Fields.simulationResults) {
            setElementHTML('simulation-results', promptState.step5Fields.simulationResults);
          }
          if (promptState.step5Fields.simulationResultsStep5) {
            setElementHTML('simulation-results-step5', promptState.step5Fields.simulationResultsStep5);
          }
        }

        // Legacy compatibility - restore original form data structure
        console.log('ğŸ¯ Restoring legacy form data...');
        const formData = promptState.formData || {};
        setElementValue('companyName', formData.companyName);
        setElementValue('domain', formData.domain);
        setElementValue('journeyRequirements', formData.journeyRequirements);
        setElementValue('customSteps', formData.customSteps);
        setElementValue('journeyType', formData.journeyType);
        setElementValue('details', formData.details);
        setElementValue('generationMethod', formData.generationMethod, 'copilot');
        setElementValue('customerCount', formData.customerCount, '1');

        // Restore additional fields if function exists
        if (typeof additionalFields !== 'undefined' && typeof renderAdditionalFields === 'function') {
          additionalFields.length = 0;
          if (promptState.additionalFields) {
            additionalFields.push(...promptState.additionalFields);
            renderAdditionalFields();
          }
        }

        // Legacy compatibility - restore generated prompts and Copilot response
        console.log('ğŸ¯ Restoring legacy prompt fields...');
        setElementValue('promptText', promptState.generatedPrompt);
        setElementValue('promptText1', promptState.promptText1);
        setElementValue('promptText2', promptState.promptText2);
        setElementValue('copilotResponse', promptState.copilotResponse);

        // Restore global journey data
        console.log('ğŸ¯ Restoring journey data...');
        if (promptState.lastJourney && typeof window !== 'undefined') {
          window.lastJourney = promptState.lastJourney;
          console.log('âœ… Restored window.lastJourney');
        }
        if (promptState.currentJourneyData && typeof window !== 'undefined') {
          window.currentJourneyData = promptState.currentJourneyData;
          console.log('âœ… Restored window.currentJourneyData');
          
          // Update journey output displays
          const journeyOutputEl = document.getElementById('journey-output');
          const journeyOutputStep3El = document.getElementById('journey-output-step3');
          const journeyDataText = JSON.stringify(promptState.currentJourneyData, null, 2);
          
          if (journeyOutputEl) {
            journeyOutputEl.textContent = journeyDataText;
          }
          if (journeyOutputStep3El) {
            journeyOutputStep3El.textContent = journeyDataText;
          }
        }

        // ğŸ”„ POST-RESTORATION SYNCHRONIZATION
        console.log('ğŸ¯ Triggering UI synchronization...');
        
        // Trigger form validation and UI updates
        const generationMethod = (promptState.step1Fields?.generationMethod) || (promptState.formData?.generationMethod) || 'copilot';
        const generationMethodEl = document.getElementById('generationMethod');
        if (generationMethodEl) {
          generationMethodEl.value = generationMethod;
          generationMethodEl.dispatchEvent(new Event('change'));
        }
        
        // Trigger any form validation or dependent UI updates
        const companyNameEl = document.getElementById('companyName');
        if (companyNameEl) {
          companyNameEl.dispatchEvent(new Event('input'));
        }
        
        // Sync error toggle states between tabs
        const errorToggle = document.getElementById('errorToggle');
        const errorToggleStep3 = document.getElementById('errorToggle-step3');
        if (errorToggle && errorToggleStep3) {
          errorToggleStep3.checked = errorToggle.checked;
        }
        
        // ğŸ”§ ENHANCED VALIDATION TRIGGERS: Ensure all form validation functions are called with proper timing
        console.log('ğŸ¯ Triggering validation functions...');
        
        // Trigger validation immediately
        if (typeof checkPromptRequirements === 'function') {
          checkPromptRequirements();
          console.log('âœ… checkPromptRequirements called');
        }
        if (typeof checkResponseInput === 'function') {
          checkResponseInput();
          console.log('âœ… checkResponseInput called');
        }
        
        // Also trigger validation with a delay to ensure DOM is fully updated
        setTimeout(() => {
          console.log('ğŸ•’ Delayed validation triggers...');
          if (typeof checkPromptRequirements === 'function') {
            checkPromptRequirements();
          }
          if (typeof checkResponseInput === 'function') {
            checkResponseInput();
          }
          
          // Manually trigger input events on key fields to ensure validation
          const copilotResponseEl = document.getElementById('copilotResponse-step2');
          if (copilotResponseEl && copilotResponseEl.value.trim()) {
            console.log('ğŸ”„ Triggering manual input event on copilotResponse-step2');
            copilotResponseEl.dispatchEvent(new Event('input', { bubbles: true }));
            copilotResponseEl.dispatchEvent(new Event('change', { bubbles: true }));
          }
          
          // Check process button state specifically
          const processBtn = document.getElementById('processJourneyResponse');
          if (processBtn && copilotResponseEl?.value.trim()) {
            processBtn.disabled = false;
            processBtn.classList.remove('opacity-50');
            console.log('âœ… Manually enabled process button');
          }
        }, 200);
        
        console.log('âœ… Prompt state restoration completed successfully!');
        
        // If copilot mode, regenerate the prompt with restored data
        if (generationMethod === 'copilot' && typeof generateCopilotPrompt === 'function') {
          setTimeout(() => generateCopilotPrompt(), 100);
        }

        this.closeSidebar();
        this.showNotification(`Loaded "${promptState.name}" successfully!`);
      }

      deletePrompt(promptId) {
        if (!confirm('Are you sure you want to delete this saved prompt?')) {
          return;
        }

        const savedPrompts = this.getSavedPrompts();
        const filteredPrompts = savedPrompts.filter(p => p.id !== promptId);
        localStorage.setItem(this.storageKey, JSON.stringify(filteredPrompts));
        this.renderSavedPrompts();
        this.updatePromptsCounter();
      }

      clearAllPrompts() {
        if (!confirm('Are you sure you want to delete ALL saved prompts? This cannot be undone.')) {
          return;
        }

        localStorage.removeItem(this.storageKey);
        this.renderSavedPrompts();
        this.updatePromptsCounter();
        this.showNotification('All saved prompts cleared', 'warning');
      }

      exportPrompts() {
        const savedPrompts = this.getSavedPrompts();
        if (savedPrompts.length === 0) {
          this.showNotification('No saved prompts to export', 'warning');
          return;
        }

        const dataStr = JSON.stringify(savedPrompts, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        
        const link = document.createElement('a');
        link.href = url;
        link.download = `bizobs-prompts-${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        URL.revokeObjectURL(url);
        this.showNotification(`Exported ${savedPrompts.length} prompts to file`);
      }

      importPrompts() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const importedPrompts = JSON.parse(e.target.result);
              if (!Array.isArray(importedPrompts)) {
                throw new Error('Invalid file format');
              }

              const existingPrompts = this.getSavedPrompts();
              const mergedPrompts = [...existingPrompts, ...importedPrompts];
              
              localStorage.setItem(this.storageKey, JSON.stringify(mergedPrompts));
              this.renderSavedPrompts();
              this.updatePromptsCounter();
              
              this.showNotification(`Imported ${importedPrompts.length} prompts successfully!`);
            } catch (error) {
              this.showNotification('Error importing prompts: Invalid file format', 'error');
            }
          };
          reader.readAsText(file);
        };
        input.click();
      }

      autoSaveCurrentState(reason = 'auto') {
        // Only auto-save if there's meaningful content
        const companyName = document.getElementById('companyName').value.trim();
        const industryType = document.getElementById('industryType').value.trim();

        
        if (!companyName) {
          return; // Don't auto-save empty forms
        }

        const autoName = `Auto: ${companyName || 'Unnamed'} - ${reason} (${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })})`;
        
        const promptState = this.getCurrentPromptState();
        promptState.name = autoName;
        promptState.id = Date.now().toString();
        promptState.isAutoSave = true;

        const savedPrompts = this.getSavedPrompts();
        
        // Limit auto-saves to prevent clutter (keep only last 5 auto-saves)
        const manualSaves = savedPrompts.filter(p => !p.isAutoSave);
        const autoSaves = savedPrompts.filter(p => p.isAutoSave).slice(-4); // Keep last 4, plus this new one = 5
        
        const updatedPrompts = [...manualSaves, ...autoSaves, promptState];
        localStorage.setItem(this.storageKey, JSON.stringify(updatedPrompts));
        
        this.updatePromptsCounter();
      }

      renderSavedPrompts() {
        const container = document.getElementById('savedPromptsList');
        const savedPrompts = this.getSavedPrompts();

        if (savedPrompts.length === 0) {
          container.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No saved prompts yet.<br>Save your current configuration to get started!</div>';
          return;
        }

        // Sort by timestamp (newest first)
        savedPrompts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

        container.innerHTML = savedPrompts.map(prompt => {
          const date = new Date(prompt.timestamp).toLocaleDateString();
          const time = new Date(prompt.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const company = prompt.formData.companyName || 'Unnamed';
          const industry = prompt.formData.industryType || 'general';
          const method = prompt.formData.generationMethod || 'copilot';
          const hasJourney = prompt.lastJourney ? 'âœ… Journey' : 'ğŸ“ Config';
          
          let icon = 'ğŸ“Œ';
          if (prompt.isQuickSave) icon = 'âš¡';
          if (prompt.isAutoSave) icon = 'ğŸ¤–';
          
          return `
            <div class="bg-dtgray bg-opacity-60 rounded-lg p-3 border border-gray-600 hover:border-dtcyan transition-all cursor-pointer group ${prompt.isAutoSave ? 'opacity-75' : ''}">
              <div class="flex items-start justify-between">
                <div class="flex-1 min-w-0" onclick="promptCache.loadPromptState(${JSON.stringify(prompt).replace(/"/g, '&quot;')})">
                  <div class="flex items-center gap-2 mb-1">
                    <h4 class="font-semibold text-white text-sm truncate">${icon} ${prompt.name}</h4>
                    <span class="text-xs bg-dtblue text-white px-2 py-0.5 rounded">${method}</span>
                  </div>
                  <p class="text-xs text-gray-300 mt-1">${company} â€¢ ${industry}</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-400">${date} ${time}</span>
                    <span class="text-xs ${prompt.lastJourney ? 'text-green-400' : 'text-yellow-400'}">${hasJourney}</span>
                  </div>
                </div>
                <div class="flex gap-1 ml-2 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button onclick="event.stopPropagation(); promptCache.loadPromptState(${JSON.stringify(prompt).replace(/"/g, '&quot;')})" 
                          class="bg-dtblue text-white px-2 py-1 rounded text-xs hover:bg-dtcyan transition-all" 
                          title="Load this configuration">ğŸ“‹</button>
                  <button onclick="event.stopPropagation(); promptCache.duplicatePrompt('${prompt.id}')" 
                          class="bg-dtgreen text-black px-2 py-1 rounded text-xs hover:bg-green-600 transition-all"
                          title="Duplicate this prompt">ğŸ“„</button>
                  <button onclick="event.stopPropagation(); promptCache.deletePrompt('${prompt.id}')" 
                          class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-all"
                          title="Delete this prompt">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }

      duplicatePrompt(promptId) {
        const savedPrompts = this.getSavedPrompts();
        const originalPrompt = savedPrompts.find(p => p.id === promptId);
        
        if (!originalPrompt) return;

        const duplicatedPrompt = { ...originalPrompt };
        duplicatedPrompt.id = Date.now().toString();
        duplicatedPrompt.name = `Copy of ${originalPrompt.name}`;
        duplicatedPrompt.timestamp = new Date().toISOString();
        duplicatedPrompt.isQuickSave = false;

        savedPrompts.push(duplicatedPrompt);
        localStorage.setItem(this.storageKey, JSON.stringify(savedPrompts));
        
        this.renderSavedPrompts();
        this.updatePromptsCounter();
        
        // Brief success indication
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = 'âœ…';
        setTimeout(() => {
          btn.textContent = originalText;
        }, 1000);
      }
    }

    // Initialize prompt cache
    console.log('Initializing PromptCache...');
    // Initialize PromptCache after DOM is fully loaded
    let promptCache;
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ DOM loaded, initializing PromptCache...');
        promptCache = new PromptCache();
        window.promptCache = promptCache;
        setupBackupEventListeners();
        setTimeout(() => refreshSavedPromptsList(), 200);
        
        // ğŸ”§ NEW: Open sidebar by default on page load
        setTimeout(() => {
          console.log('ğŸ“‚ Opening saved prompts sidebar by default...');
          const sidebar = document.getElementById('savedPromptsSidebar');
          const mainContent = document.getElementById('mainContent');
          if (sidebar) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            if (mainContent) mainContent.classList.add('sidebar-open');
            console.log('âœ… Sidebar opened successfully');
          } else {
            console.error('âŒ Could not find sidebar to open');
          }
        }, 300);
      });
    } else {
      console.log('ğŸš€ DOM already loaded, initializing PromptCache immediately...');
      promptCache = new PromptCache();
      window.promptCache = promptCache;
      setupBackupEventListeners();
      setTimeout(() => refreshSavedPromptsList(), 200);
      
      // ğŸ”§ NEW: Open sidebar by default on page load  
      setTimeout(() => {
        console.log('ğŸ“‚ Opening saved prompts sidebar by default...');
        const sidebar = document.getElementById('savedPromptsSidebar');
        const mainContent = document.getElementById('mainContent');
        if (sidebar) {
          sidebar.classList.remove('-translate-x-full');
          sidebar.classList.add('translate-x-0');
          if (mainContent) mainContent.classList.add('sidebar-open');
          console.log('âœ… Sidebar opened successfully');
        } else {
          console.error('âŒ Could not find sidebar to open');
        }
      }, 300);
    }
    
    // Global save function that works independently
    window.saveCurrentConfiguration = async function() {
      console.log('ğŸ’¾ Global save function called');
      
      const nameInput = document.getElementById('savePromptName');
      let name = nameInput ? nameInput.value.trim() : '';
      
      // If no name provided, generate one based on company and timestamp
      if (!name) {
        const companyName = document.getElementById('companyName')?.value.trim() || 'Unknown';
        const timestamp = new Date().toLocaleString();
        name = `${companyName} - ${timestamp}`;
        console.log('Auto-generated name:', name);
      }

      try {
        // Get current form state
        const getCurrentState = () => {
          const getElementValue = (id) => {
            const el = document.getElementById(id);
            return el ? el.value : '';
          };

          return {
            companyName: getElementValue('companyName'),
            domain: getElementValue('domain'),
            industryType: getElementValue('industryType') || getElementValue('details'),
            journeyRequirements: getElementValue('journeyRequirements') || getElementValue('customSteps'),
            copilotResponse: getElementValue('copilotResponse'),
            copilotResponseStep2: getElementValue('copilotResponse-step2'),
            promptText1: getElementValue('promptText1-step2'),
            promptText2: getElementValue('promptText2-step2'),
            journeyType: getElementValue('journeyType'),
            details: getElementValue('details'),
            customSteps: getElementValue('customSteps'),
            lastJourney: typeof window.lastJourney !== 'undefined' ? window.lastJourney : null,
            currentJourneyData: typeof window.currentJourneyData !== 'undefined' ? window.currentJourneyData : null,
            timestamp: new Date().toISOString()
          };
        };

        const promptState = getCurrentState();
        promptState.name = name;
        promptState.id = Date.now().toString();

        // Save to both localStorage (as backup) and server
        const storageKey = 'bizobs-saved-prompts';
        const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
        savedPrompts.push(promptState);
        localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
        
        // Also save to server for persistence across app restarts
        try {
          const serverResponse = await fetch('/api/admin/configs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(promptState)
          });
          const serverResult = await serverResponse.json();
          
          if (serverResult.ok) {
            console.log('âœ… Configuration saved to server:', serverResult.message);
          } else {
            console.warn('âš ï¸ Server save failed, using localStorage only:', serverResult.error);
            alert('âš ï¸ Saved locally, but server storage failed. Configuration may not persist across app restarts.');
          }
        } catch (serverError) {
          console.warn('âš ï¸ Server storage error, using localStorage only:', serverError.message);
          alert('âš ï¸ Saved locally, but server storage failed. Configuration may not persist across app restarts.');
        }
        
        // Clear name input
        if (nameInput) nameInput.value = '';
        
        // Show success feedback
        const saveBtn = document.getElementById('saveCurrentPrompt');
        const saveStatus = document.getElementById('saveStatus');
        
        if (saveStatus) {
          saveStatus.classList.remove('hidden');
          saveStatus.innerHTML = '<span class="text-dtcyan">â˜ï¸ Saving to server...</span>';
        }
        
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = 'âœ… Saved!';
          saveBtn.style.background = '#10b981';
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = '';
            if (saveStatus) {
              saveStatus.innerHTML = '<span class="text-dtgreen">âœ… Saved to server & browser</span>';
              setTimeout(() => saveStatus.classList.add('hidden'), 3000);
            }
          }, 2000);
        }
        
        // Refresh the saved prompts list
        refreshSavedPromptsList();
        
        // Update counter if element exists
        const counter = document.getElementById('promptsCounter');
        if (counter) {
          counter.textContent = savedPrompts.length;
        }
        
        console.log(`âœ… Saved configuration "${name}" successfully!`);
        alert(`âœ… Configuration "${name}" saved successfully!`);
        
      } catch (error) {
        console.error('âŒ Error saving configuration:', error);
        alert('âŒ Error saving configuration: ' + error.message);
      }
    };

    // Helper function to save configuration data to both localStorage and server
    window.saveConfigurationData = async function(configData) {
      // Save to localStorage first (always works)
      const storageKey = 'bizobs-saved-prompts';
      const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
      
      // Remove existing config with same ID if it exists
      const existingIndex = savedPrompts.findIndex(p => p.id === configData.id);
      if (existingIndex !== -1) {
        savedPrompts[existingIndex] = configData;
      } else {
        savedPrompts.push(configData);
      }
      
      localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
      
      // Also save to server
      try {
        const response = await fetch('/api/admin/configs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(configData)
        });
        
        const result = await response.json();
        if (result.ok) {
          console.log('âœ… Configuration saved to server');
        } else {
          console.warn('âš ï¸ Server save failed:', result.error);
        }
      } catch (error) {
        console.warn('âš ï¸ Server save error:', error.message);
      }
    };

    // Function to refresh the saved prompts list display
    async function refreshSavedPromptsList() {
      console.log('ğŸ”„ refreshSavedPromptsList() called');
      try {
        const listContainer = document.getElementById('savedPromptsList');
        
        if (!listContainer) {
          console.warn('âš ï¸ Saved prompts list container not found');
          return;
        }
        
        console.log('âœ… Found savedPromptsList container, loading data...');
        
        // Show loading state
        listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">Loading saved configurations...</div>';
        
        // ğŸ”§ FIX: Use localStorage as primary source with full prompt data
        const storageKey = 'bizobs-saved-prompts';
        let allPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
        
        // Add source indicator for localStorage prompts
        allPrompts.forEach(p => {
          if (!p.source) p.source = 'local';
        });
        
        console.log(`âœ… Loaded ${allPrompts.length} configurations from localStorage`);
        
        // Optional: Try to load from server as backup (but don't override localStorage)
        try {
          const serverResponse = await fetch('/api/admin/configs');
          if (serverResponse.ok) {
            const serverData = await serverResponse.json();
            if (serverData.ok && serverData.configs) {
              console.log(`ğŸ“¡ Server has ${serverData.configs.length} configurations available as backup`);
              // Note: We prioritize localStorage to maintain full prompt data
            }
          }
        } catch (serverError) {
          console.log('ğŸ“¡ Server check skipped:', serverError.message);
        }
        
        // Sort by timestamp (newest first)
        allPrompts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        
        if (allPrompts.length === 0) {
          listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-4">No saved configurations yet.<br>Save your current configuration to get started!</div>';
          return;
        }
        
        // ğŸ”§ FIXED: Render saved prompts directly without delegation to avoid timing issues
        console.log(`ğŸ¯ Rendering ${allPrompts.length} saved prompts directly`);
        
        // First clear the container
        listContainer.innerHTML = '';
        
        if (allPrompts.length === 0) {
          listContainer.innerHTML = '<div class="text-gray-400 text-sm text-center py-8">No saved configurations found</div>';
          return;
        }
        
        listContainer.innerHTML = allPrompts.map(prompt => {
          const date = new Date(prompt.timestamp).toLocaleDateString();
          const time = new Date(prompt.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          const company = prompt.formData?.companyName || prompt.companyName || 'Unnamed';
          const method = prompt.formData?.generationMethod || 'copilot';
          const industry = prompt.formData?.industryType || 'general';
          const hasJourney = prompt.lastJourney ? 'âœ… Journey' : 'ğŸ“ Config';
          
          let icon = 'ğŸ“Œ';
          if (prompt.isQuickSave) icon = 'âš¡';
          if (prompt.isAutoSave) icon = 'ğŸ¤–';
          
          const sourceIcon = prompt.source === 'server' ? 'â˜ï¸' : 'ğŸ’¾';
          const sourceTitle = prompt.source === 'server' ? 'Stored on server (persistent)' : 'Stored locally (browser only)';
          
          return `
            <div class="bg-dtgray p-3 rounded-lg border border-dtborder hover:border-dtcyan transition-all cursor-pointer" 
                 data-prompt-id="${prompt.id}" 
                 data-prompt-source="${prompt.source || 'local'}"
                 onclick="loadSavedPrompt('${prompt.id}', '${prompt.source || 'local'}')">
              <div class="flex items-center justify-between">
                <div class="flex-1">
                  <div class="flex items-center gap-2">
                    <h4 class="text-dtcyan font-medium text-sm">${icon} ${prompt.name || company}</h4>
                    <span class="text-xs" title="${sourceTitle}">${sourceIcon}</span>
                    <span class="text-xs bg-dtblue text-white px-2 py-0.5 rounded">${method}</span>
                  </div>
                  <p class="text-gray-400 text-xs mt-1">${company} â€¢ ${date}</p>
                  <div class="flex items-center gap-2 mt-1">
                    <span class="text-xs text-gray-500">${time}</span>
                    <span class="text-xs ${prompt.lastJourney ? 'text-green-400' : 'text-yellow-400'}">${hasJourney}</span>
                  </div>
                </div>
                <div class="flex gap-1 ml-2">
                  <button data-action="duplicate" onclick="event.stopPropagation(); duplicatePrompt('${prompt.id}', '${prompt.source || 'local'}')" class="text-dtblue hover:text-dtcyan text-xs p-1 transition-all hover:scale-110" title="Duplicate">ğŸ“„</button>
                  <button data-action="delete" onclick="event.stopPropagation(); deletePrompt('${prompt.id}', '${prompt.source || 'local'}')" class="text-red-400 hover:text-red-300 text-xs p-1 transition-all hover:scale-110" title="Delete">ğŸ—‘ï¸</button>
                </div>
              </div>
            </div>
          `;
        }).join('');
        
        // ğŸ”§ ENHANCEMENT: Add event delegation for dynamically generated content
        setTimeout(() => {
          // Remove any existing event listeners
          const existingHandler = listContainer.__savedPromptsHandler;
          if (existingHandler) {
            listContainer.removeEventListener('click', existingHandler);
          }
          
          // Add new event delegation handler
          const clickHandler = function(e) {
            const promptCard = e.target.closest('[data-prompt-id]');
            if (!promptCard) return;
            
            const promptId = promptCard.dataset.promptId;
            const promptSource = promptCard.dataset.promptSource || 'local';
            
            // Handle button clicks
            if (e.target.closest('[data-action="duplicate"]')) {
              e.stopPropagation();
              console.log('ğŸ”„ Duplicate button clicked for:', promptId);
              window.duplicatePrompt(promptId, promptSource);
              return;
            }
            
            if (e.target.closest('[data-action="delete"]')) {
              e.stopPropagation();
              console.log('ğŸ—‘ï¸ Delete button clicked for:', promptId);
              window.deletePrompt(promptId, promptSource);
              return;
            }
            
            // Handle card click (load prompt)
            if (!e.target.closest('button')) {
              console.log('ğŸ“‹ Loading saved prompt:', promptId);
              window.loadSavedPrompt(promptId, promptSource);
            }
          };
          
          listContainer.addEventListener('click', clickHandler);
          listContainer.__savedPromptsHandler = clickHandler;
        }, 100);
        
        console.log(`âœ… Refreshed saved prompts list with ${allPrompts.length} items`);
      } catch (error) {
        console.error('âŒ Error refreshing saved prompts list:', error);
      }
    }

    // Load a saved prompt configuration
    window.loadSavedPrompt = async function(promptId, source = 'local') {
      console.log(`ğŸ“‹ Loading saved prompt: ${promptId} from ${source}`);
      try {
        let prompt = null;
        
        if (source === 'server') {
          // Load from server
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                prompt = data.config;
              }
            }
          } catch (error) {
            console.warn('Failed to load from server, trying localStorage:', error);
          }
        }
        
        // Fallback to localStorage if server failed or source is local
        if (!prompt) {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          prompt = savedPrompts.find(p => p.id === promptId);
        }
        
        if (!prompt) {
          alert('Configuration not found');
          return;
        }
        
        // Load form values
        const setElementValue = (id, value) => {
          const el = document.getElementById(id);
          if (el && value) el.value = value;
        };
        
        setElementValue('companyName', prompt.companyName);
        setElementValue('domain', prompt.domain);
        setElementValue('industryType', prompt.industryType);
        setElementValue('journeyRequirements', prompt.journeyRequirements);
        setElementValue('copilotResponse', prompt.copilotResponse);
        setElementValue('copilotResponse-step2', prompt.copilotResponseStep2);
        setElementValue('journeyType', prompt.journeyType);
        setElementValue('details', prompt.details);
        setElementValue('customSteps', prompt.customSteps);
        
        // Restore journey data
        if (prompt.lastJourney) {
          window.lastJourney = prompt.lastJourney;
        }
        if (prompt.currentJourneyData) {
          window.currentJourneyData = prompt.currentJourneyData;
        }
        
          alert('âœ… Loaded configuration "' + prompt.name + '"');
        console.log('âœ… Loaded prompt: ' + prompt.name);
        
      } catch (error) {
        console.error('âŒ Error loading prompt:', error);
        alert('âŒ Error loading prompt: ' + error.message);
      }
    };

    // Duplicate a saved prompt
    window.duplicatePrompt = async function(promptId, source = 'local') {
      try {
        // First load the original prompt
        let prompt = null;
        
        if (source === 'server') {
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                prompt = data.config;
              }
            }
          } catch (error) {
            console.warn('Failed to load from server for duplication:', error);
          }
        }
        
        if (!prompt) {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          prompt = savedPrompts.find(p => p.id === promptId);
        }
        
        if (!prompt) {
          alert('Configuration not found for duplication');
          return;
        }
        
        // Create duplicate
        const duplicate = { ...prompt };
        duplicate.id = Date.now().toString();
        duplicate.name = prompt.name + ' (Copy)';
        duplicate.timestamp = new Date().toISOString();
        
        // Save duplicate (will go to both localStorage and server)
        await window.saveConfigurationData(duplicate);
        
        refreshSavedPromptsList();
        alert(`âœ… Duplicated "${prompt.name}"`);
        
      } catch (error) {
        console.error('âŒ Error duplicating prompt:', error);
        alert('âŒ Error duplicating prompt: ' + error.message);
      }
    };

    // Delete a saved prompt
    window.deletePrompt = async function(promptId, source = 'local') {
      try {
        // First get the prompt name for confirmation
        let promptName = 'Unknown';
        
        if (source === 'server') {
          try {
            const response = await fetch(`/api/admin/configs/${promptId}`);
            if (response.ok) {
              const data = await response.json();
              if (data.ok) {
                promptName = data.config.name;
              }
            }
          } catch (error) {
            console.warn('Could not get prompt name from server:', error);
          }
        } else {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const prompt = savedPrompts.find(p => p.id === promptId);
          if (prompt) promptName = prompt.name;
        }
        
        if (!confirm(`Delete "${promptName}"?\n\nThis will remove it from both local storage and server storage.`)) {
          return;
        }
        
        let success = false;
        
        // Delete from server if it exists there
        try {
          const response = await fetch(`/api/admin/configs/${promptId}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            success = true;
            console.log('âœ… Deleted from server');
          }
        } catch (error) {
          console.warn('Could not delete from server:', error.message);
        }
        
        // Delete from localStorage
        try {
          const storageKey = 'bizobs-saved-prompts';
          const savedPrompts = JSON.parse(localStorage.getItem(storageKey) || '[]');
          const promptIndex = savedPrompts.findIndex(p => p.id === promptId);
          
          if (promptIndex !== -1) {
            savedPrompts.splice(promptIndex, 1);
            localStorage.setItem(storageKey, JSON.stringify(savedPrompts));
            success = true;
            console.log('âœ… Deleted from localStorage');
          }
        } catch (error) {
          console.warn('Could not delete from localStorage:', error.message);
        }
        
        if (success) {
          refreshSavedPromptsList();
          alert(`âœ… Deleted "${promptName}"`);
        } else {
          alert(`âŒ Could not delete "${promptName}"`);
        }
        
      } catch (error) {
        console.error('âŒ Error deleting prompt:', error);
        alert('âŒ Error deleting prompt: ' + error.message);
      }
    };

    // Backup event listeners in case PromptCache event listeners fail
    function setupBackupEventListeners() {
      setTimeout(() => {
        const saveBtn = document.getElementById('saveCurrentPrompt');
        if (saveBtn) {
          console.log('ğŸ”§ Adding backup event listener for save button');
          
          // Remove any existing listeners
          const newBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newBtn, saveBtn);
          
          // Add the working event listener
          newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('ğŸ’¾ Save button clicked - calling global function');
            window.saveCurrentConfiguration();
          });
          
          newBtn.setAttribute('data-listener-added', 'true');
          console.log('âœ… Backup save event listener added successfully');
        }
      }, 100);
    }
    console.log('PromptCache initialized successfully');



    window.runJourneySimulation = async function() {
      console.log('ğŸ”¥ GREEN BUTTON CLICKED! ğŸ”¥');
      
      // Find all possible button variations
      const runJourneySimBtn = document.getElementById('run-journey-simulation') || 
                               document.getElementById('run-journey-simulation-step4') ||
                               document.querySelector('[onclick*="runJourneySimulation"]');
      
      const simStatus = document.getElementById('sim-status') || 
                        document.getElementById('simulation-status-step4') ||
                        document.querySelector('[id*="simulation-status"]');
      
      let flowResultsEl = document.getElementById('flow-results') || 
                          document.getElementById('simulation-results-step4') ||
                          document.querySelector('[id*="simulation-results"]');
      
      // Clear previous results at the start of each simulation
      if (flowResultsEl) {
        flowResultsEl.textContent = '';
        flowResultsEl.innerHTML = '';
      }
      
      if (!flowResultsEl) {
        flowResultsEl = document.createElement('pre');
        flowResultsEl.id = 'dynamic-flow-results';
        flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
        if (simStatus && simStatus.parentElement) {
          simStatus.parentElement.appendChild(flowResultsEl);
        }
      }
      
      try {
        runJourneySimBtn.disabled = true;
        runJourneySimBtn.textContent = 'ğŸ”„ Simulating Journey...';
        simStatus.textContent = 'Starting customer journey simulation...';
        
        // Try to get journey from processed output first
        let processedJourney = null;
        
        // First try to get journey from window.currentJourneyData (from Copilot processing)
        if (window.currentJourneyData && window.currentJourneyData.journey) {
          processedJourney = window.currentJourneyData.journey;
          console.log('âœ… Using Copilot journey data:', processedJourney.companyName, processedJourney.steps.length, 'steps');
        } else if (currentJourneyData && currentJourneyData.journey) {
          processedJourney = currentJourneyData.journey;
          console.log('Using local currentJourneyData:', processedJourney);
        }
        // If not available, try to parse from journey output element
        else {
          const journeyOutputEl = document.getElementById('journey-output');
          if (journeyOutputEl && journeyOutputEl.textContent.trim()) {
            try {
              const parsedOutput = JSON.parse(journeyOutputEl.textContent);
              if (parsedOutput.journey) {
                processedJourney = parsedOutput.journey;
                console.log('Parsed journey from output:', processedJourney);
              }
            } catch (e) {
              console.error('Failed to parse journey output:', e);
            }
          }
        }
        
        // Use the parsed journey data or fallback to window.lastJourney or create test
        console.log('ğŸ” Journey data analysis:');
        console.log('  - processedJourney:', processedJourney);
        console.log('  - window.lastJourney:', window.lastJourney);
        console.log('  - currentJourneyData:', window.currentJourneyData);
        
        if (processedJourney && processedJourney.steps && processedJourney.steps.length > 0) {
          window.lastJourney = processedJourney;
          lastJourney = processedJourney;
          const errorModeText = errorSimulationEnabled ? ' with errors' : ' (error-free)';
          simStatus.textContent = `ğŸš€ Running ${processedJourney.companyName} simulation (${processedJourney.steps.length} steps)${errorModeText}...`;
          console.log('âœ… Using processed journey with steps:', processedJourney.steps.map(s => s.stepName || s.name || 'unnamed').join(', '));
        } else if (window.lastJourney && window.lastJourney.steps && window.lastJourney.steps.length > 0) {
          lastJourney = window.lastJourney;
          const errorModeText = errorSimulationEnabled ? ' with errors' : ' (error-free)';
          simStatus.textContent = `ğŸš€ Running ${lastJourney.companyName} simulation (${lastJourney.steps.length} steps)${errorModeText}...`;
          console.log('âœ… Using window.lastJourney with steps:', lastJourney.steps.map(s => s.stepName || s.name || 'unnamed').join(', '));
        } else if (!lastJourney || !lastJourney.steps || lastJourney.steps.length === 0) {
          simStatus.textContent = 'âš ï¸ No journey data available. Creating test journey for simulation...';
          
          lastJourney = {
            companyName: 'SimTestCorp',
            domain: 'simtestcorp.com',
            industryType: 'retail',
            steps: [
              { stepName: 'Discovery', description: 'Customer discovery phase' },
              { stepName: 'Evaluation', description: 'Product evaluation' },
              { stepName: 'Decision', description: 'Purchase decision' },
              { stepName: 'Transaction', description: 'Complete transaction' }
            ]
          };
          
          simStatus.textContent = 'âœ… Test journey created! Starting simulation...';
        }
        
        const customerId = `customer_${Date.now()}`;
        const journeyId = `journey_${Date.now()}`;
        
        // Build comprehensive journey data with all available fields
        console.log('ğŸ”§ Processing journey steps for error simulation...');
        const processedSteps = (lastJourney.steps || []).map(step => {
          const processedStep = { ...step };
          
          // Enhanced error simulation processing
          if (errorSimulationEnabled && step.errorHint) {
            console.log(`  - Step "${step.stepName}": Error ${step.errorHint.type} (${step.errorHint.httpStatus}) - Likelihood: ${step.errorHint.likelihood}`);
            processedStep.errorSimulationConfig = {
              enabled: true,
              errorType: step.errorHint.type,
              httpStatus: step.errorHint.httpStatus,
              likelihood: step.errorHint.likelihood,
              shouldSimulateError: Math.random() < step.errorHint.likelihood
            };
          } else if (errorSimulationEnabled) {
            // Fallback error simulation if no errorHint
            processedStep.errorSimulationConfig = {
              enabled: true,
              errorType: 'generic_error',
              httpStatus: 500,
              likelihood: 0.1,
              shouldSimulateError: Math.random() < 0.1
            };
          } else {
            processedStep.errorSimulationConfig = {
              enabled: false,
              shouldSimulateError: false
            };
          }
          
          return processedStep;
        });
        
        console.log(`ğŸ¯ Error simulation mode: ${errorSimulationEnabled ? 'ENABLED' : 'DISABLED'}`);
        console.log(`ğŸ¯ DEBUGGING: errorSimulationEnabled value being sent:`, errorSimulationEnabled, typeof errorSimulationEnabled);
        if (errorSimulationEnabled) {
          const errorSteps = processedSteps.filter(s => s.errorSimulationConfig?.shouldSimulateError);
          console.log(`  - ${errorSteps.length}/${processedSteps.length} steps will simulate errors:`, 
                     errorSteps.map(s => `${s.stepName} (${s.errorSimulationConfig.errorType})`));
        }
        
        const journeyData = {
          steps: processedSteps,
          journeyId: lastJourney.id || journeyId,
          companyName: lastJourney.companyName || 'DefaultCompany',
          domain: lastJourney.domain || 'default.com',
          industryType: lastJourney.industryType || 'general',
          journeyType: lastJourney.journeyType || 'customer_journey',
          description: lastJourney.description || `${lastJourney.companyName || 'Customer'} journey`,
          
          // Include all additional fields from the AI processing (check multiple sources)
          additionalFields: lastJourney.additionalFields || currentJourneyData?.additionalFields || {
            sessionId: `session_${Date.now()}`,
            deviceType: 'desktop',
            userAgent: navigator.userAgent || 'Chrome/118.0.0.0',
            campaignSource: 'organic_search',
            customerSegment: 'premium',
            behaviorScore: 8.5,
            abandonmentRisk: 'low',
            timestamp: new Date().toISOString(),
            simulationMode: true
          },
          
          customerProfile: lastJourney.customerProfile || currentJourneyData?.customerProfile || {
            customerId: customerId,
            age: 32,
            gender: 'F',
            loyaltyTier: 'gold',
            previousPurchases: 15,
            avgOrderValue: 125.50,
            preferredChannel: 'mobile',
            registrationDate: new Date(Date.now() - 365*24*60*60*1000).toISOString(),
            lastLoginDate: new Date().toISOString()
          },
          
          traceMetadata: lastJourney.traceMetadata || currentJourneyData?.traceMetadata || {
            experimentId: 'exp_2025_q4',
            testVariant: 'control',
            featureFlags: ['checkout_v2', 'ai_recommendations'],
            abTestGroup: 'A',
            correlationId: journeyId,
            parentSpanId: null,
            traceId: `trace_${Date.now()}`
          },
          
          // Include business context from form inputs (using safe access)
          formContext: {
            customSteps: safeGetElementValue('customSteps'),
            journeyType: safeGetElementValue('journeyType'),
            details: safeGetElementValue('details'),
            generationMethod: safeGetElementValue('generationMethod', 'copilot')
          },
          
          // Include dynamic additional fields defined by user
          userDefinedFields: (function() {
            try {
              if (typeof additionalFields !== 'undefined' && Array.isArray(additionalFields)) {
                return additionalFields.reduce((acc, field) => {
                  acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                   field.type === 'boolean' ? Math.random() > 0.5 :
                                   field.type === 'array' ? ['sample', 'data'] :
                                   `sample_${field.name}_value`;
                  return acc;
                }, {});
              }
              return {};
            } catch (e) {
              console.warn('additionalFields not available:', e.message);
              return {};
            }
          })(),
            
          // Include comprehensive business event metadata
          businessMetadata: {
            timestamp: new Date().toISOString(),
            sessionId: `session_${Date.now()}`,
            deviceType: 'desktop',
            userAgent: navigator.userAgent || 'Unknown',
            campaignSource: 'simulation',
            customerSegment: lastJourney.customerSegment || 'standard',
            behaviorScore: lastJourney.behaviorScore || Math.floor(Math.random() * 10) + 1,
            abandonmentRisk: lastJourney.abandonmentRisk || 'low',
            experimentId: `exp_${Date.now()}`,
            testVariant: 'simulation',
            featureFlags: lastJourney.featureFlags || ['simulation_mode'],
            abTestGroup: 'simulation',
            region: 'us-east-1',
            environment: 'simulation'
          }
        };
        
        let errorStatusText = '';
        if (errorSimulationEnabled) {
          const errorSteps = processedSteps.filter(s => s.errorSimulationConfig?.shouldSimulateError);
          if (errorSteps.length > 0) {
            const errorTypes = errorSteps.map(s => s.errorSimulationConfig.errorType).join(', ');
            errorStatusText = ` (ğŸ”´ ${errorSteps.length} steps with errors: ${errorTypes})`;
          } else {
            errorStatusText = ' (ğŸŸ¡ Error simulation enabled but no errors will trigger this run)';
          }
        } else {
          errorStatusText = ' (âœ… Error-free mode)';
        }
        simStatus.textContent = `ğŸš€ Running customer journey simulation${errorStatusText}...`;
        
        // Get customer count from UI with validation (defensive programming)
        const customerCountElement = document.getElementById('customerCount');
        const customerCount = customerCountElement ? parseInt(customerCountElement.value) || 1 : 1;
        
        // Validate customer limit
        if (customerCount > 1) {
          simStatus.textContent = 'âŒ Customer limit exceeded. Maximum allowed: 1 customer';
          alert('Customer limit exceeded!\n\nMaximum allowed: 1 customer\nYou entered: ' + customerCount + ' customers\n\nPlease reduce the number and try again.');
          return;
        }
        
        console.log(`Running simulation for ${customerCount} customers`);
        
        // Use appropriate endpoint based on customer count
        const endpoint = customerCount > 1 ? '/api/journey-simulation/simulate-multiple-journeys' : '/api/journey-simulation/simulate-journey';
        
        // Build comprehensive request body with all available data
        const requestBody = {
          journeyId,
          customerId,
          journey: journeyData,  // Complete journey object with all fields
          companyName: journeyData.companyName,
          domain: journeyData.domain,
          industryType: journeyData.industryType,
          journeyType: journeyData.journeyType,
          description: journeyData.description,
          
          // Include all context data in request body for tracing
          additionalFields: journeyData.additionalFields || {},
          customerProfile: journeyData.customerProfile || {},
          traceMetadata: journeyData.traceMetadata || {},
          formContext: journeyData.formContext || {},
          userDefinedFields: journeyData.userDefinedFields || {},
          businessMetadata: journeyData.businessMetadata || {},
          
          // Simulation parameters
          chained: false,
          simulationId: `sim_${Date.now()}`,
          batchId: `batch_${Date.now()}`,
          customerCount: 1,
          errorSimulationEnabled: errorSimulationEnabled
        };
        
        // Add customers parameter for multiple journey endpoint
        if (customerCount > 1) {
          requestBody.customers = customerCount;
        }
        
        const res = await fetch(endpoint, { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify(requestBody) 
        });
        
        const json = await res.json();
        
        if (json.success) {
          // Handle multiple customers response
          if (json.loadTestSummary && customerCount > 1) {
            const summary = json.loadTestSummary;
            
            // Analyze errors to provide better status message
            const errors = json.errors || [];
            const incompleteCount = errors.filter(err => err.includes('incomplete')).length;
            const failureCount = errors.filter(err => !err.includes('incomplete')).length;
            
            let statusIcon = 'âœ…';
            let statusText = '';
            
            if (summary.successfulCustomers === summary.customersProcessed) {
              statusText = `All ${summary.customersProcessed} customers completed successfully!`;
            } else if (summary.successfulCustomers > 0) {
              statusIcon = 'âš ï¸';
              if (incompleteCount > 0) {
                statusText = `${summary.successfulCustomers} completed, ${incompleteCount} partially completed, ${failureCount} failed`;
              } else {
                statusText = `${summary.successfulCustomers} completed successfully, ${summary.failedCustomers} encountered issues`;
              }
            } else {
              statusIcon = 'âŒ';
              if (incompleteCount === summary.customersProcessed) {
                statusText = `All ${summary.customersProcessed} customers partially completed journeys`;
              } else {
                statusText = `${summary.customersProcessed} customers encountered issues (${incompleteCount} partial, ${failureCount} failed)`;
              }
            }
            
            simStatus.textContent = `${statusIcon} ${customerCount} Customer Journey Simulation Complete! ${statusText}`;
            
            const summaryText = [
              `Load Test Results:`,
              `â€¢ Customers Processed: ${summary.customersProcessed}`,
              `â€¢ Successful: ${summary.successfulCustomers}`,
              `â€¢ Failed: ${summary.failedCustomers}`, 
              `â€¢ Success Rate: ${summary.successRate}`,
              `â€¢ Average Completion Time: ${summary.averageCompletionTime}`,
              `â€¢ Average Steps Completed: ${summary.averageStepsCompleted}`,
              ``,
              `Correlation IDs: ${json.correlationIds ? json.correlationIds.slice(0, 3).join(', ') : 'N/A'}${json.correlationIds && json.correlationIds.length > 3 ? '...' : ''}`
            ];
            
            if (json.journeyExample) {
              summaryText.push(``, `Example Journey Execution:`, json.journeyExample.execution);
              summaryText.push(``, `Services Used: ${json.journeyExample.servicesUsed}`);
            }
            
            // Display formatted results
            const timestamp = new Date().toLocaleTimeString();
            flowResultsEl.innerHTML = `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; color: #ffffff;">
                <h4 style="color: #28a745; margin-top: 0;">ğŸ¯ Load Test Complete - ${timestamp}</h4>
                <div style="font-family: 'Courier New', monospace; line-height: 1.6; color: #ffffff;">
                  ${summaryText.join('<br>')}
                </div>
              </div>
            `;
            
          } else {
            // Handle single customer response - enhanced status reporting
            const journey = json.journey;
            const completedSteps = journey.steps.filter(step => step.status === 'completed').length;
            const errorSteps = journey.steps.filter(step => step.status === 'failed' || step.status === 'error').length;
            const totalSteps = journey.totalSteps || journey.steps.length;
            
            let statusMessage = '';
            if (errorSteps === 0) {
              statusMessage = `âœ… Journey Complete! All ${completedSteps} steps successful`;
            } else if (completedSteps > 0) {
              statusMessage = `âš ï¸ Journey Partial: ${completedSteps} successful steps, ${errorSteps} steps with errors`;
            } else {
              statusMessage = `âŒ Journey Failed: ${errorSteps} steps encountered errors`;
            }
            statusMessage += ` | Correlation: ${journey.correlationId}`;
            
            simStatus.textContent = statusMessage;
            
            const stepSummary = journey.steps.map((step, idx) => {
              let status = 'â“';
              if (step.status === 'completed') status = 'âœ…';
              else if (step.status === 'failed' || step.status === 'error') status = 'âŒ';
              else if (step.fallback) status = 'ğŸ”„';
              
              const serviceName = step.serviceName || (step.stepName + 'Service');
              const timing = step.processingTime ? `${step.processingTime}ms` : 'N/A';
              const errorInfo = step.error ? ` (${step.error})` : '';
              return `${status} Step ${idx + 1}: ${serviceName} (${timing})${errorInfo}`;
            }).join('\n');
            
            // ğŸ”§ ARCHITECTURAL IMPROVEMENT: Show actual error configuration from journey data
            const stepsWithErrorsConfigured = window.lastJourney?.steps?.filter(step => step.hasError === true).length || 0;
            const errorConfigDisplay = stepsWithErrorsConfigured > 0 
              ? `ğŸ”´ Error Simulation: ${stepsWithErrorsConfigured}/${totalSteps} steps configured with errors`
              : `âœ… Error Simulation: All steps configured for success`;
              
            const resultSummary = [
              `Customer Journey Execution (${errorConfigDisplay}):`,
              stepSummary,
              ``,
              `Summary: ${completedSteps} successful, ${errorSteps} errors, ${totalSteps} total steps`,
              `Services Used: ${journey.stepNames ? journey.stepNames.join(' â†’ ') : 'N/A'}`,
              `Correlation ID: ${journey.correlationId}`
            ];
            
            // Display formatted results
            const timestamp = new Date().toLocaleTimeString();
            flowResultsEl.innerHTML = `
              <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; border-left: 4px solid #007bff; color: #ffffff;">
                <h4 style="color: #007bff; margin-top: 0;">ğŸš€ Journey Simulation Complete - ${timestamp}</h4>
                <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-line; color: #ffffff;">
                  ${resultSummary.join('\n')}
                </div>
              </div>
            `;
          }
          
        } else {
          simStatus.textContent = `âŒ Journey simulation failed: ${json.error}`;
          // Display formatted error results
          const timestamp = new Date().toLocaleTimeString();
          flowResultsEl.innerHTML = `
            <div style="background: #2d1b1b; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; color: #ffffff;">
              <h4 style="color: #dc3545; margin-top: 0;">âŒ Journey Simulation Failed - ${timestamp}</h4>
              <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">
                ${JSON.stringify(json, null, 2)}
              </div>
            </div>
          `;
        }
        
      } catch (error) {
        console.error('Journey Simulation error:', error);
        simStatus.textContent = `âŒ Journey simulation error: ${error.message}`;
        // Display formatted catch error results
        const timestamp = new Date().toLocaleTimeString();
        flowResultsEl.innerHTML = `
          <div style="background: #2d1b1b; padding: 20px; border-radius: 8px; border-left: 4px solid #dc3545; color: #ffffff;">
            <h4 style="color: #dc3545; margin-top: 0;">ğŸ’¥ Simulation Error - ${timestamp}</h4>
            <div style="font-family: 'Courier New', monospace; line-height: 1.6; white-space: pre-wrap; color: #ffffff;">
              ${error.stack}
            </div>
          </div>
        `;
      } finally {
        runJourneySimBtn.disabled = false;
        runJourneySimBtn.textContent = 'ğŸš€ Step 4 - Run Journey Simulation';
      }
    };

    window.resetServices = async function() {
      console.log('Reset button clicked');
      const chainStatus = document.getElementById('chain-status');
      try {
        chainStatus.textContent = 'Resetting services and restarting essentials...';
        const res = await fetch('/api/admin/reset-and-restart', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: '{}' 
        });
        const json = await res.json();
        chainStatus.textContent = json.ok ? `âœ… ${json.message}` : `âŒ Reset failed: ${json.error || 'Unknown error'}`;
      } catch (e) {
        chainStatus.textContent = `âŒ Reset error: ${e.message}`;
      }
    };

    // New Customer Journey function - clears all services and provides clean slate
    window.startNewCustomerJourney = async function() {
      console.log('New Customer Journey initiated - RESET and KILL all services');
      
      if (!confirm('Start New Customer Journey?\n\nThis will:\nâ€¢ Kill ALL running services\nâ€¢ Reset ALL ports\nâ€¢ Clear all session data\n\nAre you sure?')) {
        return;
      }
      
      try {
        // Step 1: Kill all services
        console.log('ğŸ”¥ Step 1: Killing all services');
        const killRes = await fetch('/api/admin/reset-ports', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        const killResult = await killRes.json();
        
        if (killResult.ok) {
          console.log('âœ… Step 1/3: All services stopped and ports freed. Clearing session data...');
          
          // Step 2: Clear session data and reset UI
          console.log('ğŸ§¹ Step 2: Clearing session data');
          
          // Clear global variables
          window.lastJourney = null;
          window.currentJourneyData = null;
          
          // Clear form inputs safely
          const companyNameEl = document.getElementById('companyName');
          if (companyNameEl) companyNameEl.value = '';
          
          const domainEl = document.getElementById('domain');
          if (domainEl) domainEl.value = '';
          
          const customStepsEl = document.getElementById('customSteps');
          if (customStepsEl) customStepsEl.value = '';
          
          const journeyTypeEl = document.getElementById('journeyType');
          if (journeyTypeEl) journeyTypeEl.value = '';
          
          const detailsEl = document.getElementById('details');
          if (detailsEl) detailsEl.value = '';
          
          // Clear text areas
          const copilotResponseEl = document.getElementById('copilotResponse');
          if (copilotResponseEl) copilotResponseEl.value = '';
          
          const journeyOutput = document.getElementById('journey-output');
          if (journeyOutput) journeyOutput.textContent = '';
          
          // Clear simulation results
          const resultsBox = document.getElementById('simulation-results-step4');
          if (resultsBox) resultsBox.textContent = 'Simulation results will appear here';
          
          console.log('âœ… New Customer Journey ready! All services killed, ports reset, and data cleared.');
          
          // Refresh the service status display
          setTimeout(() => {
            if (window.updateServiceStatus) {
              updateServiceStatus();
            }
          }, 1000);
          
          // Show success message
          alert('ğŸ”„ New Customer Journey Started!\n\nâœ… All services stopped\nâœ… Ports reset\nâœ… Session data cleared\n\nReady for new journey!');
          
        } else {
          console.error('âŒ Failed to kill services:', killResult.error || 'Unknown error');
          alert('âŒ Failed to reset services: ' + (killResult.error || 'Unknown error'));
        }
        
      } catch (e) {
        console.error('New Customer Journey error:', e);
        alert('âŒ Error during reset: ' + e.message);
      }
    };

    // Function to update service status display
    window.updateServiceStatus = async function() {
      console.log('ğŸ”„ updateServiceStatus called');
      
      try {
        
        console.log('ğŸ“¡ Fetching services and ports data...');
        
        // Fetch services data with timeout and better error handling
        let servicesData = { ok: false, services: [] };
        try {
          console.log('ğŸš€ Starting services API call...');
          const servicesController = new AbortController();
          const servicesTimeout = setTimeout(() => servicesController.abort(), 10000);
          
          const servicesRes = await fetch('/api/admin/services/status', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            signal: servicesController.signal
          });
          clearTimeout(servicesTimeout);
          servicesData = await servicesRes.json();
          console.log('ğŸ“Š Services API response:', servicesRes.status, servicesData);
        } catch (servicesError) {
          console.error('âŒ Services API error:', servicesError);
          servicesData = { ok: false, error: servicesError.message };
        }
        
        // Fetch ports data with timeout and better error handling
        let portsData = { ok: false };
        try {
          console.log('ğŸš€ Starting ports API call...');
          const portsController = new AbortController();
          const portsTimeout = setTimeout(() => portsController.abort(), 10000);
          
          const portsRes = await fetch('/api/admin/ports', {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
            signal: portsController.signal
          });
          clearTimeout(portsTimeout);
          portsData = await portsRes.json();
          console.log('ï¿½ Ports API response:', portsRes.status, portsData);
        } catch (portsError) {
          console.error('âŒ Ports API error:', portsError);
          portsData = { ok: false, error: portsError.message };
        }
        
        // Update service list with better error handling
        const servicesList = document.getElementById('service-status-list');
        const servicesLoading = document.getElementById('service-status-loading');
        const servicesListHeader = document.getElementById('service-status-list-header');
        const servicesLoadingHeader = document.getElementById('service-status-loading-header');
        
        if (servicesData.ok && servicesData.services && Array.isArray(servicesData.services) && servicesData.services.length > 0) {
          console.log(`âœ… Found ${servicesData.services.length} running services`);
          
          // Update main service list (if exists)
          if (servicesLoading && servicesList) {
            servicesLoading.classList.add('hidden');
            servicesList.classList.remove('hidden');
            servicesList.innerHTML = servicesData.services.map(service => 
              `<div class="flex justify-between items-center text-xs py-1">
                <div class="flex items-center gap-2 flex-1">
                  <span class="text-dtcyan truncate">${service.service || service.name || 'Unknown Service'}</span>
                  <span class="text-dtgreen">:${service.port || 'N/A'}</span>
                </div>
                <div class="flex gap-1">
                  <button onclick="resetService('${service.service || service.name}', ${service.port})" 
                          class="bg-dtyellow hover:bg-yellow-600 text-black px-2 py-1 rounded text-xs font-bold transition-all" 
                          title="Reset this service">ğŸ”„</button>
                  <button onclick="killService('${service.service || service.name}', ${service.port})" 
                          class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs font-bold transition-all" 
                          title="Kill this service">âŒ</button>
                </div>
              </div>`
            ).join('');
          }
          
          // Update header service list (if exists)
          if (servicesLoadingHeader && servicesListHeader) {
            servicesLoadingHeader.classList.add('hidden');
            servicesListHeader.classList.remove('hidden');
            servicesListHeader.innerHTML = servicesData.services.map(service => 
              `<div class="flex justify-between items-center">
                <span class="text-dtcyan">${(service.service || service.name || 'Unknown').substring(0, 12)}${(service.service || service.name || '').length > 12 ? '...' : ''}</span>
                <span class="text-dtgreen">:${service.port || 'N/A'}</span>
              </div>`
            ).join('');
          }

          // Update dropdown service list
          const servicesDropdownLoading = document.getElementById('service-status-loading-dropdown');
          const servicesDropdownList = document.getElementById('service-status-list-dropdown');
          const servicesCount = document.getElementById('services-count');
          
          if (servicesDropdownLoading && servicesDropdownList) {
            servicesDropdownLoading.classList.add('hidden');
            servicesDropdownList.classList.remove('hidden');
            servicesDropdownList.innerHTML = servicesData.services.map(service => {
              // ğŸ”§ IMPROVED SERVICE NAME FORMATTING
              const serviceName = service.service || service.name || 'Unknown Service';
              
              // Clean up long service names for better readability
              let displayName = serviceName;
              if (serviceName.includes('-')) {
                // For names like "GroceryBrowseAndBasketBuildService-Asda"
                const parts = serviceName.split('-');
                if (parts.length >= 2) {
                  const serviceType = parts[0].replace(/Service$/, ''); // Remove "Service" suffix
                  const company = parts[1];
                  
                  // Add spaces before capital letters for readability
                  const readableServiceType = serviceType.replace(/([A-Z])/g, ' $1').trim();
                  displayName = `${readableServiceType} (${company})`;
                }
              } else if (serviceName.includes('Service')) {
                // For names like "DiscoveryService-DefaultCompany"
                displayName = serviceName.replace(/([A-Z])/g, ' $1').trim().replace('Service', '');
              }
              
              return `<div class="bg-dtgray rounded-lg p-3 border border-dtborder hover:border-dtcyan transition-all">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1 min-w-0 mr-3">
                    <div class="text-dtcyan text-sm font-semibold leading-tight break-words">${displayName}</div>
                    <div class="text-xs text-gray-400 mt-1 font-mono">
                      <span class="inline-block mr-3">ğŸ“¡ Port ${service.port || 'N/A'}</span>
                      <span class="inline-block">ğŸ”§ PID ${service.pid || 'N/A'}</span>
                    </div>
                  </div>
                  <div class="flex-shrink-0">
                    <span class="bg-dtgreen text-black px-2 py-1 rounded-full text-xs font-bold inline-flex items-center">
                      <span class="w-2 h-2 bg-green-400 rounded-full mr-1 animate-pulse"></span>
                      Running
                    </span>
                  </div>
                </div>
                <div class="text-xs text-gray-500 bg-black bg-opacity-30 rounded px-2 py-1 font-mono truncate" title="${serviceName}">
                  ${serviceName}
                </div>
              </div>`;
            }).join('');
          }
          
          // Update services count in button
          if (servicesCount) {
            servicesCount.textContent = `${servicesData.services.length} Services`;
          }
        } else {
          console.log('âš ï¸ No services found or API error:', servicesData);
          
          // Update main service list (if exists)
          if (servicesLoading && servicesList) {
            servicesLoading.classList.remove('hidden');
            servicesList.classList.add('hidden');
            
            if (servicesData.error) {
              servicesLoading.textContent = `Error: ${servicesData.error}`;
            } else if (!servicesData.ok) {
              servicesLoading.textContent = 'API connection failed - services may not be running';
            } else {
              servicesLoading.textContent = 'No services currently running';
            }
          }
          
          // Update header service list (if exists)
          if (servicesLoadingHeader && servicesListHeader) {
            servicesLoadingHeader.classList.remove('hidden');
            servicesListHeader.classList.add('hidden');
            servicesLoadingHeader.textContent = servicesData.error ? 'Error' : '0 running';
          }

          // Update dropdown service list
          const servicesDropdownLoading = document.getElementById('service-status-loading-dropdown');
          const servicesDropdownList = document.getElementById('service-status-list-dropdown');
          const servicesCount = document.getElementById('services-count');
          
          if (servicesDropdownLoading && servicesDropdownList) {
            servicesDropdownLoading.classList.remove('hidden');
            servicesDropdownList.classList.add('hidden');
            
            if (servicesData.error) {
              servicesDropdownLoading.textContent = `Error: ${servicesData.error}`;
            } else if (!servicesData.ok) {
              servicesDropdownLoading.textContent = 'API connection failed - services may not be running';
            } else {
              servicesDropdownLoading.textContent = 'No services currently running';
            }
          }
          
          // Update services count in button
          if (servicesCount) {
            servicesCount.textContent = servicesData.error ? 'Error' : '0 Services';
          }
        }
        
        // Update port status with better error handling
        if (portsData.ok && portsData.portStatus) {
          console.log('ğŸ”Œ Updating port status display');
          document.getElementById('total-ports').textContent = portsData.portStatus.total || '0';
          document.getElementById('available-ports').textContent = portsData.portStatus.available || '0';
          document.getElementById('allocated-ports').textContent = portsData.portStatus.allocated || '0';
          document.getElementById('port-range').textContent = portsData.portStatus.range || 'N/A';
        } else {
          console.log('âŒ Port status data unavailable:', portsData);
          // Show fallback values when ports API fails
          document.getElementById('total-ports').textContent = 'Error';
          document.getElementById('available-ports').textContent = 'Error';
          document.getElementById('allocated-ports').textContent = 'Error';
          document.getElementById('port-range').textContent = 'Error';
        }
        
        // Update last refresh time
        const now = new Date();
        const timeString = now.toLocaleTimeString();
        const lastUpdateEl = document.getElementById('last-update-time');
        if (lastUpdateEl) {
          lastUpdateEl.textContent = `Updated: ${timeString}`;
        }
        
        console.log('âœ… Service status update completed successfully');
        
      } catch (e) {
        console.error('âŒ Error updating service status:', e);
        const servicesLoading = document.getElementById('service-status-loading');
        if (servicesLoading) {
          servicesLoading.textContent = `Connection error: ${e.message}`;
          servicesLoading.classList.remove('hidden');
        }
        
        // Show error in port status too
        document.getElementById('total-ports').textContent = 'Error';
        document.getElementById('available-ports').textContent = 'Error';
        document.getElementById('allocated-ports').textContent = 'Error';
        document.getElementById('port-range').textContent = 'Error';
      } finally {
        // Service status update completed
        console.log('ğŸ”„ Service status refresh finished');
      }
    };

    // Service Management Functions
    window.resetService = async function(serviceName, port) {
      if (!confirm(`Reset service "${serviceName}" on port ${port}?\n\nThis will restart the service.`)) {
        return;
      }
      
      try {
        console.log(`ğŸ”„ Resetting service ${serviceName} on port ${port}`);
        const response = await fetch('/api/admin/services/reset', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serviceName, port })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… Service "${serviceName}" reset successfully!`);
          // Refresh status after reset
          setTimeout(() => updateServiceStatus(), 2000);
        } else {
          alert(`âŒ Failed to reset service "${serviceName}": ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Reset service error:', error);
        alert(`âŒ Error resetting service "${serviceName}": ${error.message}`);
      }
    };

    window.killService = async function(serviceName, port) {
      if (!confirm(`Kill service "${serviceName}" on port ${port}?\n\nThis will terminate the service permanently.`)) {
        return;
      }
      
      try {
        console.log(`âŒ Killing service ${serviceName} on port ${port}`);
        const response = await fetch('/api/admin/services/kill', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serviceName, port })
        });
        
        let result;
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error('Non-JSON response from kill service:', text);
          result = { success: false, error: 'Server returned non-JSON response' };
        }
        
        if (result.success) {
          alert(`âœ… Service "${serviceName}" killed successfully!`);
          // Refresh status after kill
          setTimeout(() => updateServiceStatus(), 1000);
        } else {
          alert(`âŒ Failed to kill service "${serviceName}": ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Kill service error:', error);
        alert(`âŒ Error killing service "${serviceName}": ${error.message}`);
      }
    };

    window.resetAllServices = async function() {
      if (!confirm('Reset ALL services?\n\nThis will restart all running services.')) {
        return;
      }
      
      try {
        console.log('ğŸ”„ Resetting all services');
        const response = await fetch('/api/admin/services/reset-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… All services reset successfully! ${result.resetCount || 0} services restarted.`);
          // Refresh status after reset
          setTimeout(() => updateServiceStatus(), 3000);
        } else {
          alert(`âŒ Failed to reset all services: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Reset all services error:', error);
        alert(`âŒ Error resetting all services: ${error.message}`);
      }
    };

    window.killAllServices = async function() {
      if (!confirm('Kill ALL services?\n\nThis will terminate all running services permanently.')) {
        return;
      }
      
      try {
        console.log('âŒ Killing all services');
        const response = await fetch('/api/admin/services/kill-all', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`âœ… All services killed successfully! ${result.killedCount || 0} services terminated.`);
          // Refresh status after kill
          setTimeout(() => updateServiceStatus(), 2000);
        } else {
          alert(`âŒ Failed to kill all services: ${result.error || 'Unknown error'}`);
        }
      } catch (error) {
        console.error('Kill all services error:', error);
        alert(`âŒ Error killing all services: ${error.message}`);
      }
    };

    // LoadRunner Integration Functions
    let currentTestId = null;
    let testPollingInterval = null;

    window.startLoadRunnerTest = async function() {
      const startBtn = document.getElementById('start-loadrunner-test');
      const statusEl = document.getElementById('loadrunner-status');
      const resultsEl = document.getElementById('loadrunner-results');
      const profileSelect = document.getElementById('loadrunner-profile');
      const durationInput = document.getElementById('loadrunner-duration');

      try {
        if (!lastJourney || !lastJourney.steps || !lastJourney.steps.length) {
          statusEl.textContent = 'âš ï¸ No journey available! Please generate a journey first.';
          statusEl.className = 'mt-3 text-sm text-red-400 font-medium';
          return;
        }

        startBtn.disabled = true;
        startBtn.textContent = 'ğŸ”„ Starting Test...';
        statusEl.textContent = 'ğŸš€ Initializing LoadRunner test...';
        statusEl.className = 'mt-3 text-sm text-dtyellow font-medium';
        resultsEl.classList.add('hidden');

        const testConfig = {
          testProfile: profileSelect.value,
          durationMinutes: parseInt(durationInput.value) || 5
        };

        const response = await fetch('/api/loadrunner/start-test', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            journeyConfig: lastJourney,
            errorSimulationEnabled: errorSimulationEnabled,
            ...testConfig
          })
        });

        const result = await response.json();

        if (result.success) {
          currentTestId = result.testId;
          const errorModeStatus = errorSimulationEnabled ? 'ğŸ”´ With Errors' : 'âœ… Error-Free Mode';
          statusEl.innerHTML = `
            âœ… Test started successfully!<br>
            ğŸ“Š Method: ${result.method}<br>
            â±ï¸ Duration: ${result.estimatedDuration}<br>
            ğŸ¯ Mode: ${errorModeStatus}<br>
            ğŸ†” Test ID: ${result.testId.substring(0, 8)}...
          `;
          statusEl.className = 'mt-3 text-sm text-dtgreen font-medium';
          
          startBtn.textContent = 'ğŸƒ Test Running...';
          
          // Start polling for test status
          startTestPolling();
        } else {
          throw new Error(result.error || 'Failed to start test');
        }

      } catch (error) {
        console.error('LoadRunner test error:', error);
        statusEl.textContent = `âŒ Error: ${error.message}`;
        statusEl.className = 'mt-3 text-sm text-red-400 font-medium';
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸš€ Start LoadRunner Test';
      }
    };

    window.stopLoadRunnerTest = async function() {
      if (!currentTestId) return;

      try {
        const response = await fetch(`/api/loadrunner/stop/${currentTestId}`, {
          method: 'POST'
        });

        const result = await response.json();
        
        if (result.success) {
          document.getElementById('loadrunner-status').textContent = 'â¹ï¸ Test stopped by user';
          document.getElementById('loadrunner-status').className = 'mt-3 text-sm text-dtyellow font-medium';
          stopTestPolling();
          resetLoadRunnerUI();
        }
      } catch (error) {
        console.error('Error stopping test:', error);
      }
    };

    window.viewLoadRunnerResults = async function() {
      if (!currentTestId) return;

      try {
        const response = await fetch(`/api/loadrunner/results/${currentTestId}`);
        
        if (response.ok) {
          const resultsWindow = window.open('', '_blank');
          const resultsHtml = await response.text();
          resultsWindow.document.write(resultsHtml);
          resultsWindow.document.close();
        } else {
          alert('Test results not yet available. Please wait for the test to complete.');
        }
      } catch (error) {
        console.error('Error viewing results:', error);
        alert('Error loading test results');
      }
    };

    function startTestPolling() {
      if (testPollingInterval) clearInterval(testPollingInterval);
      
      testPollingInterval = setInterval(async () => {
        if (!currentTestId) return;

        try {
          const response = await fetch(`/api/loadrunner/status/${currentTestId}`);
          const status = await response.json();

          if (status.success) {
            updateTestStatus(status);
            
            if (status.status === 'completed' || status.status === 'failed' || status.status === 'stopped') {
              stopTestPolling();
              showTestResults(status);
            }
          }
        } catch (error) {
          console.error('Error polling test status:', error);
        }
      }, 5000); // Poll every 5 seconds
    }

    function stopTestPolling() {
      if (testPollingInterval) {
        clearInterval(testPollingInterval);
        testPollingInterval = null;
      }
    }

    function updateTestStatus(status) {
      const statusEl = document.getElementById('loadrunner-status');
      const elapsedTime = status.startTime ? 
        Math.floor((new Date() - new Date(status.startTime)) / 1000) : 0;
      
      statusEl.innerHTML = `
        ğŸƒ Test in progress...<br>
        ğŸ“Š Method: ${status.method}<br>
        â±ï¸ Elapsed: ${Math.floor(elapsedTime / 60)}:${(elapsedTime % 60).toString().padStart(2, '0')}<br>
        ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}<br>
        ğŸ¯ Company: ${status.journeyConfig.companyName}<br>
        ğŸ“‹ Steps: ${status.journeyConfig.stepCount}
      `;
      statusEl.className = 'mt-3 text-sm text-dtblue font-medium';
    }

    function showTestResults(status) {
      const statusEl = document.getElementById('loadrunner-status');
      const resultsEl = document.getElementById('loadrunner-results');
      const summaryEl = document.getElementById('loadrunner-summary');

      if (status.status === 'completed') {
        statusEl.innerHTML = `
          âœ… Test completed successfully!<br>
          â±ï¸ Duration: ${status.testConfig.duration / 60} minutes<br>
          ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}<br>
          ğŸ“Š Method: ${status.method}
        `;
        statusEl.className = 'mt-3 text-sm text-dtgreen font-medium';

        summaryEl.innerHTML = `
          <div class="text-sm space-y-1">
            <div>Company: <span class="text-dtcyan">${status.journeyConfig.companyName}</span></div>
            <div>Journey Steps: <span class="text-dtcyan">${status.journeyConfig.stepCount}</span></div>
            <div>Virtual Users: <span class="text-dtcyan">${status.testConfig.virtualUsers}</span></div>
            <div>Test Duration: <span class="text-dtcyan">${status.testConfig.duration / 60} minutes</span></div>
            <div>Status: <span class="text-dtgreen">âœ… Completed</span></div>
          </div>
        `;

        resultsEl.classList.remove('hidden');
      } else {
        statusEl.innerHTML = `
          âŒ Test ${status.status}<br>
          â±ï¸ Duration: ${status.testConfig.duration / 60} minutes<br>
          ğŸ‘¥ Virtual Users: ${status.testConfig.virtualUsers}
        `;
        statusEl.className = 'mt-3 text-sm text-red-400 font-medium';
      }

      resetLoadRunnerUI();
    }

    function resetLoadRunnerUI() {
      const startBtn = document.getElementById('start-loadrunner-test');
      startBtn.disabled = false;
      startBtn.textContent = 'ğŸš€ Start LoadRunner Test';
    }

    // Handle generation method change
    document.getElementById('generationMethod').addEventListener('change', (e) => {
      const copilotWorkflow = document.getElementById('copilotWorkflow');
      const templateExample = document.getElementById('templateExample');
      const customStepsContainer = document.getElementById('customStepsContainer');
      const optionalFieldsContainer = document.getElementById('optionalFieldsContainer');
      const journeyForm = document.getElementById('journey-form');
      
      if (e.target.value === 'copilot') {
        copilotWorkflow.classList.remove('hidden');
        templateExample.classList.add('hidden');
        // In Copilot mode: show basic form fields, hide template-specific fields
        journeyForm.classList.remove('hidden');
        customStepsContainer.style.display = 'none';
        optionalFieldsContainer.style.display = 'none';
        generateCopilotPrompt();
      } else {
        copilotWorkflow.classList.add('hidden');
        templateExample.classList.remove('hidden');
        // In Template mode: show all form fields except journey requirements
        journeyForm.classList.remove('hidden');
        customStepsContainer.style.display = 'block';
        optionalFieldsContainer.style.display = 'block';
        journeyRequirementsContainer.style.display = 'none';
        
        // Pre-fill form fields with retail example values
        document.getElementById('companyName').value = 'ShopMart';
        document.getElementById('domain').value = 'shopmart.com';
        document.getElementById('industryType').value = 'retail';
        document.getElementById('customSteps').value = 'Product Discovery, Product Selection, Cart Addition, Checkout Process, Order Confirmation, Post Purchase';
        document.getElementById('journeyType').value = 'E-commerce Purchase';
        document.getElementById('details').value = 'Customer journey for online retail shopping experience';
      }
    });

    // Add event listeners to form inputs to auto-update prompt
    document.getElementById('companyName').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });
    
    document.getElementById('domain').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });
    // Additional Fields listeners
    let additionalFields = [];

    // Helper functions for industry-specific data (moved up to be available early)
    function getIndustryDemographic(industry) {
      const demographics = {
        'telecommunications': 'mobile users aged 25-45',
        'banking': 'working professionals aged 30-55',
        'retail': 'consumers aged 18-65',
        'travel': 'leisure travelers aged 25-60',
        'insurance': 'policy holders aged 25-50',
        'healthcare': 'patients aged 20-70',
        'education': 'learners aged 18-40',
        'technology': 'tech professionals aged 25-45'
      };
      return demographics[industry.toLowerCase()] || 'general consumers';
    }

    function getIndustryPainPoints(industry) {
      const painPoints = {
        'telecommunications': ['poor network coverage', 'expensive bills'],
        'banking': ['complex fees', 'poor customer service'],
        'retail': ['high prices', 'limited selection'],
        'travel': ['complicated booking', 'hidden fees'],
        'insurance': ['confusing policies', 'high premiums'],
        'healthcare': ['long wait times', 'complex scheduling'],
        'education': ['course complexity', 'time constraints'],
        'technology': ['learning curve', 'integration challenges']
      };
      return painPoints[industry.toLowerCase()] || ['complexity', 'cost'];
    }

    function getIndustryGoals(industry, company) {
      const goals = {
        'telecommunications': ['reliable connectivity', 'value for money'],
        'banking': ['financial security', 'easy banking'],
        'retail': ['quality products', 'good prices'],
        'travel': ['smooth booking', 'great experience'],
        'insurance': ['comprehensive coverage', 'fair pricing'],
        'healthcare': ['quality care', 'convenient access'],
        'education': ['skill development', 'career advancement'],
        'technology': ['improved efficiency', 'seamless integration']
      };
      return goals[industry.toLowerCase()] || ['good service', 'value for money'];
    }

    function getIndustryValue(industry) {
      const values = {
        'telecommunications': 2000,
        'banking': 5000,
        'retail': 1500,
        'travel': 3000,
        'insurance': 4000,
        'healthcare': 2500,
        'education': 1800,
        'technology': 3500
      };
      return values[industry.toLowerCase()] || 2000;
    }

    function getIndustryLocation(industry) {
      const locations = {

        'retail': 'Manchester, UK',
        'travel': 'Edinburgh, UK',
        'insurance': 'Birmingham, UK',
        'healthcare': 'Leeds, UK',
        'education': 'Oxford, UK',
        'technology': 'Cambridge, UK'
      };
      return locations[industry.toLowerCase()] || 'Global';
    }

    function getIndustryConversion(industry) {
      const conversions = {
        'telecommunications': 0.65,
        'banking': 0.45,
        'retail': 0.75,
        'travel': 0.55,
        'insurance': 0.35,
        'healthcare': 0.60,
        'education': 0.50,
        'technology': 0.40
      };
      return conversions[industry.toLowerCase()] || 0.50;
    }

    function getIndustryTags(industry) {
      const tags = {
        'telecommunications': ['mobile', 'connectivity'],
        'banking': ['finance', 'security'],
        'retail': ['shopping', 'products'],
        'travel': ['booking', 'leisure'],
        'insurance': ['protection', 'coverage'],
        'healthcare': ['wellness', 'care'],
        'education': ['learning', 'skills'],
        'technology': ['innovation', 'efficiency']
      };
      return tags[industry.toLowerCase()] || ['service', 'quality'];
    }
    function renderAdditionalFields() {
      const list = document.getElementById('additionalFieldsList');
      list.innerHTML = '';
      additionalFields.forEach((field, idx) => {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center mb-1';
        div.innerHTML = `<span class="text-xs text-dtcyan">${field.name}</span><span class="text-xs text-gray-400">(${field.type})</span><button type="button" class="bg-dtpurple text-white px-2 py-0 rounded text-xs" data-remove="${idx}">Remove</button>`;
        list.appendChild(div);
      });
      Array.from(list.querySelectorAll('button[data-remove]')).forEach(btn => {
        btn.onclick = () => {
          const idx = Number(btn.getAttribute('data-remove'));
          additionalFields.splice(idx, 1);
          renderAdditionalFields();
          generateCopilotPrompt();
        };
      });
    }
    document.getElementById('addFieldBtn').onclick = () => {
      const name = document.getElementById('newFieldName').value.trim();
      const type = document.getElementById('newFieldType').value;
      if (!name) return;
      additionalFields.push({ name, type });
      document.getElementById('newFieldName').value = '';
      document.getElementById('newFieldType').value = 'string';
      renderAdditionalFields();
      generateCopilotPrompt();
    };
    


    document.getElementById('journeyRequirements').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });

    document.getElementById('customSteps').addEventListener('input', () => {
      if (document.getElementById('generationMethod').value === 'copilot') {
        generateCopilotPrompt();
      }
    });

  // Generate Copilot Prompt
    function generateCopilotPrompt() {
      console.log('generateCopilotPrompt called');
      
      try {
        const companyName = document.getElementById('companyName')?.value || '[Company Name]';
        const domain = document.getElementById('domain')?.value || '[company-domain.com]';
        const journeyRequirements = document.getElementById('journeyRequirements')?.value || '[Journey Requirements]';
        
        console.log('Debug - Company:', companyName, 'Domain:', domain);
        console.log('Debug - Journey Requirements:', journeyRequirements);
        console.log('Generating prompts...');



        // Generate Copilot Prompt 1: C-suite Analysis
        const csuitePrompt = `${companyName} at ${domain} is the focus for this chat.

You are a business analyst conducting research to understand this company's strategic priorities and technology needs for creating realistic customer journey simulations.

Build a structured summary of the top three business objectives and operational priorities of ${companyName}, with supporting details, using public sources and 2025 insights, to understand their customer journey context and business metrics.

Gather the top three critical business objectives of the company's leadership team, focusing on recent 2024 or 2025 insights. For each objective, collect and present:

1. Objective Name & Description: Clearly state the objective and explain its relevance to the company. Each objective 6 words, no fluff

2. Organizational Initiatives: Identify what the company is doing to address this objective, focusing on IT-related initiatives, programs, partnerships, or investments. 16 words, no fluff

3. KPIs: Suggest one KPI that is the focus of this objective and describe it in 5 words, no fluff.

4. Challenges or Risks: Detail any challenges or risks that make this objective difficult to achieve. Make this a list of three bullet points with maximum 6 words, no fluff

5. Technology Dependencies: Identify the key technology systems, digital platforms, or IT infrastructure that support each objective, focusing on customer-facing systems and operational processes.

6. Success Metrics: Define the primary business metrics, KPIs, or performance indicators that would measure progress toward each objective, including revenue, efficiency, customer satisfaction, or operational metrics.

Format the response as a structured analysis suitable for understanding the company's business context and customer journey requirements. Use only publicly available information and cite sources where applicable. Focus on insights relevant as of 2024 or 2025. If the company is a public company with an investor relations web page, prioritize results from these pages.`;

        // Generate Copilot Prompt 2: Customer Journey with reference to business analysis
        const journeyPrompt = `Create a customer journey JSON for ${companyName} (${domain}) based on your previous analysis.

ğŸ¯ SPECIFIC JOURNEY REQUIREMENTS: "${journeyRequirements}"

The customer journey MUST specifically model and simulate the scenario described in the journey requirements above. Design the journey steps, durations, and business logic to directly address this specific use case while maintaining industry best practices and realistic durations.

âš ï¸ CRITICAL: Must include duration fields or response will be rejected âš ï¸

Return JSON with this structure:
{
  "journey": {
    "companyName": "${companyName}",
    "domain": "${domain}",
    "industryType": "[Use industry from C-suite analysis]",
    "journeyId": "journey_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_2025",
    "journeyStartTime": "2025-11-21T00:00:00.000Z",
    "steps": [
      {
        "stepIndex": 1,
        "stepName": "[IndustrySpecificStepName]",
        "serviceName": "[IndustrySpecificStepNameService]",
        "description": "[What happens in this step]",
        "category": "[StepCategory]",
        "timestamp": "2025-11-21T00:00:00.000Z",
        "estimatedDuration": "[realistic_minutes]",
        "businessRationale": "[Why this duration for this industry]",
        "substeps": [
          {"substepName": "[substep description]", "duration": "[minutes]"},
          {"substepName": "[substep description]", "duration": "[minutes]"}
        ]
      }
    ]
  },
  "customerProfile": {
    "userId": "user_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_001",
    "email": "customer@${domain.replace(/^https?:\/\//, '').replace(/^www\./, '')}",
    "demographic": "[Industry-based demographics]",
    "painPoints": ["[From business analysis]", "[From objectives]"],
    "goals": ["[From business objectives]", "[From success metrics]"]
  },
  "traceMetadata": {
    "correlationId": "trace_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_2025",
    "sessionId": "session_${companyName.toLowerCase().replace(/[^a-z0-9]/g, '')}_001",
    "businessContext": {
      "campaignSource": "[e.g. Organic Search, Paid Search, Social Media]",
      "customerSegment": "[e.g. premium, standard, enterprise]",
      "businessValue": "[e.g. Â£1,250]",
      "revenueImpact": "[e.g. Â£450 per customer]",
      "transactionAmount": "[e.g. Â£89.99]"
    }
  },
  "additionalFields": {
    "deviceType": "[Mobile|Desktop|Tablet]",
    "entryChannel": "[Organic Search|Paid Search|Social|Email|Direct]",
    "customerIntent": "[Purchase|Research|Comparison|Support]",
    "loyaltyStatus": "[New|Returning|VIP|Lapsed]",
    "businessPriority": "[Map to top C-suite objective]",
    "transactionValue": "[e.g. Â£75.50]",
    "currency": "[GBP|USD|EUR]",
    "customerSegment": "[premium|standard|basic|enterprise]",
    "customerLifetimeValue": "[e.g. Â£650.00]",
    "acquisitionCost": "[e.g. Â£28.50]",
    "retentionProbability": "[e.g. 72%]",
    "profitMargin": "[e.g. 18.5%]",
    "productSKUs": ["[e.g. SKU-001]", "[e.g. SKU-002]"],
    "productCategories": ["[e.g. Electronics: Â£2.3M]"],
    "inventoryLevels": "[e.g. 1,250 units]",
    "discountPercentage": "[e.g. 15%]",
    "shippingCost": "[e.g. Â£4.99 or Free]",
    "taxRate": "[e.g. 20% VAT]",
    "primaryBusinessOutcome": "[From business analysis]",
    "expectedROI": "[e.g. 125%]",
    "revenueGrowthPotential": "[e.g. 12.5%]",
    "averageOrderValue": "[e.g. Â£67.25]",
    "conversionRate": "[e.g. 3.2%]",
    "customerRetentionRate": "[e.g. 78%]",
    "marketSegment": "[Enterprise|Mid-market|SMB]",
    "competitivePosition": "[Leader|Challenger|Follower]",
    "digitalTransformationPhase": "[Planning|Implementing|Optimizing]",
    "operationalMetrics": {
      "responseTime": "[e.g. 1.2s]",
      "errorRate": "[e.g. 0.08%]",
      "systemUptime": "[e.g. 99.87%]",
      "dailyTransactionVolume": "[e.g. 2,847]"
    },
    "customField_BusinessObjective1": "[Value from first C-suite objective]",
    "customField_BusinessObjective2": "[Value from second C-suite objective]",
    "customField_BusinessObjective3": "[Value from third C-suite objective]"
  }
}

Requirements:
- Create exactly 6 industry-specific steps based on C-suite analysis
- Every step needs estimatedDuration (minutes) and businessRationale
- Every substep needs duration (minutes) - substeps must add up to step duration
- ServiceName = StepName + 'Service' in PascalCase format
- Use realistic durations for the identified industry
- Only step 1 needs timestamp field
- Replace ALL bracketed placeholders with actual values
- Use industry-appropriate terminology and realistic metrics
- Custom fields must derive from the three business objectives identified
- ProductSKUs should be realistic format (e.g. "TOY-LEGO-001", "GAM-XBOX-045")
- ProductCategories should include specific revenue/volume data
- All percentage values should be numeric (e.g. 0.72 not "72%")
- Durations must be numeric integers, not strings

âš ï¸ NO TIMESTAMPS = REJECTED RESPONSE âš ï¸`;

        console.log('Setting prompt text 1:', csuitePrompt.substring(0, 100) + '...');
        console.log('Setting prompt text 2:', journeyPrompt.substring(0, 100) + '...');
        
        const promptText1Element = document.getElementById('promptText1-step2');
        const promptText2Element = document.getElementById('promptText2-step2');
        
        if (promptText1Element) {
          promptText1Element.value = csuitePrompt;
          console.log('Prompt 1 set successfully, length:', csuitePrompt.length);
        } else {
          console.error('promptText1-step2 element not found!');
        }
        
        if (promptText2Element) {
          promptText2Element.value = journeyPrompt;
          console.log('Prompt 2 set successfully, length:', journeyPrompt.length);
        } else {
          console.error('promptText2-step2 element not found!');
        }

        // Keep backward compatibility with old promptText element
        const promptTextElement = document.getElementById('promptText');
        if (promptTextElement) {
          promptTextElement.value = csuitePrompt + '\n\n---\n\n' + journeyPrompt;
        console.log('Prompt set successfully, length:', prompt.length);
        // Force a visual refresh
        promptTextElement.style.display = 'none';
        promptTextElement.offsetHeight; // trigger reflow
        promptTextElement.style.display = '';
      } else {
        console.error('promptText element not found!');
      }
      } catch (error) {
        console.error('Error generating prompt:', error);
        const promptTextElement = document.getElementById('promptText');
        if (promptTextElement) {
          promptTextElement.value = 'Error generating prompt. Please refresh the page.';
        }
      }
    }

    // Add event listeners to update prompt when fields change
    ['companyName', 'domain'].forEach(fieldId => {
      document.getElementById(fieldId).addEventListener('input', () => {
        if (document.getElementById('generationMethod').value === 'copilot') {
          generateCopilotPrompt();
        }
      });
    });

    // Industry-specific step name generation
    function getIndustrySpecificSteps(industry, company) {
      const steps = {
        'telecommunications': ['Discovery', 'PlanExploration', 'ServiceSelection', 'AccountSetup', 'ServiceActivation', 'PostActivation'],
        'banking': ['Discovery', 'ProductExploration', 'ApplicationStart', 'IdentityVerification', 'AccountOpening', 'FirstTransaction'],
        'retail': ['Discovery', 'ProductBrowsing', 'ItemSelection', 'Checkout', 'OrderConfirmation', 'PostPurchase'],
        'travel': ['Discovery', 'DestinationExploration', 'BookingSelection', 'ReservationProcess', 'BookingConfirmation', 'TripManagement'],
        'insurance': ['Discovery', 'QuoteExploration', 'PolicySelection', 'ApplicationProcess', 'PolicyIssuance', 'PolicyManagement'],
        'healthcare': ['Discovery', 'ServiceExploration', 'AppointmentScheduling', 'Registration', 'ServiceDelivery', 'FollowUp'],
        'education': ['Discovery', 'CourseExploration', 'EnrollmentProcess', 'Registration', 'LearningStart', 'ProgressTracking'],
        'technology': ['Discovery', 'FeatureExploration', 'TrialSignup', 'Implementation', 'GoLive', 'Optimization']
      };
      return steps[industry.toLowerCase()] || ['Discovery', 'Exploration', 'Selection', 'ProcessStart', 'Completion', 'PostProcess'];
    }

    function getIndustryExample(industry, company, domain) {
      const examples = {
        'telecommunications': '{"searchTerm": "' + company + ' mobile plans", "referrer": "google", "device": "mobile"}',
        'banking': '{"searchTerm": "' + company + ' savings account", "referrer": "google", "device": "desktop"}',
        'retail': '{"searchTerm": "' + company + ' products", "referrer": "social", "device": "mobile"}',
        'travel': '{"searchTerm": "' + company + ' flights", "referrer": "google", "device": "tablet"}',
        'insurance': '{"searchTerm": "' + company + ' car insurance", "referrer": "comparison", "device": "desktop"}',
        'healthcare': '{"searchTerm": "' + company + ' appointments", "referrer": "direct", "device": "mobile"}',
        'education': '{"searchTerm": "' + company + ' courses", "referrer": "google", "device": "desktop"}',
        'technology': '{"searchTerm": "' + company + ' software", "referrer": "google", "device": "desktop"}'
      };
      return examples[industry.toLowerCase()] || '{"searchTerm": "' + company + '", "referrer": "google", "device": "mobile"}';
    }

    // COMPLETELY REWRITTEN COPY FUNCTIONALITY
    function setupCopyButtons() {
      console.log('ğŸ”§ Setting up copy buttons with new method...');
      
      // Modern copy function that actually works
      async function copyToClipboard(text) {
        console.log('ğŸ“‹ Attempting to copy:', text.length, 'characters');
        
        try {
          // Try modern clipboard API first
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
            console.log('âœ… Copied with modern API');
            return true;
          }
        } catch (err) {
          console.log('Modern API failed, trying fallback:', err);
        }
        
        // Fallback method
        try {
          const textArea = document.createElement('textarea');
          textArea.value = text;
          
          // Make the textarea visible but off-screen
          textArea.style.position = 'absolute';
          textArea.style.left = '-9999px';
          textArea.style.top = '0';
          textArea.style.width = '1px';
          textArea.style.height = '1px';
          textArea.style.opacity = '0';
          
          document.body.appendChild(textArea);
          
          // Focus and select all text
          textArea.focus();
          textArea.select();
          textArea.setSelectionRange(0, text.length);
          
          // Try to copy
          const result = document.execCommand('copy');
          document.body.removeChild(textArea);
          
          if (result) {
            console.log('âœ… Copied with fallback method');
            return true;
          } else {
            console.log('âŒ Fallback method failed');
            return false;
          }
        } catch (err) {
          console.error('âŒ All copy methods failed:', err);
          return false;
        }
      }
      
      // Direct button setup without waiting
      console.log('ğŸ”§ Setting up copy buttons immediately...');
      
      // Copy Prompt 1
      const btn1 = document.getElementById('copyPrompt1');
      if (btn1) {
        btn1.onclick = async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ¯ Copy Prompt 1 clicked!');
          
          const textarea = document.getElementById('promptText1');
          if (!textarea || !textarea.value.trim()) {
            alert('Please generate the prompts first! Fill in Company Name and Domain, then click "Generate Copilot Prompts".');
            return;
          }
          
          const success = await copyToClipboard(textarea.value);
          if (success) {
            const original = btn1.textContent;
            btn1.textContent = 'âœ… Copied!';
            btn1.style.backgroundColor = '#10b981';
            setTimeout(() => {
              btn1.textContent = original;
              btn1.style.backgroundColor = '';
            }, 2000);
          } else {
            alert('Copy failed! Please manually select and copy the text from the textarea below.');
          }
        };
        console.log('âœ… Button 1 setup complete');
      }
      
      // Copy Prompt 2  
      const btn2 = document.getElementById('copyPrompt2');
      if (btn2) {
        btn2.onclick = async function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ¯ Copy Prompt 2 clicked!');
          
          const textarea = document.getElementById('promptText2');
          if (!textarea || !textarea.value.trim()) {
            alert('Please generate the prompts first! Fill in Company Name and Domain, then click "Generate Copilot Prompts".');
            return;
          }
          
          const success = await copyToClipboard(textarea.value);
          if (success) {
            const original = btn2.textContent;
            btn2.textContent = 'âœ… Copied!';
            btn2.style.backgroundColor = '#10b981';
            setTimeout(() => {
              btn2.textContent = original;
              btn2.style.backgroundColor = '';
            }, 2000);
          } else {
            alert('Copy failed! Please manually select and copy the text from the textarea below.');
          }
        };
        console.log('âœ… Button 2 setup complete');
      }
    }

    // Process Copilot Response - Fixed to ensure DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const processBtn = document.getElementById('processResponse');
      if (processBtn) {
        console.log('âœ… Process button found, attaching event listener');
        processBtn.addEventListener('click', () => {
          console.log('ğŸš€ Step 4 - Process button clicked');
          const responseText = document.getElementById('copilotResponse').value.trim();
          console.log('Response text length:', responseText.length);
          
          if (!responseText) {
            alert('Please paste your Copilot response first');
            return;
          }

          try {
            const parsedResponse = JSON.parse(responseText);
            if (parsedResponse.journey && parsedResponse.journey.steps) {
              // Set the global variables for journey simulation with complete data
              lastJourney = {
                ...parsedResponse.journey,
                additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
                customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
                traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
              };
              currentJourneyData = parsedResponse;

              // Display journey with additional fields info
              const displayData = {
                journey: parsedResponse.journey,
                customerProfile: parsedResponse.customerProfile,
                traceMetadata: parsedResponse.traceMetadata,
                additionalFields: parsedResponse.additionalFields
              };

              // Get elements by ID to ensure they exist
              const journeyOutputEl = document.getElementById('journey-output');
              const journeyProviderEl = document.getElementById('journey-provider');
              const journeySourcesEl = document.getElementById('journey-sources');
              
              console.log('Setting journey output...');

              if (journeyOutputEl) {
                journeyOutputEl.textContent = JSON.stringify(displayData, null, 2);
                console.log('âœ… Journey output set, length:', journeyOutputEl.textContent.length);
              } else {
                console.error('âŒ journey-output element not found');
              }
              
              if (journeyProviderEl) {
                journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
              } else {
                console.error('âŒ journey-provider element not found');
              }
              
              if (journeySourcesEl) {
                journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
              } else {
                console.error('âŒ journey-sources element not found');
              }

              const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
              alert('Journey processed successfully! Includes ' + fieldsCount + ' additional tracking fields.');
            } else {
              alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
            }
          } catch (error) {
            console.error('JSON Parse Error:', error);
            alert('Invalid JSON format. Error: ' + error.message);
          }
        });
      } else {
        console.error('âŒ Process button not found!');
      }
    });

    // Reset Workflow - RESTORED ORIGINAL LOGIC
    document.getElementById('resetWorkflow').addEventListener('click', () => {
      console.log('ğŸ”„ Reset workflow clicked');
      document.getElementById('copilotResponse').value = '';
      
      const journeyOutputEl = document.getElementById('journey-output');
      const journeyProviderEl = document.getElementById('journey-provider');  
      const journeySourcesEl = document.getElementById('journey-sources');
      
      if (journeyOutputEl) journeyOutputEl.textContent = '';
      if (journeyProviderEl) journeyProviderEl.textContent = '';
      if (journeySourcesEl) journeySourcesEl.innerHTML = '';
      
      if (typeof generateCopilotPrompt === 'function') {
        generateCopilotPrompt();
      }
    });

    // Generate Journey (Both Template and Copilot Mode)
    document.getElementById('generateJourney').addEventListener('click', async () => {
      const generationMethod = document.getElementById('generationMethod').value;
      
      if (generationMethod === 'copilot') {
        // For Copilot mode, create a basic journey structure with the provided requirements
        const companyName = document.getElementById('companyName').value || 'YourCompany';
        const domain = document.getElementById('domain').value || 'yourcompany.com';
        const industryType = document.getElementById('industryType').value || 'general';
        const journeyRequirements = document.getElementById('journeyRequirements').value || 'Standard customer journey';
        
        // Create a simple journey structure for simulation with proper service names
        const basicJourney = {
          companyName,
          domain,
          industryType,
          steps: [
            { 
              stepName: 'Discovery', 
              description: 'Initial customer discovery',
              serviceName: 'DiscoveryService',
              substeps: [{ serviceName: 'DiscoveryService' }]
            },
            { 
              stepName: 'Awareness', 
              description: 'Customer becomes aware',
              serviceName: 'AwarenessService',
              substeps: [{ serviceName: 'AwarenessService' }]
            },
            { 
              stepName: 'Consideration', 
              description: 'Customer considers options',
              serviceName: 'ConsiderationService',
              substeps: [{ serviceName: 'ConsiderationService' }]
            },
            { 
              stepName: 'Purchase', 
              description: 'Customer makes purchase',
              serviceName: 'PurchaseService',
              substeps: [{ serviceName: 'PurchaseService' }]
            },
            { 
              stepName: 'Retention', 
              description: 'Customer retention activities',
              serviceName: 'RetentionService',
              substeps: [{ serviceName: 'RetentionService' }]
            },
            { 
              stepName: 'Advocacy', 
              description: 'Customer becomes advocate',
              serviceName: 'AdvocacyService',
              substeps: [{ serviceName: 'AdvocacyService' }]
            }
          ],
          requirements: journeyRequirements
        };
        
        lastJourney = basicJourney;
        currentJourneyData = { journey: basicJourney };
        journeyOutput.textContent = JSON.stringify({ journey: basicJourney }, null, 2);
        setupFlowButtons();
        alert('Basic journey structure created! You can now simulate this journey or use the Copilot workflow above for AI-generated journeys.');
        return;
      }

      // Template mode logic - Generate ShopMart retail example locally
      const companyName = document.getElementById('companyName').value || 'ShopMart';
      const domain = document.getElementById('domain').value || 'shopmart.com';
      const industryType = document.getElementById('industryType').value || 'retail';
      const customStepsInput = document.getElementById('customSteps').value.trim();
      
      // Use custom steps if provided, otherwise use default retail steps
      const steps = customStepsInput ? 
        customStepsInput.split(',').map(step => step.trim()).filter(step => step) :
        ['Product Discovery', 'Product Selection', 'Add to Cart', 'Checkout Process', 'Payment Processing', 'Order Confirmation'];
      
      const retailJourney = {
        companyName,
        domain,
        industryType,
        journeyId: `journey_${Date.now()}`,
        steps: steps.map((stepName, index) => ({
          stepName,
          serviceName: stepName.replace(/\s+/g, '') + 'Service',
          description: `Customer ${stepName.toLowerCase()} step`,
          order: index + 1,
          endpoints: [`/${stepName.toLowerCase().replace(/\s+/g, '-')}`],
          substeps: [{ serviceName: stepName.replace(/\s+/g, '') + 'Service' }],
          metadata: {
            stepType: 'retail',
            processingTime: Math.floor(Math.random() * 200) + 100,
            businessValue: Math.floor(Math.random() * 500) + 100
          }
        })),
        provider: 'Quick Template (Retail Example)',
        generated: new Date().toISOString()
      };
      
      lastJourney = retailJourney;
      currentJourneyData = { journey: retailJourney };
      
      journeyOutput.textContent = JSON.stringify({ journey: retailJourney }, null, 2);
      journeySources.innerHTML = '<div>Source: Built-in retail template</div>';
      journeyProvider.textContent = 'Provider: Quick Template (Retail Example)';
      
      setupFlowButtons();
      
      // Auto-save when journey is generated
      promptCache.autoSaveCurrentState('journey generated');
      
      alert(`${companyName} retail journey created! Ready for simulation with ${steps.length} steps.`);
    });

    // Simulate Events (batch 6-step chained)
    simulateForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentJourneyData || !currentJourneyData.journey) {
        alert('Please generate or load a journey first');
        return;
      }
      const customers = Number(new FormData(simulateForm).get('duration')) || 10;
      const thinkTimeMs = 100;
      simStatus.textContent = `Starting ${customers} customer(s) 6-step chained flow...`;
      // Build comprehensive journey payload with all available fields
      const journey = currentJourneyData.journey;
      const journeyPayload = {
        companyName: journey.companyName || 'DefaultCompany',
        domain: journey.domain || 'default.com',
        industryType: journey.industryType || 'general',
        steps: journey.steps || [],
        
        // Include journey metadata
        journeyId: journey.journeyId || journey.id || `journey_${Date.now()}`,
        journeyType: journey.journeyType || 'customer_journey',
        description: journey.description || `${journey.companyName || 'Customer'} journey`,
        
        // Include all additional fields from the AI processing (check both locations)
        additionalFields: journey.additionalFields || currentJourneyData.additionalFields || {},
        
        // Include customer and context data (check both locations)
        customerProfile: journey.customerProfile || currentJourneyData.customerProfile || {},
        traceMetadata: journey.traceMetadata || currentJourneyData.traceMetadata || {},
        
        // Include business context from form inputs
        formContext: {
          customSteps: document.getElementById('customSteps')?.value || '',
          journeyType: document.getElementById('journeyType')?.value || '',
          details: document.getElementById('details')?.value || '',
          generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
        },
        
        // Include dynamic additional fields defined by user
        userDefinedFields: typeof additionalFields !== 'undefined' ? 
          additionalFields.reduce((acc, field) => {
            acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                             field.type === 'boolean' ? Math.random() > 0.5 :
                             field.type === 'array' ? ['sample', 'data'] :
                             `sample_${field.name}_value`;
            return acc;
          }, {}) : {},
          
        // Include comprehensive business event metadata
        businessMetadata: {
          timestamp: new Date().toISOString(),
          sessionId: `session_${Date.now()}`,
          deviceType: 'desktop',
          userAgent: navigator.userAgent || 'Unknown',
          campaignSource: 'simulation',
          customerSegment: journey.customerSegment || 'standard',
          behaviorScore: journey.behaviorScore || Math.floor(Math.random() * 10) + 1,
          abandonmentRisk: journey.abandonmentRisk || 'low',
          experimentId: `exp_${Date.now()}`,
          testVariant: 'simulation',
          featureFlags: journey.featureFlags || ['simulation_mode'],
          abTestGroup: 'simulation'
        }
      };
      const res = await fetch('/api/journey-simulation/simulate-batch-chained', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customers, thinkTimeMs, journey: journeyPayload })
      });
      const json = await res.json();
      if (json.ok) {
        simStatus.textContent = `âœ… Batch complete: ${json.summary.completed}/${json.summary.customers} succeeded, ${json.summary.failed} failed`;
        flowResultsEl.textContent = `Sample (first 5):\n${JSON.stringify(json.sample, null, 2)}`;
      } else {
        simStatus.textContent = `âŒ Batch failed: ${json.error || 'Unknown error'}`;
        flowResultsEl.textContent = '';
      }
    });

    // Add a details area for flow results
    let flowResultsEl = document.getElementById('flow-results');
    if (!flowResultsEl) {
      flowResultsEl = document.createElement('pre');
      flowResultsEl.id = 'flow-results';
      flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
      simStatus.parentElement.appendChild(flowResultsEl);
    }

    async function refreshMetrics() {
      const res = await fetch('/api/metrics');
      const json = await res.json();
      metricsEl.textContent = JSON.stringify(json, null, 2);
    }
    setInterval(refreshMetrics, 2000);
    refreshMetrics();

    // Use Retail Example functionality
    document.getElementById('useRetailExample').addEventListener('click', () => {
      const retailJourney = {
        "journey": {
          "companyName": "ShopMart",
          "domain": "shopmart.com", 
          "industryType": "retail",
          "journeyId": "journey_retail_example",
          "steps": [
            {
              "stepIndex": 1,
              "stepName": "Product Discovery",
              "description": "Customer exploring product catalog",
              "duration": "3-8 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Browse_Catalog",
                  "description": "Customer browsing main catalog",
                  "serviceName": "ProductDiscoveryService",
                  "endpoint": "/api/product-discovery",
                  "duration": 1200,
                  "eventType": "browse_initiated",
                  "metadata": {"searchTerm": "winter jackets", "category": "clothing", "device": "mobile"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Filter_Results", 
                  "description": "Customer applying search filters",
                  "serviceName": "ProductDiscoveryService",
                  "endpoint": "/api/filter",
                  "duration": 800,
                  "eventType": "filter_applied",
                  "metadata": {"filters": ["size:M", "color:black"], "resultsCount": 24}
                }
              ]
            },
            {
              "stepIndex": 2,
              "stepName": "Product Selection",
              "description": "Customer evaluating specific items", 
              "duration": "2-5 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "View_Details",
                  "description": "Customer viewing product details",
                  "serviceName": "ProductSelectionService",
                  "endpoint": "/api/product-selection",
                  "duration": 900,
                  "eventType": "product_viewed",
                  "metadata": {"productId": "jacket_123", "price": 89.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Check_Reviews",
                  "description": "Customer reading reviews and ratings",
                  "serviceName": "ProductSelectionService", 
                  "endpoint": "/api/reviews",
                  "duration": 600,
                  "eventType": "reviews_viewed",
                  "metadata": {"rating": 4.5, "reviewCount": 127}
                }
              ]
            },
            {
              "stepIndex": 3,
              "stepName": "Cart Addition",
              "description": "Customer adding items to cart",
              "duration": "1-3 minutes", 
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Add_To_Cart",
                  "description": "Customer adding product to shopping cart",
                  "serviceName": "CartAdditionService",
                  "endpoint": "/api/cart-addition", 
                  "duration": 500,
                  "eventType": "cart_add",
                  "metadata": {"quantity": 1, "cartValue": 89.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "View_Cart",
                  "description": "Customer reviewing cart contents",
                  "serviceName": "CartAdditionService",
                  "endpoint": "/api/cart",
                  "duration": 400,
                  "eventType": "cart_viewed", 
                  "metadata": {"itemCount": 1, "totalValue": 89.99}
                }
              ]
            },
            {
              "stepIndex": 4,
              "stepName": "Checkout Process",
              "description": "Customer proceeding through checkout",
              "duration": "3-7 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Enter_Details",
                  "description": "Customer entering shipping and payment info",
                  "serviceName": "CheckoutProcessService",
                  "endpoint": "/api/checkout-process",
                  "duration": 1800,
                  "eventType": "checkout_started",
                  "metadata": {"paymentMethod": "credit_card", "shippingMethod": "standard"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Apply_Promotion",
                  "description": "Customer applying discount code",
                  "serviceName": "CheckoutProcessService",
                  "endpoint": "/api/promotions",
                  "duration": 300,
                  "eventType": "promotion_applied",
                  "metadata": {"promoCode": "SAVE10", "discount": 9.00}
                }
              ]
            },
            {
              "stepIndex": 5,
              "stepName": "Order Confirmation",
              "description": "Customer completing purchase",
              "duration": "1-2 minutes",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Process_Payment",
                  "description": "Payment processing and order completion",
                  "serviceName": "OrderConfirmationService",
                  "endpoint": "/api/order-confirmation",
                  "duration": 1000,
                  "eventType": "order_completed",
                  "metadata": {"orderId": "ORD_789", "finalAmount": 80.99}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Send_Confirmation",
                  "description": "Sending order confirmation email",
                  "serviceName": "OrderConfirmationService",
                  "endpoint": "/api/confirmation-email",
                  "duration": 200,
                  "eventType": "confirmation_sent",
                  "metadata": {"email": "customer@example.com", "estimatedDelivery": "3-5 days"}
                }
              ]
            },
            {
              "stepIndex": 6,
              "stepName": "Post Purchase",
              "description": "Customer post-purchase activities",
              "duration": "varies",
              "substeps": [
                {
                  "substepIndex": 1,
                  "substepName": "Track_Order",
                  "description": "Customer tracking order status",
                  "serviceName": "PostPurchaseService",
                  "endpoint": "/api/post-purchase",
                  "duration": 400,
                  "eventType": "order_tracked",
                  "metadata": {"trackingNumber": "TRK123456", "status": "shipped"}
                },
                {
                  "substepIndex": 2,
                  "substepName": "Leave_Review",
                  "description": "Customer leaving product review",
                  "serviceName": "PostPurchaseService",
                  "endpoint": "/api/reviews/create",
                  "duration": 600,
                  "eventType": "review_submitted",
                  "metadata": {"rating": 5, "reviewText": "Great quality jacket!"}
                }
              ]
            }
          ]
        },
        "customerProfile": {
          "userId": "user_retail_demo",
          "email": "customer@example.com",
          "demographic": "consumers aged 18-65",
          "painPoints": ["high prices", "limited selection"],
          "goals": ["quality products", "good prices"]
        },
        "traceMetadata": {
          "correlationId": "trace_retail_example",
          "sessionId": "session_retail_demo",
          "businessContext": {"campaignSource": "organic", "customerSegment": "consumer", "businessValue": 500}
        },
        "additionalFields": {
          "deviceType": "mobile", "browser": "Chrome", "entryChannel": "organic",
          "customerIntent": "purchase", "loyaltyStatus": "new", "abandonmentRisk": "medium",
          "conversionProbability": 0.85, "personalizationTags": ["shopping", "products"]
        }
      };
      
      lastJourney = retailJourney.journey;
      currentJourneyData = retailJourney;
      
      journeyOutput.textContent = JSON.stringify(retailJourney, null, 2);
      journeyProvider.textContent = 'Provider: Retail Template Example';
      journeySources.innerHTML = '<div>Source: Built-in retail journey template</div>';
      
      setupFlowButtons();
      alert('Retail journey example loaded! You can now use this for simulation or modify the form to create your own.');
    });

    // Setup button handlers function - ensures buttons work properly
    function setupFlowButtons() {
      console.log('Setting up flow buttons (safe mode)...');

      // Query DOM elements locally to avoid referencing undefined globals
      const runChainedBtnLocal = document.getElementById('run-chained-flow');
      const runJourneySimBtnLocal = document.getElementById('run-journey-simulation');
      const chainStatusLocal = document.getElementById('chain-status');

      if (!runChainedBtnLocal || !runJourneySimBtnLocal) {
        console.error('Button elements not found during setupFlowButtons');
        return;
      }

      // Enable buttons
      runChainedBtnLocal.disabled = false;
      runJourneySimBtnLocal.disabled = false;

      // Update button text to show they're ready
      runChainedBtnLocal.innerHTML = 'ğŸ”— Run Distributed Flow (Ready)';
      runJourneySimBtnLocal.innerHTML = 'ğŸš€ Run Journey Simulation (Ready)';

      console.log('Flow buttons are now enabled and ready! (safe mode)');

      // Show status
      if (chainStatusLocal) {
        chainStatusLocal.textContent = 'âœ… Buttons enabled! Journey loaded and ready for simulation.';
      }
    }

    // Initialize the page with Copilot method selected by default
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM Content Loaded - Starting button setup...');
      
      // Copy button functionality removed per user request
      
      // Get all required elements and verify they exist
      const runChainedBtn = document.getElementById('run-chained-flow');
      const resetPortsBtn = document.getElementById('reset-ports');
      const chainStatus = document.getElementById('chain-status');
      const chainedTraceOutput = document.getElementById('chained-trace-output');
      const runJourneySimBtn = document.getElementById('run-journey-simulation');
      const simStatus = document.getElementById('sim-status');
      
      console.log('Button elements found:');
      console.log('- runChainedBtn:', !!runChainedBtn, runChainedBtn);
      console.log('- runJourneySimBtn:', !!runJourneySimBtn, runJourneySimBtn);
      console.log('- chainStatus:', !!chainStatus);
      console.log('- simStatus:', !!simStatus);
      
      if (!runChainedBtn) {
        console.error('âŒ Blue button (run-chained-flow) not found!');
        return;
      }
      
      if (!runJourneySimBtn) {
        console.error('âŒ Green button (run-journey-simulation) not found!');
        return;
      }
      
      // Add a details area for flow results
      let flowResultsEl = document.getElementById('flow-results');
      if (!flowResultsEl) {
        flowResultsEl = document.createElement('pre');
        flowResultsEl.id = 'flow-results';
        flowResultsEl.className = 'mt-2 text-xs bg-black p-3 rounded max-h-64 overflow-auto';
        if (simStatus && simStatus.parentElement) {
          simStatus.parentElement.appendChild(flowResultsEl);
        }
      }
      const generationMethod = document.getElementById('generationMethod');
      const copilotWorkflow = document.getElementById('copilotWorkflow');
      const templateExample = document.getElementById('templateExample');
      const customStepsContainer = document.getElementById('customStepsContainer');
      const optionalFieldsContainer = document.getElementById('optionalFieldsContainer');
      const journeyRequirementsContainer = document.getElementById('journeyRequirementsContainer');

      // Always set Copilot as default and show Copilot workflow
      generationMethod.value = 'copilot';
      copilotWorkflow.classList.remove('hidden');
      if (templateExample) templateExample.classList.add('hidden');
      customStepsContainer.style.display = 'none';
      optionalFieldsContainer.style.display = 'none';
      journeyRequirementsContainer.style.display = 'block';

      // Clear form fields for Copilot mode
      document.getElementById('companyName').value = '';
      document.getElementById('domain').value = '';
      document.getElementById('industryType').value = '';
      document.getElementById('journeyRequirements').value = '';

      // Always generate the Copilot prompt and show it
      generateCopilotPrompt();
      
      // Ensure it's populated even if there was an initial delay
      setTimeout(generateCopilotPrompt, 100);

      // Also regenerate prompt when switching to Copilot mode
      generationMethod.addEventListener('change', (e) => {
        if (e.target.value === 'copilot') {
          generateCopilotPrompt();
          copilotWorkflow.classList.remove('hidden');
          customStepsContainer.style.display = 'none';
          optionalFieldsContainer.style.display = 'none';
          journeyRequirementsContainer.style.display = 'block';
        } else if (e.target.value === 'template') {
          // Quick Template mode - populate with ShopMart retail example
          copilotWorkflow.classList.add('hidden');
          customStepsContainer.style.display = 'block';
          optionalFieldsContainer.style.display = 'block';
          journeyRequirementsContainer.style.display = 'none';
          
          // Populate form with ShopMart retail example
          document.getElementById('companyName').value = 'ShopMart';
          document.getElementById('domain').value = 'shopmart.com';
          document.getElementById('industryType').value = 'retail';
          document.getElementById('customSteps').value = 'Product Discovery, Product Selection, Add to Cart, Checkout Process, Payment Processing, Order Confirmation';
          document.getElementById('journeyType').value = 'E-commerce Purchase Journey';
          document.getElementById('details').value = 'Complete retail customer journey from product discovery to order confirmation';
          
          // Clear additional fields for template mode
          additionalFields.length = 0;
          renderAdditionalFields();
          
          // Auto-generate the retail journey
          setTimeout(() => {
            document.getElementById('generateJourney').click();
          }, 500);
        }
      });

      // Force initial prompt generation after a short delay to ensure helper functions are loaded
      setTimeout(() => {
        generateCopilotPrompt();
      }, 100);

      // Set initial status messages to show buttons are ready
      setTimeout(() => {
        console.log('Setting initial button status...');
        console.log('runChainedBtn found:', !!runChainedBtn);
        console.log('runJourneySimBtn found:', !!runJourneySimBtn);
        console.log('chainStatus found:', !!chainStatus);
        console.log('simStatus found:', !!simStatus);
        
        if (chainStatus) {
          chainStatus.textContent = 'ğŸ¯ Ready to test! Blue button will work even without a generated journey.';
        }
        if (simStatus) {
          simStatus.textContent = 'ğŸ¯ Ready to simulate! Green button will work even without a generated journey.';
        }
        
        // Add simple test handlers to verify buttons work
        if (runChainedBtn) {
          console.log('Blue button found and handler will be attached');
        } else {
          console.error('Blue button (run-chained-flow) not found!');
        }
        
        if (runJourneySimBtn) {
          console.log('Green button found and handler will be attached');
        } else {
          console.error('Green button (run-journey-simulation) not found!');
        }
      }, 500);

      // Setup button event handlers
      // Enhanced chained flow with automatic seeding and better error handling
      runChainedBtn.onclick = async () => {
        console.log('ğŸ”¥ BLUE BUTTON CLICKED! ğŸ”¥');
        alert('Blue button clicked! Distributed Flow starting...');
        try {
          chainStatus.textContent = 'ğŸš€ Starting distributed flow... Seeding journey and starting services...';
          chainedTraceOutput.textContent = '';
          runChainedBtn.disabled = true;
          runChainedBtn.textContent = 'ğŸ”„ Running...';

          // First, ensure we have a journey to work with
          if (!lastJourney || !lastJourney.steps || !lastJourney.steps.length) {
            chainStatus.textContent = 'âš ï¸ No journey data available. Creating test journey...';
            
            // Create a simple test journey
            lastJourney = {
              companyName: 'TestCorp',
              domain: 'testcorp.com',
              industryType: 'retail',
              steps: [
                { stepName: 'Discovery', description: 'Customer discovery' },
                { stepName: 'Selection', description: 'Product selection' },
                { stepName: 'Purchase', description: 'Purchase process' }
              ]
            };
            
            chainStatus.textContent = 'âœ… Test journey created! Running distributed flow...';
          }

          // Build steps from the journey
          let stepNames = lastJourney.steps.slice(0, 6).map(s => s.stepName || s.name || String(s));
          
          // Normalize to exactly 6
          while (stepNames.length < 6) stepNames.push(`Step${stepNames.length + 1}`);
          stepNames = stepNames.slice(0, 6);

          // Build comprehensive body with all available journey data
          const body = { 
            steps: stepNames.map(n => ({ stepName: n })),
            thinkTimeMs: 200, // Increased think time for better service startup
            companyName: lastJourney?.companyName || 'DefaultCompany',
            domain: lastJourney?.domain || 'default.com',
            industryType: lastJourney?.industryType || 'general',
            
            // Include additional context data for comprehensive tracing
            additionalFields: lastJourney?.additionalFields || {},
            customerProfile: lastJourney?.customerProfile || {},
            traceMetadata: lastJourney?.traceMetadata || {},
            
            // Include business context from form inputs
            formContext: {
              customSteps: document.getElementById('customSteps')?.value || '',
              journeyType: document.getElementById('journeyType')?.value || '',
              details: document.getElementById('details')?.value || '',
              generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
            },
            
            // Include dynamic additional fields defined by user
            userDefinedFields: typeof additionalFields !== 'undefined' ? 
              additionalFields.reduce((acc, field) => {
                acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                 field.type === 'boolean' ? Math.random() > 0.5 :
                                 field.type === 'array' ? ['sample', 'data'] :
                                 `sample_${field.name}_value`;
                return acc;
              }, {}) : {},
              
            // Include simulation metadata
            simulationMetadata: {
              timestamp: new Date().toISOString(),
              simulationType: 'distributed-chained',
              sessionId: `session_${Date.now()}`,
              correlationId: `dist_chain_${Date.now()}`
            }
          };
          
          chainStatus.textContent = 'ğŸ”— Running distributed flow with OneAgent tracing...';
          
          const res = await fetch('/api/steps/step1-chained', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
          });
          const json = await res.json();

          if (!json.ok) {
            chainStatus.textContent = `âŒ Chained flow failed: ${json.error || 'Unknown error'}`;
            chainedTraceOutput.textContent = `Error Details:\n${JSON.stringify(json, null, 2)}`;
            return;
          }

          const trace = json.result?.trace || [];
          const stepsStr = trace.map(t => t.stepName).join(' â†’ ');
          const totalDuration = trace.reduce((sum, t) => sum + (t.duration || 0), 0);
          chainStatus.textContent = `âœ… Distributed flow completed! ${trace.length} spans traced (${totalDuration}ms total) â€¢ ${stepsStr}`;
          chainedTraceOutput.textContent = JSON.stringify(trace, null, 2);
        } catch (e) {
          chainStatus.textContent = `âŒ Error: ${e.message}`;
          chainedTraceOutput.textContent = `Error Details:\n${e.stack}`;
        } finally {
          runChainedBtn.disabled = false;
          runChainedBtn.textContent = 'ğŸ”— Run Distributed Flow';
        }
      };

      // Reset dynamic services to free ports
      resetPortsBtn.onclick = async () => {
        try {
          chainStatus.textContent = 'Resetting dynamic services...';
          const res = await fetch('/api/admin/reset-ports', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{}' });
          const json = await res.json();
          chainStatus.textContent = json.ok ? 'âœ… Dynamic services reset.' : `âŒ Reset failed: ${json.error || 'Unknown error'}`;
        } catch (e) {
          chainStatus.textContent = `âŒ Reset error: ${e.message}`;
        }
      };

      // Journey Simulation button handler
      runJourneySimBtn.onclick = async () => {
        console.log('ğŸ”¥ GREEN BUTTON CLICKED! ğŸ”¥');
        alert('Green button clicked! Journey Simulation starting...');
        try {
          console.log('Journey Simulation button clicked!');
          if (runJourneySimBtn) {
            runJourneySimBtn.disabled = true;
            runJourneySimBtn.textContent = 'ğŸ”„ Simulating Journey...';
          }
          if (simStatus) {
            simStatus.textContent = 'Starting customer journey simulation...';
          }
          
          if (!lastJourney) {
            if (simStatus) {
              simStatus.textContent = 'âš ï¸ No journey data available. Creating test journey for simulation...';
            }
            
            // Create a simple test journey
            lastJourney = {
              companyName: 'SimTestCorp',
              domain: 'simtestcorp.com',
              industryType: 'retail',
              steps: [
                { stepName: 'Discovery', description: 'Customer discovery phase' },
                { stepName: 'Evaluation', description: 'Product evaluation' },
                { stepName: 'Decision', description: 'Purchase decision' },
                { stepName: 'Transaction', description: 'Complete transaction' }
              ]
            };
            
            if (simStatus) {
              simStatus.textContent = 'âœ… Test journey created! Starting simulation...';
            }
          }
          
          const customerId = `customer_${Date.now()}`;
          const journeyId = `journey_${Date.now()}`;
          
          // Build comprehensive journey data with all available fields (consistent with main function)
          const journeyData = {
            steps: lastJourney.steps || [],
            journeyId: lastJourney.id || journeyId,
            companyName: lastJourney.companyName || 'DefaultCompany',
            domain: lastJourney.domain || 'default.com',
            industryType: lastJourney.industryType || 'general',
            journeyType: lastJourney.journeyType || 'customer_journey',
            description: lastJourney.description || `${lastJourney.companyName || 'Customer'} journey`,
            
            // Include all additional fields from the AI processing
            additionalFields: lastJourney.additionalFields || {
              sessionId: `session_${Date.now()}`,
              deviceType: 'desktop',
              userAgent: navigator.userAgent || 'Chrome/118.0.0.0',
              campaignSource: 'organic_search',
              customerSegment: 'premium',
              behaviorScore: 8.5,
              abandonmentRisk: 'low',
              timestamp: new Date().toISOString(),
              simulationMode: true
            },
            
            customerProfile: lastJourney.customerProfile || {
              customerId: customerId,
              age: 32,
              gender: 'F',
              loyaltyTier: 'gold',
              previousPurchases: 15,
              avgOrderValue: 125.50,
              preferredChannel: 'mobile',
              registrationDate: new Date(Date.now() - 365*24*60*60*1000).toISOString(),
              lastLoginDate: new Date().toISOString()
            },
            
            traceMetadata: lastJourney.traceMetadata || {
              experimentId: 'exp_2025_q4',
              testVariant: 'control',
              featureFlags: ['checkout_v2', 'ai_recommendations'],
              abTestGroup: 'A',
              correlationId: journeyId,
              parentSpanId: null,
              traceId: `trace_${Date.now()}`
            },
            
            // Include business context from form inputs
            formContext: {
              customSteps: document.getElementById('customSteps')?.value || '',
              journeyType: document.getElementById('journeyType')?.value || '',
              details: document.getElementById('details')?.value || '',
              generationMethod: document.getElementById('generationMethod')?.value || 'copilot'
            },
            
            // Include dynamic additional fields defined by user
            userDefinedFields: typeof additionalFields !== 'undefined' ? 
              additionalFields.reduce((acc, field) => {
                acc[field.name] = field.type === 'number' ? Math.floor(Math.random() * 100) : 
                                 field.type === 'boolean' ? Math.random() > 0.5 :
                                 field.type === 'array' ? ['sample', 'data'] :
                                 `sample_${field.name}_value`;
                return acc;
              }, {}) : {},
              
            // Include comprehensive business event metadata
            businessMetadata: {
              timestamp: new Date().toISOString(),
              sessionId: `session_${Date.now()}`,
              deviceType: 'desktop',
              userAgent: navigator.userAgent || 'Unknown',
              campaignSource: 'simulation',
              customerSegment: lastJourney.customerSegment || 'standard',
              behaviorScore: lastJourney.behaviorScore || Math.floor(Math.random() * 10) + 1,
              abandonmentRisk: lastJourney.abandonmentRisk || 'low',
              experimentId: `exp_${Date.now()}`,
              testVariant: 'simulation',
              featureFlags: lastJourney.featureFlags || ['simulation_mode'],
              abTestGroup: 'simulation',
              region: 'us-east-1',
              environment: 'simulation'
            }
          };
          
          simStatus.textContent = 'ğŸš€ Running customer journey simulation...';
          
          // Get customer count from UI
          const customerCount = parseInt(document.getElementById('customerCount').value) || 1;
          console.log(`Running simulation for ${customerCount} customers`);
          
          // Use appropriate endpoint based on customer count
          const endpoint = customerCount > 1 ? '/api/journey-simulation/simulate-multiple-journeys' : '/api/journey-simulation/simulate-journey';
          
          // Build comprehensive request body with all available data (consistent with main function)
          const requestBody = {
            journeyId,
            customerId,
            journey: journeyData,  // Complete journey object with all fields
            companyName: journeyData.companyName,
            domain: journeyData.domain,
            industryType: journeyData.industryType,
            journeyType: journeyData.journeyType,
            description: journeyData.description,
            
            // Include all context data in request body for tracing
            additionalFields: journeyData.additionalFields || {},
            customerProfile: journeyData.customerProfile || {},
            traceMetadata: journeyData.traceMetadata || {},
            formContext: journeyData.formContext || {},
            userDefinedFields: journeyData.userDefinedFields || {},
            businessMetadata: journeyData.businessMetadata || {},
            
            // Simulation parameters
            chained: false, // Use step-by-step execution for consistency
            simulationId: `sim_${Date.now()}`,
            batchId: `batch_${Date.now()}`,
            customerCount: 1
          };
          
          // Add customers parameter for multiple journey endpoint
          if (customerCount > 1) {
            requestBody.customers = customerCount;
          }
          
          const res = await fetch(endpoint, { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify(requestBody) 
          });
          
          const json = await res.json();
          
          if (json.success) {
            // Handle multiple customers response
            if (json.loadTestSummary && customerCount > 1) {
              const summary = json.loadTestSummary;
              
              // Analyze errors to provide better status message
              const errors = json.errors || [];
              const incompleteCount = errors.filter(err => err.includes('incomplete')).length;
              const failureCount = errors.filter(err => !err.includes('incomplete')).length;
              
              let statusIcon = 'âœ…';
              let statusText = '';
              
              if (summary.successfulCustomers === summary.customersProcessed) {
                statusText = `All ${summary.customersProcessed} customers completed successfully!`;
              } else if (summary.successfulCustomers > 0) {
                statusIcon = 'âš ï¸';
                if (incompleteCount > 0) {
                  statusText = `${summary.successfulCustomers} completed, ${incompleteCount} partially completed, ${failureCount} failed`;
                } else {
                  statusText = `${summary.successfulCustomers} completed successfully, ${summary.failedCustomers} encountered issues`;
                }
              } else {
                statusIcon = 'âŒ';
                if (incompleteCount === summary.customersProcessed) {
                  statusText = `All ${summary.customersProcessed} customers partially completed journeys`;
                } else {
                  statusText = `${summary.customersProcessed} customers encountered issues (${incompleteCount} partial, ${failureCount} failed)`;
                }
              }
              
              simStatus.textContent = `${statusIcon} ${customerCount} Customer Journey Simulation Complete! ${statusText}`;
              
              const summaryText = [
                `Load Test Results:`,
                `â€¢ Customers Processed: ${summary.customersProcessed}`,
                `â€¢ Successful: ${summary.successfulCustomers}`,
                `â€¢ Failed: ${summary.failedCustomers}`, 
                `â€¢ Success Rate: ${summary.successRate}`,
                `â€¢ Average Completion Time: ${summary.averageCompletionTime}`,
                `â€¢ Average Steps Completed: ${summary.averageStepsCompleted}`,
                ``,
                `Correlation IDs: ${json.correlationIds ? json.correlationIds.slice(0, 3).join(', ') : 'N/A'}${json.correlationIds && json.correlationIds.length > 3 ? '...' : ''}`
              ];
              
              if (json.journeyExample) {
                summaryText.push(``, `Example Journey Execution:`, json.journeyExample.execution);
                summaryText.push(``, `Services Used: ${json.journeyExample.servicesUsed}`);
              }
              
              flowResultsEl.textContent = summaryText.join('\n');
              
            } else {
              // Handle single customer response
              const journey = json.journey;
              if (simStatus) {
                simStatus.textContent = `âœ… Customer Journey complete! ${journey.completedSteps}/${journey.totalSteps} steps successful. Correlation: ${journey.correlationId}`;
              }
              
              // Show detailed results with service names (same as 6-step flow)
              const stepSummary = journey.steps.map((step, idx) => {
                const status = step.status === 'completed' ? 'âœ…' : 'âŒ';
                const serviceName = step.serviceName || (step.stepName + 'Service');
                return `${status} Step ${idx + 1}: ${serviceName} (${step.processingTime || 0}ms)`;
              }).join('\n');
              
              if (flowResultsEl) {
                flowResultsEl.textContent = `Customer Journey Execution:\n${stepSummary}\n\nServices Used: ${journey.stepNames ? journey.stepNames.join(' â†’ ') : 'N/A'}\n\nCorrelation ID: ${journey.correlationId}`;
              }
            }
            
          } else {
            if (simStatus) {
              simStatus.textContent = `âŒ Journey simulation failed: ${json.error}`;
            }
            if (flowResultsEl) {
              flowResultsEl.textContent = `Journey Error Details:\n${JSON.stringify(json, null, 2)}`;
            }
          }
          
        } catch (error) {
          console.error('Journey Simulation error:', error);
          if (simStatus) {
            simStatus.textContent = `âŒ Journey simulation error: ${error.message}`;
          }
          if (flowResultsEl) {
            flowResultsEl.textContent = `Error Details:\n${error.stack}`;
          }
        } finally {
          if (runJourneySimBtn) {
            runJourneySimBtn.disabled = false;
            runJourneySimBtn.textContent = 'ğŸš€ Run Journey Simulation';
          }
        }
      };
      
      // Event listeners moved back outside DOMContentLoaded to restore original logic
    });

    // Fetch domain label from response header
    (async () => {
      try {
        const res = await fetch('/api/health');
        const label = res.headers.get('X-App-Domain-Label');
        if (label) document.getElementById('host-label').textContent = `Domain: ${label}`;
      } catch {}
    })();

    // Initialize service status display and set up periodic updates
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸš€ DOM loaded - Initializing auto-refresh for service status...');
      
      // Wait a moment for everything to be ready
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Check if updateServiceStatus function exists
      if (typeof window.updateServiceStatus !== 'function') {
        console.error('âŒ updateServiceStatus function not found!');
        return;
      }
      
      // Initial load
      console.log('ğŸ“¡ Running initial service status update...');
      try {
        await window.updateServiceStatus();
      } catch (error) {
        console.error('âŒ Initial service status update failed:', error);
      }
      
      // Update every 10 seconds for real-time visibility
      console.log('â° Setting up 10-second auto-refresh interval');
      setInterval(() => {
        console.log('ğŸ”„ Auto-refresh triggered');
        try {
          window.updateServiceStatus();
        } catch (error) {
          console.error('âŒ Auto-refresh failed:', error);
        }
      }, 10000);
      
      console.log('âœ… Auto-refresh initialization complete');
    });

    // Add customer count validation
    document.getElementById('customerCount').addEventListener('input', (e) => {
      const value = parseInt(e.target.value);
      const simStatus = document.getElementById('sim-status');
      
      if (value > 1) {
        e.target.style.borderColor = '#ef4444'; // Red border
        if (simStatus) {
          simStatus.textContent = 'âš ï¸ Warning: Maximum 1 customer allowed';
          simStatus.style.color = '#ef4444';
        }
      } else {
        e.target.style.borderColor = '#00D4FF'; // Reset to cyan
        if (simStatus) {
          simStatus.textContent = '';
          simStatus.style.color = '#FFD23F';
        }
      }
    });

    // Prevent values above 1 on change
    document.getElementById('customerCount').addEventListener('change', (e) => {
      const value = parseInt(e.target.value);
      if (value > 1) {
        e.target.value = 1;
        alert('Customer limit is 1. Value has been adjusted to maximum allowed.');
      } else if (value < 1) {
        e.target.value = 1;
      }
    });

    // BACKUP: Ensure processResponse button works - attach at the very end
    console.log('ğŸ”§ Setting up backup processResponse event listener');
    setTimeout(() => {
      const processBtn = document.getElementById('processResponse');
      if (processBtn) {
        console.log('âœ… Backup: Process button found');
        // Remove any existing listeners and add a fresh one
        processBtn.replaceWith(processBtn.cloneNode(true));
        const newProcessBtn = document.getElementById('processResponse');
        newProcessBtn.addEventListener('click', function() {
          console.log('ğŸš€ BACKUP: Step 4 - Process button clicked');
          const responseText = document.getElementById('copilotResponse').value.trim();
          console.log('Response text length:', responseText.length);
          
          if (!responseText) {
            alert('Please paste your Copilot response first');
            return;
          }

          try {
            const parsedResponse = JSON.parse(responseText);
            if (parsedResponse.journey && parsedResponse.journey.steps) {
              // Set the global variables for journey simulation with complete data
              window.lastJourney = {
                ...parsedResponse.journey,
                additionalFields: parsedResponse.additionalFields || parsedResponse.journey.additionalFields || {},
                customerProfile: parsedResponse.customerProfile || parsedResponse.journey.customerProfile || {},
                traceMetadata: parsedResponse.traceMetadata || parsedResponse.journey.traceMetadata || {}
              };
              window.currentJourneyData = parsedResponse;

              // Display journey with additional fields info
              const displayData = {
                journey: parsedResponse.journey,
                customerProfile: parsedResponse.customerProfile,
                traceMetadata: parsedResponse.traceMetadata,
                additionalFields: parsedResponse.additionalFields
              };

              // Get elements by ID to ensure they exist
              const journeyOutputEl = document.getElementById('journey-output');
              const journeyProviderEl = document.getElementById('journey-provider');
              const journeySourcesEl = document.getElementById('journey-sources');
              
              console.log('Setting journey output...');

              if (journeyOutputEl) {
                journeyOutputEl.textContent = JSON.stringify(displayData, null, 2);
                console.log('âœ… Journey output set, length:', journeyOutputEl.textContent.length);
              } else {
                console.error('âŒ journey-output element not found');
              }
              
              if (journeyProviderEl) {
                journeyProviderEl.textContent = 'Provider: Enhanced Copilot Copy-Paste (Web Search)';
              }
              
              if (journeySourcesEl) {
                journeySourcesEl.innerHTML = '<div>Source: AI-powered web research and real behavior data</div>';
              }

              const fieldsCount = parsedResponse.additionalFields ? Object.keys(parsedResponse.additionalFields).length : 0;
              alert('Journey processed successfully! Includes ' + fieldsCount + ' additional tracking fields.');
            } else {
              alert('Invalid response format. Please ensure your Copilot returned the correct JSON structure with journey.steps.');
            }
          } catch (error) {
            console.error('JSON Parse Error:', error);
            alert('Invalid JSON format. Error: ' + error.message);
          }
        });
        console.log('âœ… Backup process button listener attached');
      } else {
        console.error('âŒ Backup: Process button not found!');
      }
    }, 1000);

  </script>
</body>
</html>
